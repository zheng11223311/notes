<!doctype html>
<html lang="en">
 <head>
  <meta charset="UTF-8">
  <meta name="Generator" content="EditPlusR">
  <meta name="Author" content="">
  <meta name="Keywords" content="">
  <meta name="Description" content="">
  <title>星空</title>
  <style>
        body{margin:0;padding:0;overflow: hidden;}
        .city{width:100%;position:fixed;bottom: 0px;z-index: 100;}
        .city img{width: 100%;}
    </style>
 </head>
 <body>
    <canvas id='cas' style="background-color:rgba(0,5,24,1)">canvas</canvas>
    <div class="city"><img src="city.png" alt="" /></div>
    <img src="moon.png" alt="" id="moon" style="visibility: hidden;"/>
    <div style="display:none">
        <div class="shape">HAPPY</div>
        <div class="shape">HAPPY</div>
        <div class="shape">HAPPY</div>
        <div class="shape">HAPPY</div>
        <div class="shape">HAPPY</div>
    </div>
    <audio src="boom.mp3" preload="auto"></audio>
    <audio src="boom.mp3" preload="auto"></audio>
    <audio src="boom.mp3" preload="auto"></audio>
    <audio src="boom.mp3" preload="auto"></audio>
    <audio src="boom.mp3" preload="auto"></audio>
    <audio src="boom.mp3" preload="auto"></audio>
    <audio src="shotfire.mp3" preload="auto"></audio>
    <audio src="shotfire.mp3" preload="auto"></audio>
    <audio src="shotfire.mp3" preload="auto"></audio>
 </body>
 <script>
    var cas=document.getElementById('cas'),
        ctx=cas.getContext('2d'),
        ocas=document.createElement('canvas'),
        octx=ocas.getContext('2d'),
        cw=document.compatMode=='BackCompat'?document.body.clientWidth:document.documentElement.clientWidth,
        ch=document.compatMode=='BackCompat'?document.body.clientHeight:document.documentElement.clientHeight,
        last,
        now,
        stars=[],
        booms=[],
        moon=document.getElementById('moon'),
        shape=document.querySelectorAll('.shape'),
        audio=document.getElementsByTagName('audio');
    cas.width=ocas.width=cw;
    cas.height=ocas.height=ch;
    window.onload=function(){
        createStars();
        last=+new Date();
        animate();
    }

    function animate(){
        ctx.save();
        ctx.globalCompositeOperation='destination-out';
        ctx.globalAlpha=0.1;
        ctx.fillRect(0,0,cw,ch);
        ctx.restore();

        stars.forEach(function(){
            this.paint();
        });
        createMoon();

        now=+new Date();
        if(now-last>1000){
            var rand=getRand(0,100)>50?true:false,num=Math.floor(getRand(0,shape.length)),
                x=getRand(cw/3,cw*2/3),y=ch,r=2,color='#fff',tx=getRand(cw/5,cw*4/5),ty=getRand(50,ch-300);
            if(rand){
                booms.push(new Firework(x,y,r,color,tx,ty));
            }else{
                booms.push(new Firework(x,y,r,color,tx,ty,shape[num]));
            }
            for(var i=0;i<audio.length;i++){
                if(audio[i].src.indexOf('shotfire')>=0 && (audio[i].paused || audio[i].ended)){
                    audio[i].play();
                    break;
                }
            }
            last=now;
        }

        booms.forEach(function(){
            var that=this;
            if(!this.dead){
                this.update();
                this.smoke();
            }else{
                this.booms.forEach(function(index){
                    if(!this.dead){
                        this.update();
                    }else{
                        if(index==that.booms.length){
                            booms.splice(booms.indexOf(that),1);
                        }
                    }
                });
            }
        });
        requestAnimationFrame(animate);
    }

    function Particle(x,y,r,color,tx,ty){
        this.x=x;
        this.y=y;
        this.r=r;
        this.color=color;
        this.tx=tx;
        this.ty=ty;
        this.dead=false;
    }
    Particle.prototype={
        paint:function(){
            ctx.beginPath();
            ctx.fillStyle='rgba('+this.color.a+','+this.color.b+','+this.color.c+',1)';
            ctx.fillRect(this.x-this.r,this.y-this.r,2*this.r,2*this.r);
            ctx.closePath();
        },
        update:function(){
            this.ty+=0.3;
            var dx=this.tx-this.x,dy=this.ty-this.y;
            if(Math.abs(dx)<0.1 && Math.abs(dy)<20){
                this.dead=true;
            }else{
               this.x=Math.abs(dx)<0.1?this.tx:this.x+dx*0.1;
                this.y=Math.abs(dy)<0.1?this.ty:this.y+dy*0.1;
                this.paint();
            }
        }
    }

    function Firework(x,y,r,color,tx,ty,shape){
        this.x=x;
        this.y=y;
        this.r=r;
        this.color=color;
        this.tx=tx;
        this.ty=ty;
        this.shape=shape || false;
        this.dead=false;
        this.ba=getRand(30,50);
        this.booms=[];
    }
    Firework.prototype={
        paint:function(){
            ctx.save();
            ctx.beginPath();
            ctx.fillStyle=this.color;
            ctx.arc(this.x,this.y,this.r,0,2*Math.PI);
            ctx.fill();
            ctx.closePath();
            ctx.restore();
        },
        smoke:function(){
            ctx.save();
            ctx.beginPath();
            ctx.fillStyle='rgba(255,228,150,0.3)';
            ctx.arc(this.x,this.y,this.r+Math.random()*3,0,2*Math.PI);
            ctx.fill();
            ctx.closePath();
            ctx.restore();
        },
        update:function(){
            var dx=this.tx-this.x,dy=this.ty-this.y;
            if(Math.abs(dx)<this.ba && Math.abs(dy)<this.ba){
                this.dead=true;
                if(this.shape){
                    this.shapeBoom();
                }else{
                    this.boom();
                }
                for(var i=0;i<audio.length;i++){
                    if(audio[i].src.indexOf('boom')>=0 && (audio[i].paused || audio[i].ended)){
                        audio[i].play();
                        break;
                    }
                }
            }else{
                this.x+=dx*0.03;
                this.y+=dy*0.03;
                this.paint();
            }
        },
        boom:function(){
            var count=getRand(100,300),r,color,tx,ty,angle,distance;
            for(var i=0;i<count;i++){
                r=getRand(1,3);
                angle=getRand(-Math.PI,Math.PI);
                color={
                    a:parseInt(getRand(0,255)),
                    b:parseInt(getRand(0,255)),
                    c:parseInt(getRand(0,255))
                },
                distance=getRand(0,count);
                tx=Math.cos(angle)*distance+this.x;
                ty=Math.sin(angle)*distance+this.y;
                this.booms.push(new Particle(this.x,this.y,r,color,tx,ty));
            }
        },
        shapeBoom:function(){
            var that=this,step=4,dx=cw/2-this.tx,dy=ch/2-this.ty;
            getData(this.shape,step,function(dots){
                dots.forEach(function(){
                    that.booms.push(new Particle(that.x,that.y,1,this.color,this.x-dx,this.y-dy));
                });
            });
        }
    }
    function getData(dom,step,callback){
        var text=dom.innerHTML,imgData=[],dots=[],i;
        octx.clearRect(0,0,cw,ch);
        octx.save();
        octx.font='120px 微?雅黑 bold';
        octx.textAlign='center';
        octx.textBaseline='middle';
        octx.fillStyle='rgba('+parseInt(getRand(168,255))+','+parseInt(getRand(168,255))+','+parseInt(getRand(168,255))+',1)';
        octx.fillText(text,cw/2,ch/2);
        octx.restore();

        imgData=octx.getImageData(0,0,cw,ch);
        for(var x=0;x<imgData.width;x+=step){
            for(var y=0;y<imgData.height;y+=step){
                i=(y*imgData.width+x)*4;
                if(imgData.data[i+3]>167){
                    dots.push({x:x,y:y,color:{
                        a:imgData.data[i],
                        b:imgData.data[i+1],
                        c:imgData.data[i+2]
                    }});
                }
            }
        }
        callback(dots);
    }

    function createMoon(){
        var sx=cw-200,sy=100,r=40,add=2;
        if(moon.complete){
            ctx.drawImage(moon,sx,sy,2*r,2*r);
        }else{
            moon.onload=function(){
                ctx.drawImage(moon,sx,sy,2*r,2*r);
            }
        }

        ctx.save();
        ctx.beginPath();
        ctx.fillStyle='rgba(240,219,120,0.05)';
        for(var i=0;i<5;i++){
            ctx.arc(sx+r,sy+r,r+add,0,2*Math.PI);
            ctx.fill();
            add+=2;
        }
        ctx.closePath();
        ctx.restore();
    }
    function createStars(){
        for(var i=0;i<100;i++){
            stars.push(new Star(getRand(0,cw),getRand(0,ch-200),Math.random(),'#fff'));
        }
    }
    function Star(x,y,r,color){
        this.x=x;
        this.y=y;
        this.r=r;
        this.color=color;
    }
    Star.prototype={
        paint:function(){
            ctx.save();
            ctx.beginPath();
            ctx.fillStyle=this.color;
            ctx.arc(this.x,this.y,this.r,0,2*Math.PI);
            ctx.fill();
            ctx.closePath();
            ctx.restore();
        }
    }

    function getRand(min,max){
        return Math.random()*(max-min)+min;
         }
    Array.prototype.forEach=function(callback){
        for(var i=0;i<this.length;i++){
            if(this[i]!=null){
                callback.call(this[i],i);
            }
        }
    }
 </script>
</html>