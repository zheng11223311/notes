**管理系统的登入和注册**

**创建项目**

```
express --view=ejs yyglxt
```

**进路项目**

```
cd yyglxt
```

**初始化项目**

```
 npm install
```

**运行项目**

```
SET DEBUG=yyglxt:* & npm start
```

**后台管理页面模板网站:**

https://www.mycodes.net/154/8437.htm

```js
//app.js 文件
var createError = require('http-errors');
var express = require('express');
var path = require('path');
var cookieParser = require('cookie-parser');
var logger = require('morgan');
//引入session 模块
let session=require('express-session')
//引入上传模块
let multer=require('multer')
//配置上传对象
let upload=multer({dest:'./public/upload'})
//引入加密模块
let jiami=require('./module/jiami.js')


var indexRouter = require('./routes/index');
var usersRouter = require('./routes/users');
//引入后台路由
var adminRouter = require('./routes/admin/adminRouter');
//引入注册登入模块
var loginRouter = require('./routes/login/loginRouter');

var app = express();

// view engine setup
app.set('views', path.join(__dirname, 'views'));
app.set('view engine', 'ejs');

//session 配置
app.use(session({
  secret:'zxccvvs',
  resave:true,    //强制保存session
  cookie:{
    maxAge:7*24*60*60*1000,   //设置session 的有效期为1周
  },
  saveUninitialized:true    //是否保存初始化的session
}))


app.use(logger('dev'));
app.use(express.json());
app.use(express.urlencoded({ extended: false }));
app.use(cookieParser());
app.use(express.static(path.join(__dirname, 'public')));

//前台路由
app.use('/', indexRouter);
//后台路由
app.use('/admin',adminRouter)
//注册登入路由
app.use('/login',loginRouter)

app.use('/users', usersRouter);

// catch 404 and forward to error handler
app.use(function(req, res, next) {
  next(createError(404));
});

// error handler
app.use(function(err, req, res, next) {
  // set locals, only providing error in development
  res.locals.message = err.message;
  res.locals.error = req.app.get('env') === 'development' ? err : {};

  // render the error page
  res.status(err.status || 500);
  res.render('error');
});

module.exports = app;

```

**routes 下的login 文件夹下的loginRouter.js 文件**

```js
var express = require('express');
const jiami = require('../../module/jiami');
var router = express.Router();
var sqlQuery=require('../../module/sqlQuery')
// console.log(sqlQuery);
/* GET users listing. */
router.get('/', function(req, res, next) {
  res.send('注册登入管理模块');
});

//获取登入表单post 提交的数据
router.post('/logincheck.html',async function(req, res, next) {
  let user=req.body.user 
  let password=req.body.password
  console.log(req.body);
  console.log(user,password);
  //判断用户是否存在,如果没有用户才进行登入操作
  let sqlStr='select * from user where user = "'+user+'" and password ="'+jiami(password)+'"'
  //使用promise 导出函数内sqlQuery 查询结果,使用await 接收到导出的结果
  let result=await sqlQuery(sqlStr,'yygl')
  // console.log(result);
  if(result.length!=0){
    //存在用户
    //  保存session
    // req.session.user=user
    res.render('ProClinic医院管理系统响应式模板/index.ejs')
    
  }else{
    res.send(`<h1>账号或密码输入错误</h1>
    <p><span>5</span>s 后跳转至登入页面</p>
    <p class="">你也可以手动点击:<a href="/login/login.html" class="">跳转至登入页面</a></p>
  <script>
    let num=5
    setInterval(()=>{
      num--
      if(num<0){
        location.href='/login/login.html'
      }else{
        document.querySelector('span').innerHTML=num
      }
    },1000)
    </script>
    `)
  }

  
});
router.get('/register', function(req, res, next) {
    //自动找到views 下的子目录
    //views 下的ejs 文件 自动找到public 下的子目录文件
    //例如:href="/images/fav.png">  自动找到public 下的子目录 images 文件
    //images 前面要加/ 指定根目录public
  res.render('ProClinic医院管理系统响应式模板/index.ejs')
});


router.get('/login', function(req, res, next) {
  res.send('登入管理模块');
});

//用户注册模块
router.post('/login.html', async function(req, res, next) {
  //获取username 和密码
  let user=req.body.user 
  let password=req.body.password
  let email=req.body.email
  // console.log(req.body);
  // console.log(password);
  //判断用户是否存在,如果没有用户才进行插入操作
  /* 
    node中调用mysql模块读写时候，如果直接插入字符串：

connection.query(‘SELECT * from users WHERE name=’ + data.name , callback);

或者：

connection.query(‘SELECT * from users WHERE name = alan’ , callback);

会抛出这个错误。

正确写法应该是：

connection.query("SELECT * from users WHERE name= ‘alan’ ", callback);

或者

connection.query("SELECT * from users WHERE name= ’ “+ data.name+” ’ ", callback);

转载：https://www.cnblogs.com/alan2kat/p/7773796.html

  */
  let sqlStr='select * from user where user = "'+user+'"'
  //使用promise 导出函数内sqlQuery 查询结果,使用await 接收到导出的结果
  let result=await sqlQuery(sqlStr,'yygl')
  console.log(result);
  if(result.length!=0){
    // 告知此用户名已存在,请直接登入或找回密码
    res.render('info/info')
  }else{
    //设置id 为自增长
    // alter table user modify id int(11) auto_increment;
    sqlStr='insert into user (user,password) values("'+user+'","'+ jiami(password) +'")'
    sqlQuery(sqlStr,'yygl')
    console.log('注册成功');
    res.render('ProClinic医院管理系统响应式模板/login.ejs')
  }
  
});
// 默认首页
router.get('/index.html', function(req, res, next) {
  res.render('ProClinic医院管理系统响应式模板/index.ejs')
});
// 添加病人信息
router.get('/add-patient.html', function(req, res, next) {
  res.render('ProClinic医院管理系统响应式模板/add-patient.ejs')
});
// 查看病人信息
router.get('/patients.html', function(req, res, next) {
  res.render('ProClinic医院管理系统响应式模板/patients.ejs')
});
// 病人详情
router.get('/about-patient.html', function(req, res, next) {
  res.render('ProClinic医院管理系统响应式模板/about-patient.ejs')
});
// 编辑病人信息
router.get('/edit-patient.html', function(req, res, next) {
  res.render('ProClinic医院管理系统响应式模板/edit-patient.ejs')
});



// 添加医生信息
router.get('/add-doctor.html', function(req, res, next) {
  res.render('ProClinic医院管理系统响应式模板/add-doctor.ejs')
});
// 查询医生信息
router.get('/doctors.html', function(req, res, next) {
  res.render('ProClinic医院管理系统响应式模板/doctors.ejs')
});
// 编辑医生信息
router.get('/about-doctor.html', function(req, res, next) {
  res.render('ProClinic医院管理系统响应式模板/about-doctor.ejs')
});
// 医生信息详情
router.get('/edit-doctor.html', function(req, res, next) {
  res.render('ProClinic医院管理系统响应式模板/edit-doctor.ejs')
});



// 添加出诊信息
router.get('/add-appointment.html', function(req, res, next) {
  res.render('ProClinic医院管理系统响应式模板/add-appointment.ejs')
});
// 查询出诊信息
router.get('/appointments.html', function(req, res, next) {
  res.render('ProClinic医院管理系统响应式模板/appointments.ejs')
});
// 出诊信息详情
router.get('/about-appointment.html', function(req, res, next) {
  res.render('ProClinic医院管理系统响应式模板/about-appointment.ejs')
});
// 编辑出诊信息
router.get('/edit-appointment.html', function(req, res, next) {
  res.render('ProClinic医院管理系统响应式模板/edit-appointment.ejs')
});



// 添加支付
router.get('/add-payment.html', function(req, res, next) {
  res.render('ProClinic医院管理系统响应式模板/add-payment.ejs')
});
// 所有支付
router.get('/payments.html', function(req, res, next) {
  res.render('ProClinic医院管理系统响应式模板/payments.ejs')
});
// 发票
router.get('/about-payment.html', function(req, res, next) {
  res.render('ProClinic医院管理系统响应式模板/about-payment.ejs')
});



// 添加病房
router.get('/add-room.html', function(req, res, next) {
  res.render('ProClinic医院管理系统响应式模板/add-room.ejs')
});
// 查询病房
router.get('/rooms.html', function(req, res, next) {
  res.render('ProClinic医院管理系统响应式模板/rooms.ejs')
});
// 编辑病房信息
router.get('/edit-room.html', function(req, res, next) {
  res.render('ProClinic医院管理系统响应式模板/edit-room.ejs')
});



// 排版
router.get('/typography.html', function(req, res, next) {
  res.render('ProClinic医院管理系统响应式模板/typography.ejs')
});
// 按钮
router.get('/buttons.html', function(req, res, next) {
  res.render('ProClinic医院管理系统响应式模板/buttons.ejs')
});
// 卡片
router.get('/cards.html', function(req, res, next) {
  res.render('ProClinic医院管理系统响应式模板/cards.ejs')
});
// 选项卡
router.get('/tabs.html', function(req, res, next) {
  res.render('ProClinic医院管理系统响应式模板/tabs.ejs')
});
// 手风琴
router.get('/accordions.html', function(req, res, next) {
  res.render('ProClinic医院管理系统响应式模板/accordions.ejs')
});
// 模态窗口
router.get('/modals.html', function(req, res, next) {
  res.render('ProClinic医院管理系统响应式模板/modals.ejs')
});
// 媒体和列表
router.get('/lists.html', function(req, res, next) {
  res.render('ProClinic医院管理系统响应式模板/lists.ejs')
});
// 网格
router.get('/grid.html', function(req, res, next) {
  res.render('ProClinic医院管理系统响应式模板/grid.ejs')
});
// 进度条   
router.get('/progress-bars.html', function(req, res, next) {
  res.render('ProClinic医院管理系统响应式模板/progress-bars.ejs')
});
// 预警和提示
router.get('/notifications-alerts.html', function(req, res, next) {
  res.render('ProClinic医院管理系统响应式模板/notifications-alerts.ejs')
});
// 分页
router.get('/pagination.html', function(req, res, next) {
  res.render('ProClinic医院管理系统响应式模板/pagination.ejs')
});
// 滑块
router.get('/carousel.html', function(req, res, next) {
  res.render('ProClinic医院管理系统响应式模板/carousel.ejs')
});
// 表格
router.get('/tables.html', function(req, res, next) {
  res.render('ProClinic医院管理系统响应式模板/tables.ejs')
});
// Morris图表
router.get('/charts-1.html', function(req, res, next) {
  res.render('ProClinic医院管理系统响应式模板/charts-1.ejs')
});
// Flot图表
router.get('/charts-2.html', function(req, res, next) {
  res.render('ProClinic医院管理系统响应式模板/charts-2.ejs')
});
// 谷歌地图
router.get('/map-1.html', function(req, res, next) {
  res.render('ProClinic医院管理系统响应式模板/map-1.ejs')
});
// Vector地图
router.get('/map-2.html', function(req, res, next) {
  res.render('ProClinic医院管理系统响应式模板/map-2.ejs')
});
// 表单
router.get('/forms.html', function(req, res, next) {
  res.render('ProClinic医院管理系统响应式模板/forms.ejs')
});
// Font Awesome 
router.get('/font-awesome.html', function(req, res, next) {
  res.render('ProClinic医院管理系统响应式模板/font-awesome.ejs')
});
// Themify图标
router.get('/themify.html', function(req, res, next) {
  res.render('ProClinic医院管理系统响应式模板/themify.ejs')
});




// 登录
router.get('/login.html', function(req, res, next) {
  res.render('ProClinic医院管理系统响应式模板/login.ejs')
});
// 注册
router.get('/sign-up.html', function(req, res, next) {
  res.render('ProClinic医院管理系统响应式模板/sign-up.ejs')
});
// 404
router.get('/404.html', function(req, res, next) {
  res.render('ProClinic医院管理系统响应式模板/404.ejs')
});
// 空白页
router.get('/blank-page.html', function(req, res, next) {
  res.render('ProClinic医院管理系统响应式模板/blank-page.ejs')
});
// 价格表
router.get('/pricing.html', function(req, res, next) {
  res.render('ProClinic医院管理系统响应式模板/pricing.ejs')
});
// FAQ
router.get('/faq.html', function(req, res, next) {
  res.render('ProClinic医院管理系统响应式模板/faq.ejs')
});
// 发票
router.get('/invoice.html', function(req, res, next) {
  res.render('ProClinic医院管理系统响应式模板/invoice.ejs')
});



module.exports = router;
```

**注意:views 下的error .ejs 文件不能删除,因为views 必须要有一个error 文件,否则会报错**

```js
//module 文件夹下的jaimi.js 文件
function jiami(num){
    let crypto=require('crypto')
    let sf=crypto.createHash('md5')    //使用的 md5 算法
    sf.update(''+num)     //对password 进行加密,必须是字符类型
    let content=sf.digest('hex')  //加密的二进制数据以字符串的形式显示
    console.log(content);
    return content
}

module.exports=jiami

```

```js
//module 文件夹下的sqlQuery.js 文件
//封装数据库查询函数

function sqlQuery(strsql,ku){
     return new Promise(function(resolve,reject){
          let mysql=require('mysql')
          let options={
            host:'localhost',        //主机名
            // port:'3300',            //端口号,默认3306
            user:'root',
            password:'',
            database:ku           //连接的数据库,没有数据库时可以不写
            }

        let con=mysql.createConnection(options)     //创建数据库
    //建立连接
    con.connect((err)=>{
                //如果建立连接失败
                if(err){
                console.log(err);
            }else{
                console.log('数据库连接成功');
            }
        })      
    //  strsql='insert into user (id,user,password) values(3,"hello","1234")'
    con.query(strsql,[],(err,data,fields)=>{
            // err 错误信息,data 成功返回的数据,fields 数据的信息
            // console.log(err);
            // console.log(data);
            // console.log(fields);
                 if(err){
                reject(err);
            }else{
                console.log('数据字段查询成功');
                resolve(data)
            }
           })

     })

   
}

module.exports =sqlQuery
```

