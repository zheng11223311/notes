**中间件**

从字面意思,我们可以了解到他大概就是做中间代理操作,事实也是如此,大多数情况下,中间件就是在做接收到请求和发送响应中间的一系列操作,事实上,express 是一个路由和中间件的web 框架,Express 应用程序基本上是一系列中间件函数的调用

1.浏览器发送请求

2.express 接收请求

中间处理的过程

3.路由函数处理渲染

4.res.render 渲染



中间件函数可以执行以下任务:

> 执行任何代码
>
> 对请求和响应对象进行更改
>
> 结束请求/响应循环
>
> 调用堆栈中的下一个中间件函数

中间件也分为应用层中间件,路由中间件,内置中间件,错误处理中间件和第三方中间件,下面分别对以下进行说明:

**1.应用层中间件**

应用级中间件绑定到app 对象使用app.use() 和app\.METHOD() 需要处理http 请求的方法,例如GET,PUT,POST,将之前的get 或者post 替换为use 就行

例如下面的实例:

```js
const express=require('express')

var app=espress()

//匹配路由之前的操作
app.use((req,res,next)=>{
    console.log('访问之前')
    next()
})

app.get('/',(req,res)=>{
    res.send('主页')
})

app.listen(8080)
```

这时我们会发现http://localhost;8080/ 地址一直在价加载,但是命令行里面显示了"访问之前",说明程序不会进一步执行,如果使用了next 来使路由继续向下匹配,那么就能得到主页数据了

app.use 也可以写多个函数

```js
const express=require('express')

var app=espress()

//匹配路由之前的操作
app.use((req,res,next)=>{
    console.log('访问之前')
    next()		//next 才能传递给下一个函数,使下一个函数执行
},(req,res)=>{
    res.send('主页')
})

app.listen(8080)
```

**2.路由中间件**

路由中间件和应用级中间件类似,只不过他需要绑定express.Router()

```
var router=express.Router()
```

在匹配路由时,我们使用router.use() 或router.VERB(),路由中间件结合多次callback 可用于用户登入及用户状态检查

```js
const express=require('express')
var app=express()
var router=express.router()

router.use('/',function(rreq,res,next){
    console.log('匹配前')
    next()
})

router.use('/user',function(req,res,next){
    console.log('匹配地址',res.originalUrl)
    next()
},(req.res)=>{
    res.send('用户登入')
})

app.get('/',router)
app.listen(8080)
```

总之在检测用户登入和引导用户应该访问那个页面时,路由中间件绝对好用

```js
//app.js 文件
var express = require('express');
var path = require('path');


var app = express();

// view engine setup
app.set('views', path.join(__dirname, 'views'));
app.set('view engine', 'ejs');


app.use(express.urlencoded({ extended: false }));   // 解析req.body
app.use(express.static(path.join(__dirname, 'public')));    //设置静态页面



// 添加中间件,可以有多个函数
app.use((req,res,next)=>{
  //向其中添加自定义函数
  res.addNum=function(a,b){
    return a+b
  }
    console.log('访问任何页面,此函数都会被调用');
    next()    //放行,进入下一界面
})


app.get('/',(req,res)=>{
  res.send('这是主页'+res.addNum(7,8))
})


//实例化路由模块,此路由模块相当于一个小的app 实例
//商城的首页
let router=express.Router()

// router 中间件  与app.use() 一致,只不过是使用在商城模块里面
router.use((req,res,next)=>{
  res.send('判断是否是商城用户')    //res.send 这里使用后,/list 等输出的res.send 无效
  next()
})
 
//http://localhost:3000/mall
router.get('/',(req,res)=>{
  res.send('商城首页')
})

//http://localhost:3000/mall/list
router.get('/list',(req,res)=>{
  res.send('商城产品列表页')
})

app.use('/mall',router)  //商城这个应用使用这个路由

//允许跨域请求
res.append('Access-Control-Allow-Origin','*')   //允许所有的源
res.append('Access-Control-Allow-Content-Type','*')   //允许所有的请求类型

module.exports = app;
```

**3.错误处理中间件**

顾名思义,它是指当我们匹配不到路由时所执行的操作,错误处理中间件和其他中间件基本一样,只不过其需要开发者提供4个自变量参数

```js
app.use((err,req,res,next)=>{
	res.sendStatus(err,httpStatusCode).json(err)
})
```

一般情况下,我们把错误处理放在最下面,这样我们即可对错误进行集中处理

```js
const express=require('express')
var app=express()

app.get('/',(req,res)=>{
	const err=new Error('Not Found')
	res.send('主页')
	next(err)
})

app.get('/user',(req,res,next)=>{
    console.log('用户登入')
    next(err)
},(req,res,next)=>{
    console.log('用户登入')
    next()
})

app.use((req,res)=>{
    res.status(404).send('未找到指定页面')
})

app.listen(8080)
```

**4.内置中间件**

从版本4.x 开始,Express 不再依赖Content,也就是说Express 以前的内置中间件作为单独模块,express.static 是Express  的唯一内置中间件

```js
express.static(root,[options])
```

通过express.static 我们可以指定要加载的静态资源

**5.第三方中间件**

形如之前我们的body-parser,采用引入外部模块的方式来获取更多的应用操作.如后期的cookie 和session

```js
var express=require('express')
var app=express()
var cookiePaeser=require('cookie-parser')
```

以上就是关于express 中间件类型,在实例项目中,中间件都是必不可少的,因此熟悉使用各种中间件会加快项目的开发效率