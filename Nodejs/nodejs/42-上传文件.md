**一.multer 中间件**

在上传文件时,我们通常会用到它,Multer 用于处理multipart/form-data 类型的表单数据,首先我们先安装它:

```
npm install multer --save
```

**二.使用**

首先在form 表单中我们需要设置enctype 为:multipart/form-data 表单类型,同时我们也需要用到fs 模块对文件重命名,下面是单文件上传实例

```html
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title></title>
</head>
<body>
<form action="http://localhost:8080" method="POST" enctype="multipart/form-data">
	<input type="file" name="files" value="指定文件"/>
	<br/><br/>
	<input type="submit" value="上传">
</form>
</body>
```

node 代码

```js
const express=require('express')
const multer=require('multer')
//初始化上传对象,dest 上传到的服务器目录下
var upload=multer({dest:'./upload/'})
var fs=require('fs')

var app.express()

app.use('/',upload.single('files'),(req,res)=>{		//files 为input type="file" 的name 值
    var oldFile=req.file.destination+'/'+req.file.filename	//指定旧文件
var newFile=req.file.destination+'/'+req.file.originalname	//指定新文件    
fs.rename(oldfile,newfile,(err)=>{
    if(err){
        res.send('上传失败!')
    }else{
       res.send('上传成功!')
    	}
	})
})

app.listen(8080)
```

在这里我们可以指定多个文件上传到根目录的upload 文件夹里,这里指的注意的是req.file 会返回文件的基本信息:

```
{
  fieldname: 'imgfile',		//input type="file" 的name 值
  originalname: '516612260.jpg',	//用户计算机上上传的文件名称
  encoding: '7bit',		//文件编码
  mimetype: 'image/jpeg',	//文件的MIME 类型
  destination: './public/upload',	//保存路径
  filename: '1e2952d74a388bddf153bd92d6f8d311',		//保存在destination 中的文件名称
  path: 'public\\upload\\1e2952d74a388bddf153bd92d6f8d311',	//已经上传文件的完整路径
  size: 184810		//文件大小
}
```

**app.js 文件**

```js
var createError = require('http-errors');
var express = require('express');
var path = require('path');
var cookieParser = require('cookie-parser');
var logger = require('morgan');   //输出到错误信息(日志)文件


var indexRouter = require('./routes/index');
var usersRouter = require('./routes/users');
var upload = require('./routes/upload');

var app = express();

// view engine setup
// express 视图的设置
app.set('views', path.join(__dirname, 'views'));
app.set('view engine', 'ejs');

//express 中间件,一层一层往下使用中间件
app.use(logger('dev'));   //输出开发环境下的日志信息
app.use(express.json());  //解析json 数据
app.use(express.urlencoded({ extended: false }));   //解析body 的数据
app.use(cookieParser('secret'));    //处理cookie
app.use(express.static(path.join(__dirname, 'public')));  //处理静态文件

//路由匹配
app.use('/', indexRouter);
app.use('/users', usersRouter);
app.use('/imgUpload', upload);

// catch 404 and forward to error handler
//设置404 中间件
app.use(function(req, res, next) {
  //渲染自己的404 页面,404 所用的js 和css 代码 都放在public 文件夹
  res.render('404.ejs')
  // next(createError(404));
});

// error handler
//处理错误的中间件
app.use(function(err, req, res, next) {
  // set locals, only providing error in development
  res.locals.message = err.message;
  res.locals.error = req.app.get('env') === 'development' ? err : {};

  // render the error page
  res.status(err.status || 500);
  res.render('error');
});

module.exports = app;

```

**routes 下的upload.js 文件**

```js
var express = require('express');
var router = express.Router();
var multer=require('multer')
var fs=require('fs')

//配置上传对象,自动创建文件夹
let upload1=multer({dest:'./public/upload'})

 
/* GET users listing. */
router.get('/', function(req, res, next) {
  res.render('uploadimg.ejs')
});



// 处理上传的POST 请求
// 如果上传单个文件，可调用upload。single（） 方法，并将表单文件的name 值传入
router.post('/',upload1.single('imgfile'),(req,res)=>{
    console.log(req.file);

    //重命名文件,因为直接上传的文件名为随机名字,我们想要重命名为.jpg 格式
      var oldFile=req.file. destination+'/'+req.file.filename	//指定旧文件
      var newFile=req.file. destination+'/'+req.file.originalname
      console.log(newFile);
      fs.rename(oldFile,newFile,err=>{
       if(err){
        res.send('上传失败!')
    }else{
       res.send('<h1>上传成功!<h1><img src="/upload/'+req.file.originalname +'"/>')
    	}
	  })
    
    // res.send(req.file)
})


module.exports = router;

```

**views 下的uploadimg.ejs 文件**

```ejs
<!DOCTYPE html>
<html>
  <head>
    <title>图片上传</title>
    <link rel='stylesheet' href='/stylesheets/style.css' />
  </head>
  <body>
    <h1>图片上传</h1>
    <!-- 表单上传文件时,需要改变属性enctype 为enctype="multipart/from-data" 
    ,即定义表单的上传类型为文件类型
    -->
    <form action="/imgUpload" method="post" enctype="multipart/form-data">
    <input type="file" name="imgfile" id="">
      <button type="submit">上传</button>
  </form>
  </body>
</html>

```

**三.上传多个文件**

在HTML 中找input type="file" 需要加上multiple 来实现过滤,multiple 不写参数则可以读取所有文件,而在服务端上,我们需要将single() 改为array('name',num);的形式来接收多个文件的上传请求,最后对他们全部进行重命名,在之前我们首先看看multer 支持哪些文件上传方式:

```js
.single(filename)	//接收一个以 filename 命名的文件 .fliename(fields)
.array(filename[,maxCount]) //接收一个以filename 命名的文件数组,可以配置maxCount 来限制上传的最大数量
.fields(fields)	//接收指定的fields 的混合文件,fields 是一个拥有name 和maxCount 的数组对象
.none()	//只接受文本域,如果任何文件上传到这个模式,将发生"LIMIT_UNEXPECTED_FILE"错误
.any()	//接收一切上传的文件
```

下面我们将会演示如何上传多个文件:

html:

```html
<!DOCTYPE html>
<html>
  <head>
    <title>图片上传</title>
    <link rel='stylesheet' href='/stylesheets/style.css' />
  </head>
  <body>
    <h1>图片上传</h1>
    <!-- 表单上传文件时,需要改变属性enctype 为enctype="multipart/from-data" 
    ,即定义表单的上传类型为文件类型
    -->
    <form action="/imgUpload" method="post" enctype="multipart/form-data">
    <input type="file" name="imgfile" id="">
      <button type="submit">上传</button>
  </form>
  </body>
</html>
```

node 代码:

```js
var express = require('express');
var multer=require('multer')
var fs=require('fs')

//配置上传对象,自动创建文件夹
let upload1=multer({dest:'./public/upload'})

var app=express()

app.use('/',upload.array('files',5),(req,res,next)=>{
    req.files.forEach((ele,index)=>{
        console.log(ele)
        var oldFile=ele.destination+ele.Filename	//指定旧文件
         var newFile=ele.destination+ele.originalname	//指定新文件
         fs.rename(oldFile,newFile,(err)=>{
             err?console.log('上传失败!'):console.log('上传成功!')
         })
    })
    res.send('成功上传')
})

app.listen(8080)
```

这里,,我们获取文件信息是通过req.files 来获取,它是由数组构成的对象,之后foreach() 循环对其进行重命名即可

**四.通过limits 来限制上传文件**

Multer 通过使用limits 这个对象来对数据进行限制,它允许使用以下参数:

```
key Description Default
fieldNameSize       field 名字最大长度 100 bytes
fieldSize           field 值最大长度	1MB
fields              非文件field 的最大长度
fileSzie			在multipart 表单中,文件最大长度(直接单位) 无限
files 				在multipart 表单中,文件最大数量 无限
parts				在multipart 表单中,part 传输的最大数量(fields+files)	无限
headerPairs			在multipart 表单中,键值对最大组数     2000
如果你上传的文件超出这些设定,MulterError 模块将会启用,该模块在node_modules/multer/lib/multererror.js 上
```

我们可以使用err.code 定位到该错误,他有7种code 方式,不同设置会返回不同code

```
LIMIT_PART_COUNT
LIMIT_FILE_SIZE
LIMIT_FILE_COUNT
LIMIT_FIELD_KEY
LIMIT_FIELD_VALUE
LIMIT_FIELD_COUNT
LIMIT_FIELD_SIZE
```

下面就给大家做个简单实例:

html 依然不变,js 代码如下:

```js
var express = require('express');
var multer=require('multer')
var fs=require('fs')

//配置上传对象,自动创建文件夹
//filesSize 文件大小20MB,文件数量5个
let upload1=multer({dest:'./public/upload',limits:{filesSize:1024*1024*20,files:5}})

var app=express()

app.use('/',upload.array('files',5),(req,res,next)=>{
    req.files.forEach((ele,index)=>{
        console.log(ele)
        var oldFile=ele.destination+ele.Filename	//指定旧文件
         var newFile=ele.destination+ele.originalname	//指定新文件
         fs.rename(oldFile,newFile,(err)=>{
             err?console.log('上传失败!'):console.log('上传成功!')
         })
    })
    next()
    res.send('上传成功!')
})

app.use((req,res,next)=>{
    if(err.code==="LIMIT_FILE_SIZE"){
        res.send('文件过大!')
    }
})

app.listen(8080)
```



























































