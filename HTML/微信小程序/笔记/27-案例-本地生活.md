# 案例-本地生活

### 演示页面效果以及主要功能

- 页面导航并传参
- 上拉触底时加载下一页数据
- 下拉刷新列表数据

![](D:\学习\wanye\HTML\微信小程序\笔记\img\27-1.png)





### 列表页面的API 接口

以`分页`的形式,加载`指定分类下`的商铺列表的数据:

1. **接口地址**
   1. https://www.escook.cn/categories/:cate_id/shops
   2. URl 地址中的:cate_id 是动态参数,表示分类的Id
2. **请求方式**
   1. GET 请求
3. **请求参数**
   1. `_page` 表示请求第几页的数据
   2. `_limit`表示每页请求几条数据





### 判断是否还有下一页数据

如果下面的公式成立,则证明没有下一页数据了:

`页码值*每页显示多少条数据>=总数据条数`

`page*pageSize>=total`



案例1: 总共有77 条数据,如果每页显示10条数据,则总共分为8 页,其中第8 页只有7 条数据

`page(7)*pageSize(10)>=total(77`)

`page(8)*pageSize(10)>=total(77`)



如果代码没有执行.需要重新编译一下才能继续执行





### 代码

app.json

```json
{
    "pages": [
        "pages/home/home",
        "pages/message/message",
        "pages/contact/contact",
        "pages/shoplist/shoplist"
    ],
    "window": {
        "backgroundTextStyle": "light",
        "navigationBarBackgroundColor": "#2b4b6b",
        "navigationBarTitleText": "本地生活",
        "navigationBarTextStyle": "white"
    },
    "tabBar": {
      "list": [{
        "pagePath": "pages/home/home",
        "text": "首页",
        "iconPath": "/images/home.png",
        "selectedIconPath": "/images/home1.png"
      },
      {
        "pagePath": "pages/message/message",
        "text": "消息",
        "iconPath": "/images/message_light.png",
        "selectedIconPath": "/images/message_light (1).png"
      },
      {
        "pagePath": "pages/contact/contact",
        "text": "联系我们",
        "iconPath": "/images/contact-phone.png",
        "selectedIconPath": "/images/contact-phone (1).png"
      }
    ]
    },
    "style": "v2",
    "sitemapLocation": "sitemap.json"
}
```



home.wxml

```html
<!--pages/home/home.wxml-->
<!-- 轮播图区域 -->
<swiper indicator-dots circular>
  <swiper-item wx:for="{{swiperList}}" wx:key="id">
    <image src="{{item.image}}"></image>
  </swiper-item>
</swiper>

<!-- 九宫格区域 -->
<view class="grid-list">
  <navigator class="grid-item" wx:for="{{gridList}}" wx:key="id" url="/pages/shoplist/shoplist?id={{item.id}}&title={{item.name}}">
    <image src="{{item.icon}}"></image>
    <text>{{item.name}}</text>
  </navigator>
</view>

<!-- 图片区域 -->
<view class="img-box">
<image mode="widthFix" src="/images/1.jpg"></image>
<image  mode="widthFix" src="/images/2.jpg"></image>
</view>
```



shoplist.wxml

```html
<!--pages/shoplist/shoplist.wxml-->
<view class="shop-item" wx:for="{{shopList}}" wx:key="id">
<view class="thumb">
<image src="{{item.images[0]}}"></image>
</view>
<view class="info">
<text class="shop-title">{{item.name}}</text>
<text>电话:{{tools.splitPhone(item.phone)}}</text>
<text>地址:{{item.address}}</text>
<text>营业时间:{{item.businessHours}}</text>
</view>
</view>

<wxs src="../../utils/tools.wxs" module="tools"></wxs>
```



shoplist.js

```js
// pages/shoplist/shoplist.js
Page({

  /**
   * 页面的初始数据
   */
  data: {
      query:{},
      shopList:[],
      page:1,
      pageSize:10,
      total:0,
      isloading:false
  },

  /**
   * 生命周期函数--监听页面加载
   */
  onLoad(options) {
    this.setData({
      query:options
    })
    wx.setNavigationBarTitle({
      title: this.data.query.title,
    })

    this.getShopList()
  },


  getShopList(cb){
    this.setData({
      isloading:true
    })
    // 展示loading 效果
    wx.showLoading({
      title: '数据加载中...',
    })
    wx.request({
      url: `https://www.escook.cn/categories/${this.data.query.id}/shops`,
      method:"GET",
      data:{
        _page:this.data.page,
        _limit:this.data.pageSize
      },
      success:(res)=>{
        console.log(res);
        this.setData({
          shopList:[...this.data.shopList,...res.data],
          total:res.header['X-Total-Count']-0
        })

      },
      complete:()=>{
        // 隐藏loading 效果
        wx.hideLoading({
          success: (res) => {},
        })
        this.setData({
          isloading:false
        })
        cb&&cb()
      }
    })
  },
  /**
   * 生命周期函数--监听页面初次渲染完成
   */
  onReady() {

  },

  /**
   * 生命周期函数--监听页面显示
   */
  onShow() {

  },

  /**
   * 生命周期函数--监听页面隐藏
   */
  onHide() {

  },

  /**
   * 生命周期函数--监听页面卸载
   */
  onUnload() {

  },

  /**
   * 页面相关事件处理函数--监听用户下拉动作
   */
  onPullDownRefresh() {
    // 需要重置关键的数据
    this.setData({
      page:1,
      shopList:[],
      total:0
    })
    // 重新发起数据请求
    this.getShopList(()=>{
      wx.stopPullDownRefresh({
        success: (res) => {},
      })
    })
  },

  /**
   * 页面上拉触底事件的处理函数
   */
  onReachBottom() {
    // 没有下一页数据了
    // console.log(this.data.page*this.data.pageSize);
    // console.log(this.data.total);
    if(this.data.page*this.data.pageSize>=this.data.total) {
      wx.showToast({
        title: '数据加载完毕!',
        icon:"none"
      })
      return
    }
    if(this.data.isloading) return
    this.setData({
      page:this.data.page+1
    })
    this.getShopList()
  },

  /**
   * 用户点击右上角分享
   */
  onShareAppMessage() {

  }
})
```



shoplist.json

```json
{
  "usingComponents": {},
  "onReachBottomDistance": 200,
  "enablePullDownRefresh": true,
  "backgroundColor": "#efefef",
  "backgroundTextStyle": "dark"
}
```



shoplist.wxss

```css
/* pages/shoplist/shoplist.wxss */
.shop-item{
  display: flex;
  padding: 15rpx;
  border: 1rpx solid #efefef;
  margin: 15rpx;
  border-radius: 8rpx;
  box-shadow: 1rpx 1rpx 15rpx #ddd;
}
.thumb image{
  width: 250rpx;
  height: 250rpx;
  display: block;
  margin-right: 15rpx;
}
.info{
  display: flex;
  flex-direction: column;
  justify-content: space-around;
  font-size: 24rpx;
}
.shop-title{
  font-weight: bold;
}
```



tools.wxs

```js
function splitPhone(str){
  if(str.length!==11) return str
  var arr=str.split('')
  arr.splice(3,0,'-')
  arr.splice(8,0,'-')
  return arr.join('')
}

module.exports={
  splitPhone:splitPhone
}

```







# 总结

1. **能够知道如何实现页面之间的导航跳转**
   1. 声明式导航, 编程式导航
2. **能够知道如何实现下拉刷新效果**
   1. enablePullDownrefresh ,onPullDownRefresh
3. **能够知道如何实现上拉加载更多效果**
   1. onReachBottomDistance , onReachBottom
4. **能够知道小程序中常用的生命周期函数**
   1. 应用生命周期函数:onLaunch ,onShow ,onHide
   2. 页面生命周期函数: onLoad , onShow , onReady(页面加载完成) ,onHide ,onUnload