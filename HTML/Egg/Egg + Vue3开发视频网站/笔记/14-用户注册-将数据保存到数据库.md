## 将数据保存到数据库中

```js
//Egg + Vue3开发视频网站\代码\youtubeclone-backend\app\controller\user.js
'use strict';

const Controller = require('egg').Controller;

class UserController extends Controller {
  async create() {
    const { ctx } = this;
    ctx.body = 'hi, egg';
    // 1.数据校验
    const body = this.ctx.request.body;
    this.ctx.validate({ // 配置验证规则,验证失败返回422,可以使用try catch 捕获并自定义错误提示
      username: { type: 'string' },
      email: { type: 'email' },
      password: { type: 'string' },
    }, body);
    // 使用app/service 中的user.js
    if (await this.service.user.findByUsername(body.username)) {
      this.ctx.throw(422, '用户已存在'); // 抛出错误,状态码,提示消息
    }
    if (await this.service.user.findByEmail(body.email)) {
      this.ctx.throw(422, '邮箱已存在'); // 抛出错误,状态码,提示消息
    }
    // 2.保存用户
    const user = await this.service.user.createUser(body);

    // 3.生成token
    // 4.发送响应
    this.ctx.body = {
      user: {
        email: user.email,
        // token: user.token,
        username: user.username,
        channelDescription: user.channelDescription,
        avatar: user.avatar,
      },
    };
  }
}

module.exports = UserController;

```



#### 逻辑处理

```js
// Egg + Vue3开发视频网站\代码\youtubeclone-backend\app\service\user.js
// 简单来说，Service 就是在复杂业务场景下用于做业务逻辑封装的一个抽象层
const Service = require('egg').Service;

class UserService extends Service {
  get User() {
    return this.app.model.User;
  }
  findByUsername(username) {
    return this.User.findOne({
      username,
    });
  }
  findByEmail(email) {
    return this.User.findOne({
      email,
    });
  }
  async createUser(data) {
    const user = new this.User(data);
    user.password = this.ctx.helper.md5(data.password); // md5 需要额外的扩展 app/extend/helper.js 框架已经匹配了加载文件的规则
    await user.save(); // 使用模型model 保存到数据库中
    return user;
  }
}

module.exports = UserService;

```



#### md5 扩展

```js
//Egg + Vue3开发视频网站\代码\youtubeclone-backend\app\extend\helper.js
const crypto = require('crypto');

exports.md5 = str => {
  // createHash 加密方式
  // update 需要加密的文字
  //  digest 十进制
  return crypto.createHash('md5').update(str).digest('hex');
};

```

