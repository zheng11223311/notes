## 用户注册

安装 egg 管理mongoose  的库

```powershell
npm i egg-validate --save  //save 生产环境
```

配置插件

```js
//Egg + Vue3开发视频网站\代码\youtubeclone-backend\config\plugin.js
'use strict';

/** @type Egg.EggPlugin */
// module.exports = {
//   // had enabled by egg
//   // static: {
//   //   enable: true,
//   // }
// };

exports.mongoose = { // 使用mongoose 插件
  enable: true,
  package: 'egg-mongoose',
};

exports.validate = { // 使用验证器插件
  enable: true,
  package: 'egg-validate',
};

```



## 使用中间件

自定义处理错误提示中间件

```js
//Egg + Vue3开发视频网站\代码\youtubeclone-backend\app\middleware\error_handler.js
// 错误统一处理中间件
module.exports = () => { // 外层函数负责接收参数
  // 返回一个中间件函数
  return async function errorHandler(ctx, next) {
    try {
      await next(); // 传递到下一个中间件
    } catch (error) {
      // 所有的异常都在 app 上触发一个 error 事件,框架会记录一条错误日志
      ctx.app.emit('error', error, ctx); // 手动抛出异常,使框架自动记录错误日志

      const status = error.status || 500;
      // 生产环境时 500 错误的详细错误内容不返回给客户端,因为可能包含敏感信息
      const err = status === 500 && ctx.app.config.env === 'prod' ? 'Internal Server Error' : error.message;
      // 从err 对象上读取各个属性,设置到响应体中
      ctx.body = { err };
      if (status === 422) {
        ctx.body.detail = error.errors; // detail 为返回数据(对象形式)的键值
      }
      ctx.status = status;
    }
  };
};

```



## 使用中间件

```js
/* eslint valid-jsdoc: "off" */

'use strict';

/**
 * @param {Egg.EggAppInfo} appInfo app info
 */
module.exports = appInfo => {
  /**
   * built-in config
   * @type {Egg.EggAppConfig}
   **/
  const config = exports = {};

  // use for cookie sign key, should change to your own and keep security
  config.keys = appInfo.name + '_1657978081785_6636';

  // add your middleware config here
  config.middleware = [
    'errorHandler', // 添加自定义错误中间件,下划线需要改为驼峰命名
  ];

  // add your user config here
  const userConfig = {
    // myAppName: 'egg',
  };

  config.mongoose = {
    client: {
      url: 'mongodb://127.0.0.1/youtube-clone', // mongodb://127.0.0.1/example 地址 example 数据库
      options: {
        useUnifiedTopology: true,
      },
      plugins: [],
    },
  };

  config.security = { // 关闭 csrf 保护
    csrf: {
      enable: false,
    },
  };

  return {
    ...config,
    ...userConfig,
  };
};

```

