## 后端项目所有代码



#### /app/controller/

```html
<!--Egg + Vue3开发视频网站\代码\youtubeclone-backend\app\controller\文件上传测试.html-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
    <form action="http://127.0.0.1:7001/api/v1/videos" method="post" enctype="multipart/form-data">
        <input type="file" name="mufile">
        <input type="text" name="description" value="des">
        <input type="text" name="cover" value="cover">
        <input type="text" name="vodVideoId" value="id">
        <input type="submit" value="上传">
        
    </form>

    <iframe src="https://mp.weixin.qq.com/s/kfJRh8u1M1vFS1wjjYSmUQ" frameborder="0"></iframe>
    
</body>
</html>
```



```js
//Egg + Vue3开发视频网站\代码\youtubeclone-backend\app\controller\home.js
'use strict';

const Controller = require('egg').Controller;

class HomeController extends Controller {
  async index() {
    const { ctx } = this;
    const User = this.app.model.User; // 获取模型
    await new User({ // 使用模型创建表
      userName: 'admin',
      password: '123456',
    }).save(); // save 将数据保存到数据库,查看数据库,有字段生成
    ctx.body = 'hi, egg';
  }
}

module.exports = HomeController;

```



```js
//Egg + Vue3开发视频网站\代码\youtubeclone-backend\app\controller\user.js
'use strict';

const Controller = require('egg').Controller;

class UserController extends Controller {
  async create() {
    const { ctx } = this;
    ctx.body = 'hi, egg';
    // 1.数据校验
    const body = this.ctx.request.body;
    this.ctx.validate({ // 配置验证规则,验证失败返回422,可以使用try catch 捕获并自定义错误提示
      username: { type: 'string' },
      email: { type: 'email' },
      password: { type: 'string' },
    }, body);

    const userService = this.service.user;
    // 使用app/service 中的user.js
    if (await userService.findByUsername(body.username)) {
      this.ctx.throw(422, '用户已存在'); // 抛出错误,状态码,提示消息
    }
    if (await userService.findByEmail(body.email)) {
      this.ctx.throw(422, '邮箱已存在'); // 抛出错误,状态码,提示消息
    }
    // 2.保存用户
    const user = await userService.createUser(body);
    // 3.生成token
    // 使用安装后的token
    const token = userService.createToken({
      userId: user._id,
    });
    // 4.发送响应
    this.ctx.body = {
      user: {
        email: user.email,
        token,
        username: user.username,
        channelDescription: user.channelDescription,
        avatar: user.avatar,
      },
    };
  }
  async login() {

    const body = await this.ctx.request.body;
    // 1.基本数据验证
    this.ctx.validate({ // 配置验证规则,验证失败返回422,可以使用try catch 捕获并自定义错误提示
      email: { type: 'email' },
      password: { type: 'string' },
    }, body);
    // 2.校验邮箱是否存在
    const userService = this.service.user;
    const user = await userService.findByEmail(body.email);
    if (!user) {
      this.ctx.throw(422, '用户不存在');
    }
    // 3.校验密码是否正确
    if (this.ctx.helper.md5(body.password) !== user.password) {
      this.ctx.throw(422, '密码不正确');
    }
    // 4.生成token
    const token = userService.createToken({
      userId: user._id,
    });
    // 5.发送响应数据
    this.ctx.body = {
      user: {
        email: user.email,
        token,
        username: user.username,
        channelDescription: user.channelDescription,
        avatar: user.avatar,
      },
    };
  }
  async getCurrentUser() {
    // 1.验证token
    // 2.获取用户
    // 3.发送响应
    const user = this.ctx.user;
    this.ctx.body = {
      user: {
        email: user.email,
        token: this.ctx.headers.authorization,
        username: user.username,
        channelDescription: user.channelDescription,
        avatar: user.avatar,
      },
    };
  }
  async update() {
    const body = await this.ctx.request.body;
    // 1.基本数据验证
    this.ctx.validate({ // 配置验证规则,验证失败返回422,可以使用try catch 捕获并自定义错误提示
      email: { type: 'email', required: false },
      password: { type: 'string', required: false },
      username: { type: 'string', required: false },
      channel: { type: 'string', required: false },
      avatar: { type: 'string', required: false },
    }, body);

    // 2.校验邮箱是否已存在
    const userService = this.service.user;
    if (body.email) {
      // 使用app/service 中的user.js
      if (body.email !== this.ctx.user.email && await userService.findByEmail(body.email)) {
        this.ctx.throw(422, '邮箱已存在'); // 抛出错误,状态码,提示消息
      }
    }
    // 3.校验用户是否已存在
    if (body.username) {
      // 使用app/service 中的user.js
      if (body.username !== this.ctx.user.username && await userService.findByUsername(body.username)) {
        this.ctx.throw(422, '用户已存在'); // 抛出错误,状态码,提示消息
      }
    }
    if (body.password) {
      // 使用app/service 中的user.js
      body.password = this.ctx.helper.md5(body.password);
    }

    // 4.更新用户信息
    const user = await userService.updateUser(body);
    // 5.返回更新之后的用户信息
    this.ctx.body = {
      user: {
        email: user.email,
        username: user.username,
        channelDescription: user.channelDescription,
        avatar: user.avatar,
        password: user.password,
      },
    };
  }
  async subscribe() {
    const userId = this.ctx.user._id;
    const channelId = this.ctx.params.userId; // params.userId 获取路由中 /:userId/ 的值
    // 1.用户不能订阅自己
    if (userId.equals(channelId)) { // userid 是一个object 对象,不能直接比较,类型不一样
      this.ctx.throw(422, '用户订阅自己');
    }

    // 2.添加订阅
    const user = await this.service.user.subscribe(userId, channelId);
    // console.log(user);
    // 3.发送响应
    this.ctx.body = {
      user: {
        // ...user.toJSON(),
        ...this.ctx.helper._.pick(user, [ // 取出user 对象中指定的键的数据
          'username',
          'email',
          'avatar',
          'cover',
          'channelDescription',
          'subscribersCount',
        ]),
        isSubscribed: true, // 是否已订阅
      },
    };
  }
  async unsubscribe() {
    const userId = this.ctx.user._id;
    const channelId = this.ctx.params.userId; // params.userId 获取路由中 /:userId/ 的值
    // 1.用户不能订阅自己
    if (userId.equals(channelId)) { // userid 是一个object 对象,不能直接比较,类型不一样
      this.ctx.throw(422, '用户不能取消订阅自己');
    }

    // 2.取消订阅
    const user = await this.service.user.unsubscribe(userId, channelId);
    // console.log(user);
    // 3.发送响应
    this.ctx.body = {
      user: {
        // ...user.toJSON(),
        ...this.ctx.helper._.pick(user, [ // 取出user 对象中指定的键的数据
          'username',
          'email',
          'avatar',
          'cover',
          'channelDescription',
          'subscribersCount',
        ]),
        isSubscribed: false, // 是否已订阅
      },
    };
  }
  async getUser() {
    // 1.获取订阅状态
    let isSubscribed = false;
    if (this.ctx.user) { // 用户当前是否登入
      // 获取订阅记录
      const record = await this.app.model.Subscription({
        user: this.ctx.user._id,
        channel: this.ctx.params.userId,
      });
      // console.log(record);
      if (record) {
        isSubscribed = true;
      }
    }
    // 2.获取用户信息
    const user = await this.app.model.User.findById(this.ctx.params.userId);
    // 3.发送响应
    this.ctx.body = {
      user: {
        // ...user.toJSON(),
        ...this.ctx.helper._.pick(user, [ // 取出user 对象中指定的键的数据
          'username',
          'email',
          'avatar',
          'cover',
          'channelDescription',
          'subscribersCount',
        ]),
        isSubscribed, // 是否已订阅
      },
    };
  }
  async getSubscriptions() {
    const { Subscription } = this.app.model;
    // console.log(this.ctx.params.userId);
    //   await Subscription.find 模型查找是异步的,不使用await 只会返回query 对象,而不是数据
    let subscription = await Subscription.find({
      user: this.ctx.params.userId,
    }, (e, doc) => {
      // console.log(doc);
    }).populate('channel'); // populate('channel') 关联查询User 表的channel 字段,populate 居住于; 生活于; 移民于; 占据;

    // subscription.exec((err, docs) => {
    //   if (err) {
    //     console.log('err: ' + err);
    //     return;
    //   }
    //   console.log(JSON.stringify(docs));
    // });
    subscription = subscription.map(item => {
      return this.ctx.helper._.pick(item.channel, [ // 选择使用对象中指定的字段
        '_id',
        'username',
        'avatar',
      ]);
    // return {
    //   _id: item.channel._id,
    //   username: item.channel.username,
    //   avatar: item.channel.avatar,
    // };
    });
    this.ctx.body = {
      subscription,
    };
    // console.log(subscription);
  }
}

module.exports = UserController;

```



```js
//Egg + Vue3开发视频网站\代码\youtubeclone-backend\app\controller\video.js
'use strict';

const fs = require('fs');
const path = require('path');
const { md5 } = require('../extend/helper');
const Controller = require('egg').Controller;

class VideoController extends Controller {
  async createVideo() {
    const body = this.ctx.request.body;
    const { Video } = this.app.model;
    // 文件上传需要在config.default.js 中配置multipart
    const file = this.ctx.request.files; // file包含了文件名，文件类型，大小，路径等信息，可以自己打印下看看
    console.log(file);
    console.log(body);
    // console.log(file[0].filename);
    const fileObj = {
      title: file[0].filename,
      description: body.description,
      cover: body.cover,
      vodVideoId: md5(body.vodVideoId),
      playUrl: './video/' + file[0].filename,
    };
    this.ctx.validate({
      title: { type: 'string' },
      description: { type: 'string' },
      cover: { type: 'string' },
      vodVideoId: { type: 'string' },
      playUrl: { type: 'string' },
    }, fileObj);
    fileObj.user = this.ctx.user._id;
    // fileObj.user = '62d9097b03166e1c1cdea254';
    const video = await new Video(fileObj).save();
    this.ctx.status = 201;
    console.log('文件/video 是否存在', fs.existsSync('/video'));
    console.log('当前位置', __dirname);
    if (!fs.existsSync('./video')) {
      console.log(fs.mkdirSync('./video'));
    }
    fs.writeFileSync('./video/' + file[0].filename, fs.readFileSync(file[0].filepath));
    this.ctx.body = {
      video,
      // imgUrl: './video/' + file[0].filename,
    };
  }
  async getVideo() {
    const { Video, Like, Subscription } = this.app.model;
    const { videoId } = this.ctx.params; // 路由 :videoId 传递的值
    let video = await Video.find({
      title: videoId,
    }).populate('user', '_id username avatar subscribersCount'); // 关联 user 字段,查找user 字段所关联的表的_id username 等字段
    if (!video) {
      this.ctx.throw(404, 'Video Not Found');
    }
    // console.log(this.app.model);
    // console.log(Video);
    // console.log(Like);
    // console.log(Subscription);
    video = video[0].toJSON();
    video.isLiked = false; // 是否喜欢
    video.isDisLiked = false; // 是否不喜欢
    video.user.isSubscribed = false; // 是否已订阅视频作者

    // this.ctx.user = {};
    // this.ctx.user._id = '62d9097b03166e1c1cdea254';
    // console.log(this.ctx.user, 1111111);
    if (this.ctx.user) {
      const userId = this.ctx.user._id;
      // const userId = '62d9097b03166e1c1cdea254';
      if (await Like.findOne({ user: userId, video: videoId, like: 1 })) {
        video.isLiked = true;
      }
      if (await Like.findOne({ user: userId, video: videoId, like: -1 })) {
        video.isDisLiked = true;
      }
      if (await Subscription.findOne({ user: userId, channel: video.user._id })) {
        video.user.isSubscribed = true;
      }
    }
    this.ctx.body = {
      video,
    };
  }
  async getVideos() {
    const { Video } = this.app.model;
    let { pageNum = 1, pageSize = 10 } = this.ctx.query;
    pageNum = Number.parseInt(pageNum);
    pageSize = Number.parseInt(pageSize);
    console.log(pageNum, pageSize);
    const getvideos = Video.find().populate('user').sort({
      createAt: -1,
    })
      .skip((pageNum - 1) * pageSize)
      .limit(pageSize);

    const getvideosCount = Video.countDocuments(); // 数据总数量
    const [ videos, videosCount ] = await Promise.all([
      getvideos,
      getvideosCount,
    ]);
    this.ctx.body = {
      videos,
      videosCount,
    };
  }
  async getUserVideos() {
    const { Video } = this.app.model;
    let { pageNum = 1, pageSize = 10 } = this.ctx.query;
    const userId = this.ctx.params.userId;
    pageNum = Number.parseInt(pageNum);
    pageSize = Number.parseInt(pageSize);
    console.log(pageNum, pageSize);
    const getvideos = Video.find({
      user: userId,
    }).populate('user').sort({
      createAt: -1,
    })
      .skip((pageNum - 1) * pageSize)
      .limit(pageSize);

    const getvideosCount = Video.countDocuments({
      user: userId,
    }); // 数据总数量
    const [ videos, videosCount ] = await Promise.all([
      getvideos,
      getvideosCount,
    ]);
    this.ctx.body = {
      videos,
      videosCount,
    };
  }
  async getUserFeedVideos() {
    const { Video, Subscription } = this.app.model;
    let { pageNum = 1, pageSize = 10 } = this.ctx.query;
    const userId = this.ctx.user._id;
    pageNum = Number.parseInt(pageNum);
    pageSize = Number.parseInt(pageSize);

    const channels = await Subscription.find({ user: userId }).populate('channel');
    console.log(channels);
    const getvideos = Video.find({
      user: {
        $in: channels.map(item => item.channel._id), // 包含在channels 内的user
      },
    })
    // .populate('user').sort({
    //   createAt: -1,
    // })
      .skip((pageNum - 1) * pageSize)
      .limit(pageSize);

    const getvideosCount = Video.countDocuments({
      user: {
        $in: channels.map(item => item.channel._id), // 包含在channels 内的user
      },
    }); // 数据总数量
    const [ videos, videosCount ] = await Promise.all([
      getvideos,
      getvideosCount,
    ]);
    this.ctx.body = {
      videos,
      videosCount,
    };
  }
  async updateVideos() {
    const body = this.ctx.request.body;
    const { Video } = this.app.model;
    const { videoId } = this.ctx.params;
    const userId = this.ctx.user._id;

    // 数据验证
    this.ctx.validate({
      title: { type: 'string', required: false },
      description: { type: 'string', required: false },
      vodVideoId: { type: 'string', required: false },
      cover: { type: 'string', required: false },
    }, body);

    // 查询视频
    const video = await Video.findById(videoId);
    // console.log(video);
    // console.log( this.ctx.params);
    if (!video) {
      this.ctx.throw(404, 'Video Not Found');
    }

    // 视频作者必须是当前登入用户
    if (!video.user.equals(userId)) {
      this.ctx.throw(403); // 禁止访问"Forbidden"
    }

    // 合并对象数据
    Object.assign(video, this.ctx.helper._.pick(body, [
      'title',
      'description',
      'vodVideoId',
      'cover',
    ]));
    // console.log(video);
    // 把修改保存到数据库中
    await video.save();

    // 发送响应
    this.ctx.body = {
      video,
    };
  }
  async deleteVideos() {
    const { Video } = this.app.model;
    const { videoId } = this.ctx.params;
    const userId = this.ctx.user._id;

    // 查询视频
    const video = await Video.findById(videoId);
    if (!video) {
      this.ctx.throw(404, 'Video Not Found');
    }

    // 视频作者必须是当前登入用户
    if (!video.user.equals(userId)) {
      this.ctx.throw(403); // 禁止访问"Forbidden"
    }

    await video.remove();
    this.ctx.status = 204;
  }
  async createComment() {
    const body = this.ctx.request.body;
    const { Video, Comment } = this.app.model;
    const userId = this.ctx.user._id;
    const { videoId } = this.ctx.params;

    // 数据验证
    this.ctx.validate({
      content: 'string',
    }, body);

    // 获取评论所属的视频
    const video = await Video.findById(videoId);

    if (!video) {
      this.ctx.throw(404);
    }

    // 创建评论
    const comment = await new Comment({
      content: body.content,
      user: userId,
      video: videoId,
    }).save();

    // 更新视频的评论数量
    video.commentCount = await Comment.countDocuments({
      video: videoId,
    });

    await video.save();

    // 映射评论所属用户和视频字段数据
    await comment.populate('user').populate('video').execPopulate();

    this.ctx.body = {
      comment,
    };
  }
  async getVideoComments() {
    const { Comment } = this.app.model;
    let { pageNum = 1, pageSize = 10 } = this.ctx.query;
    const { videoId } = this.ctx.params;
    pageNum = Number.parseInt(pageNum);
    pageSize = Number.parseInt(pageSize);

    const getComments = Comment.find({
      video: videoId,
    })
      .skip((pageNum - 1) * pageSize)
      .limit(pageSize)
      .populate('user')
      .populate('video');

    const getCommentsCount = Comment.countDocuments({
      video: videoId,
    }); // 数据总数量
    const [ comments, commentsCount ] = await Promise.all([
      getComments,
      getCommentsCount,
    ]);
    this.ctx.body = {
      comments,
      commentsCount,
    };
  }
  async deleteVideoComments() {
    const { Comment, Video } = this.app.model;
    const { videoId, commentId } = this.ctx.params;

    // 校验视频是否存在
    const video = await Video.findById(videoId);
    if (!video) {
      this.ctx.throw(404, 'Video Not Found');
    }

    const comment = await Comment.findById(commentId);

    // 检验评论是否存在
    if (!comment) {
      this.ctx.throw(404, 'Commnet Not Found');
    }

    // 校验当前评论作者是否是当前登入用户
    if (!comment.user.equals(this.ctx.user._id)) {
      this.ctx.throw(403);
    }

    // 删除视频评论
    await comment.remove();

    // 更新视频的评论数量
    video.commentCount = await Comment.countDocuments({
      video: videoId,
    });

    await video.save();

    this.ctx.status = 204;
  }
  async likeVideo() {
    const { Video, Like } = this.app.model;
    const { videoId } = this.ctx.params;
    const userId = this.ctx.user._id;
    const video = await Video.findById(videoId);

    if (!video) {
      this.ctx.throw(404, 'Video Not Found');
    }

    const doc = await Like.findOne({
      user: userId,
      video: videoId,
    });

    let isLiked = true;

    if (doc && doc.like === 1) {
      await doc.remove(); // 取消点赞
      isLiked = false;
    } else if (doc && doc.like === -1) {
      doc.like = 1;
    } else {
      await new Like({
        user: userId,
        video: videoId,
        like: 1,
      }).save();
    }

    // 更新喜欢视频的数量
    video.likesCount = await Like.countDocuments({
      video: videoId,
      like: 1,
    });

    // 更新不喜欢视频的数量
    video.likesCount = await Like.countDocuments({
      video: videoId,
      like: -1,
    });

    // 将修改保存到数据库中
    await video.save();

    this.ctx.body = {
      video: {
        ...video.toJSON(),
        isLiked,
      },
    };
  }
  async dislikeVideo() {
    const { Video, Like } = this.app.model;
    const { videoId } = this.ctx.params;
    const userId = this.ctx.user._id;
    const video = await Video.findById(videoId);

    if (!video) {
      this.ctx.throw(404, `Not Video Found For ID - ${videoId}`);
    }

    const doc = await Like.findOne({
      user: userId,
      video: videoId,
    });

    let isdisLiked = true;

    if (doc && doc.like === -1) {
      await doc.remove(); // 取消点赞
      isdisLiked = false;
    } else if (doc && doc.like === 1) {
      doc.like = -1;
      await doc.save();
    } else {
      await new Like({
        user: userId,
        video: videoId,
        like: -1,
      }).save();
    }

    // 更新喜欢视频的数量
    video.likesCount = await Like.countDocuments({
      video: videoId,
      like: 1,
    });

    // 更新不喜欢视频的数量
    video.likesCount = await Like.countDocuments({
      video: videoId,
      like: -1,
    });

    // 将修改保存到数据库中
    await video.save();

    this.ctx.body = {
      video: {
        ...video.toJSON(),
        isdisLiked,
      },
    };
  }
  async getUserLikedVideos() {
    const { Like, Video } = this.app.model;
    let { pageNum = 1, pageSize = 10 } = this.ctx.query;
    const userId = this.ctx.user._id;
    pageNum = Number.parseInt(pageNum);
    pageSize = Number.parseInt(pageSize);

    const filterDoc = {
      user: userId,
      like: 1,
    };

    const like = await Like.find(filterDoc).sort({ createAt: -1 })
      .skip((pageNum - 1) * pageSize)
      .limit(pageSize);

    // console.log(like);
    const getVideos = Video.find({
      _id: {
        $in: like.map(item => item.video),
      },
    }).populate('user');
    const getVideosCount = Like.countDocuments(filterDoc);
    const [ videos, videosCount ] = await Promise.all([
      getVideos,
      getVideosCount,
    ]);
    this.ctx.body = {
      videos,
      videosCount,
    };
  }
}

module.exports = VideoController;

```



#### /app/extend

```js
//Egg + Vue3开发视频网站\代码\youtubeclone-backend\app\extend\helper.js
const crypto = require('crypto');
const _ = require('lodash');

exports.md5 = str => {
  // createHash 加密方式
  // update 需要加密的文字
  //  digest 十进制
  return crypto.createHash('md5').update(str).digest('hex');
};

exports._ = _;

```



#### /app/middleware

```js
//Egg + Vue3开发视频网站\代码\youtubeclone-backend\app\middleware\auth.js
// 授权认证 中间件
module.exports = (options = { required: true }) => { // options 获取路由传递过来的参数
  return async (ctx, next) => {
    // 1.获取请求头中的token 数据
    let token = ctx.headers.authorization;
    token = token ? token.split('Bearer ')[1] : null; // 格式:Bearer +空格+ token 数据,这里截取并获取到token 数据
    // 2.验证 token ,无效返回 401

    if (token) {
      try {
        // 3.token 有效,根据userId 获取用户数据挂载到 ctx 对象中给后续中间件使用
        const data = ctx.service.user.verifyToken(token); // 使用service/auth.js 验证
        ctx.user = await ctx.model.User.findById(data.userId);
      } catch (error) {
        ctx.throw(401);
      }
    } else if (options.required) {
      ctx.throw(401);
    }


    // 4.next 执行后续中间件
    await next();
  };
};

```



```js
//Egg + Vue3开发视频网站\代码\youtubeclone-backend\app\middleware\error_handler.js
// 错误统一处理中间件
module.exports = () => { // 外层函数负责接收参数
  // 返回一个中间件函数
  return async function errorHandler(ctx, next) {
    try {
      await next(); // 传递到下一个中间件
    } catch (error) {
      // 所有的异常都在 app 上触发一个 error 事件,框架会记录一条错误日志
      ctx.app.emit('error', error, ctx); // 手动抛出异常,使框架自动记录错误日志

      const status = error.status || 500;
      // 生产环境时 500 错误的详细错误内容不返回给客户端,因为可能包含敏感信息
      const err = status === 500 && ctx.app.config.env === 'prod' ? 'Internal Server Error' : error.message;
      // 从err 对象上读取各个属性,设置到响应体中
      ctx.body = { err };
      if (status === 422) {
        ctx.body.detail = error.errors;
      }
      ctx.status = status;
    }
  };
};

```



#### /app/model

```js
//Egg + Vue3开发视频网站\代码\youtubeclone-backend\app\model\comment.js
// app/model/comment.js
module.exports = app => {
  const mongoose = app.mongoose;
  const Schema = mongoose.Schema;

  const commentSchema = new Schema({
    content: { // 评论内容
      type: String,
      required: true,
    },
    user: { // 评论用户
      type: mongoose.ObjectId,
      ref: 'User',
      required: true,
    },
    video: { // 评论视频
      type: mongoose.ObjectId,
      ref: 'Video',
      required: true,
    },
    createAt: { // 创建时间
      type: Date,
      default: Date.now(),
    },
    updateAt: { // 更新时间
      type: Date,
      default: Date.now(),
    },
  });
  return mongoose.model('Comment', commentSchema);
};

```



```js
// Egg + Vue3开发视频网站\代码\youtubeclone-backend\app\model\like.js
// app/model/like.js
module.exports = app => {
  const mongoose = app.mongoose;
  const Schema = mongoose.Schema;

  const VideoLikeSchema = new Schema({
    like: { // 点赞状态
      type: Number,
      enum: [ 1, -1 ], // 1 喜欢 -1 不喜欢
      required: true,
    },
    user: { // 点赞用户
      type: mongoose.ObjectId,
      ref: 'User',
      required: true,
    },
    video: { // 点赞视频
      // type: mongoose.ObjectId,
      type: String,
      ref: 'Video',
      required: true,
    },
    createAt: { // 创建时间
      type: Date,
      default: Date.now(),
    },
    updateAt: { // 更新时间
      type: Date,
      default: Date.now(),
    },
  });
  return mongoose.model('VideoLike', VideoLikeSchema);
};

```



```js
//Egg + Vue3开发视频网站\代码\youtubeclone-backend\app\model\subscription.js
// app/model/subscription.js
module.exports = app => {
  const mongoose = app.mongoose;
  const Schema = mongoose.Schema;

  const subscriptionSchema = new Schema({
    user: { // 订阅用户
      type: mongoose.ObjectId,
      ref: 'User',
      required: true,
    },
    channel: { // 订阅频道
      type: mongoose.ObjectId,
      ref: 'User',
      required: true,
    },
    createAt: { // 创建时间
      type: Date,
      default: Date.now(),
    },
    updateAt: { // 更新时间
      type: Date,
      default: Date.now(),
    },
  });
  return mongoose.model('Subscription', subscriptionSchema);
};

```



```js
//Egg + Vue3开发视频网站\代码\youtubeclone-backend\app\model\user.js
// module.exports = app => {
//   const mongoose = app.mongoose; // 使用插件后,会自动添加到app 上
//   const Schema = mongoose.Schema; // 使用表

//   const UserSchema = new Schema({ // 创建表
//     userName: { type: String },
//     password: { type: String },
//   });
//   return mongoose.model('User', UserSchema); // User 表,UserSchema 字段  返回模型
// };

// app/model/user.js
module.exports = app => {
  const mongoose = app.mongoose;
  const Schema = mongoose.Schema;

  const userSchema = new Schema({
    username: { // 用户名
      type: String,
      required: true,
    },
    email: { // 邮箱
      type: String,
      required: true,
    },
    password: { // 密码
      type: String,
      select: false, // false 查询中,不包含该字段
      required: true,
    },
    avatar: { // 头像
      type: String,
      default: null,
    },
    cover: { // 封面
      type: String,
      default: null,
    },
    channelDescription: { // 频道介绍
      type: String,
      // required: true,
      default: null,
    },
    subscribersCount: { // 订阅频道的数量
      type: Number,
      default: 0,
    },
    createAt: { // 创建时间
      type: Date,
      default: Date.now(),
    },
    updateAt: { // 更新时间
      type: Date,
      default: Date.now(),
    },
  });
  return mongoose.model('User', userSchema);
};

```



```js
//Egg + Vue3开发视频网站\代码\youtubeclone-backend\app\model\video.js
// app/model/video.js
module.exports = app => {
  const mongoose = app.mongoose;
  const Schema = mongoose.Schema;
  const videoSchema = new Schema({
    title: { // 视频标题
      type: String,
      required: true,
    },
    description: { // 视频介绍
      type: String,
      required: true,
    },
    playUrl: { // 视频播放地址
      type: String,
      required: true,
    },
    cover: { // 视频封面
      type: String,
      required: true,
    },
    user: { // 视频作者
      type: mongoose.ObjectId,
      required: true,
      ref: 'User',
    },
    createAt: { // 创建时间
      type: Date,
      default: Date.now(),
    },
    updateAt: { // 更新时间
      type: Date,
      default: Date.now(),
    },
    commentCount: { // 评论数量
      type: Number,
      default: 0,
    },
    disLikesCount: { // 不喜欢的数量
      type: Number,
      default: 0,
    },
    likesCount: { // 喜欢的数量
      type: Number,
      default: 0,
    },
    viewCount: { // 观看的数量
      type: Number,
      default: 0,
    },
  });
  return mongoose.model('Video', videoSchema);
};

```



```js
//Egg + Vue3开发视频网站\代码\youtubeclone-backend\app\model\view.js
// app/model/view.js
module.exports = app => {
  const mongoose = app.mongoose;
  const Schema = mongoose.Schema;

  const viewSchema = new Schema({
    user: { // 用户
      type: mongoose.ObjectId,
      ref: 'User',
      required: true,
    },
    video: { // 频道
      type: mongoose.ObjectId,
      ref: 'Video',
      required: true,
    },
    createAt: { // 创建时间
      type: Date,
      default: Date.now(),
    },
    updateAt: { // 更新时间
      type: Date,
      default: Date.now(),
    },
  });
  return mongoose.model('View', viewSchema);
};

```



#### /app/service

```js
//Egg + Vue3开发视频网站\代码\youtubeclone-backend\app\service\user.js
// 简单来说，Service 就是在复杂业务场景下用于做业务逻辑封装的一个抽象层
const Service = require('egg').Service;
const jwt = require('jsonwebtoken');

class UserService extends Service {
  get User() {
    return this.app.model.User;
  }
  findByUsername(username) {
    return this.User.findOne({
      username,
    });
  }
  findByEmail(email) {
    return this.User.findOne({
      email,
    }).select('+password'); // 查询时,同时查询password 字段数据
  }
  async createUser(data) {
    const user = new this.User(data);
    user.password = this.ctx.helper.md5(data.password); // md5 需要额外的扩展 app/extend/helper.js 框架已经匹配了加载文件的规则
    await user.save(); // 使用模型model 保存到数据库中
    return user;
  }
  createToken(data) {
    // this.app.config.jwt.secret 使用config.default.js 中配置的密钥
    return jwt.sign(data, this.app.config.jwt.secret, {
      expiresIn: this.app.config.jwt.expiresIn, // 过期时间
    }); // 生成token 参数 数据,自定义私钥,过期时间
  }
  verifyToken(token) { // 验证token
    return jwt.verify(token, this.app.config.jwt.secret); // 解码userId 加密后的token 返回token 加密前的userId
  }
  updateUser(data) { // 更新用户资料
    return this.User.findByIdAndUpdate(this.ctx.user._id, data, {
      new: true, // 表示返回的是更新之后的数据,而不是更新之前的数据
    });
  }
  async subscribe(userId, channelId) { // 订阅频道
    const { Subscription, User } = this.app.model;
    // 1.检查是否已经订阅
    const record = await Subscription.findOne({
      user: userId,
      channel: channelId,
    });
    // console.log(record);
    const user = await User.findById(channelId);
    // 2.没有订阅,添加订阅
    // console.log(user);
    if (!record) {
      await new Subscription({
        user: userId,
        channel: channelId,
      }).save();
      // 更新用户的订阅数量
      user.subscribersCount++;
      await user.save(); // 更新到数据库中
    }
    // 3.返回用户信息
    return user;
  }
  async unsubscribe(userId, channelId) { // 取消订阅频道
    const { Subscription, User } = this.app.model;
    // 1.检查是否已经订阅
    const record = await Subscription.findOne({
      user: userId,
      channel: channelId,
    });
    // console.log(record);
    const user = await User.findById(channelId);
    // 2.如果有订阅,取消订阅
    // console.log(user);
    if (record) {
      await record.remove(); // 删除订阅记录
      // 更新用户的订阅数量
      user.subscribersCount--;
      await user.save(); // 更新到数据库中
    }
    return user;
  }
}

module.exports = UserService;

```



#### /app

```js
//Egg + Vue3开发视频网站\代码\youtubeclone-backend\app\router.js
'use strict';

/**
 * @param {Egg.Application} app - egg application
 */
module.exports = app => {
  const { router, controller } = app;
  const auth = app.middleware.auth();

  // router.get('/', controller.home.index);
  router.prefix('/api/v1'); // 设置基础路径
  // 注册
  router.post('/users', controller.user.create); // http://127.0.0.1:7002/api/v1/users
  // 登入
  router.post('/users/login', controller.user.login); // http://127.0.0.1:7002/api/v1/users/login
  // 获取当前登入用户
  router.get('/user', auth, controller.user.getCurrentUser); // 路径 要经过的中间件 控制器 http://127.0.0.1:7002/api/v1/user
  // 更新当前登入用户的资料
  router.patch('/user', auth, controller.user.update); // 路径 要经过的中间件 控制器 http://127.0.0.1:7002/api/v1/user
  // 获取用户资料 传递参数.使查看其他用户时,可以不用验证当前账号是否登入
  router.get('/user/:userId', app.middleware.auth({ required: false }), controller.user.getUser); // 路径 要经过的中间件 控制器 http://127.0.0.1:7002/api/v1/user/62d9097b03166e1c1cdea254


  // 订阅频道
  router.post('/user/:userId/subscribe', auth, controller.user.subscribe); // 路径 要经过的中间件 控制器 http://127.0.0.1:7001/api/v1/user/62d9097b03166e1c1cdea254/subscribe
  // 取消订阅频道
  router.delete('/user/:userId/subscribe', auth, controller.user.unsubscribe); // 路径 要经过的中间件 控制器 http://127.0.0.1:7001/api/v1/user/62d9097b03166e1c1cdea254/unsubscribe
  // 获取用户订阅的频道列表
  router.get('/user/:userId/subscriptions', auth, controller.user.getSubscriptions); // 路径 要经过的中间件 控制器 http://127.0.0.1:7001/api/v1/user/62d9097b03166e1c1cdea254/subscriptions
  // 创建视频-接口实现
  router.post('/videos', auth, controller.video.createVideo);
  // router.post('/videos', controller.video.createVideo);
  // 可以使用链式调用 router.get(...).post(...).get(...)
  // 获取视频详情-接口实现
  router.get('/videos/:videoId', app.middleware.auth({ required: false }), controller.video.getVideo);
  // 获取视频列表-接口实现
  router.get('/videos', controller.video.getVideos);
  // 获取用户发布的视频列表-接口实现
  router.get('/users/:userId/videos', controller.video.getUserVideos);
  // 获取用户关注的频道视频列表-接口实现
  router.get('/users/videos/feed', auth, controller.video.getUserFeedVideos);
  // 修改视频-接口实现
  router.patch('/videos/:videoId', auth, controller.video.updateVideos);
  // 删除视频-接口实现
  router.delete('/videos/:videoId', auth, controller.video.deleteVideos);
  // 添加视频评论-接口实现
  router.post('/videos/:videoId/comments', auth, controller.video.createComment);
  // 获取视频评论列表-接口实现
  router.get('/videos/:videoId/comments', controller.video.getVideoComments);
  // 删除视频评论-接口实现
  router.delete('/videos/:videoId/comments/:commentId', auth, controller.video.deleteVideoComments);
  // 喜欢视频-接口实现
  router.post('/videos/:videoId/like', auth, controller.video.likeVideo);
  // 不喜欢视频-接口实现
  router.post('/videos/:videoId/dislike', auth, controller.video.dislikeVideo);
  // 获取用户喜欢的视频列表-接口实现
  router.get('/user/videos/like', auth, controller.video.getUserLikedVideos);

};

```



#### /config/

```js
//Egg + Vue3开发视频网站\代码\youtubeclone-backend\config\config.default.js 默认配置
/* eslint valid-jsdoc: "off" */

'use strict';

/**
 * @param {Egg.EggAppInfo} appInfo app info
 */
module.exports = appInfo => {
  /**
   * built-in config
   * @type {Egg.EggAppConfig}
   **/
  const config = exports = {};

  // use for cookie sign key, should change to your own and keep security
  config.keys = appInfo.name + '_1657978081785_6636';

  // add your middleware config here
  config.middleware = [
    'errorHandler', // 添加自定义错误中间件,下划线需要改为驼峰命名
  ];

  // add your user config here
  const userConfig = {
    // myAppName: 'egg',
  };

  config.mongoose = {
    client: {
      url: 'mongodb://127.0.0.1/youtube-clone', // mongodb://127.0.0.1/example 地址 example 数据库
      options: {
        useUnifiedTopology: true,
      },
      plugins: [],
    },
  };

  config.security = { // 关闭 csrf 保护
    csrf: {
      enable: false,
    },
  };

  config.jwt = { // 配置token 的密钥
    secret: 'asdahdoiahdigyuiagdsk',
    expiresIn: '1d', // 过期时间1天
  };

  config.cors = {
    // origin: 'http:120.24.51.158', // 允许跨域的网址
    origin: '*', // 允许所有网址访问
    allowMethods: 'GET,HEAD', // 允许的请求方式
  };
  config.multipart = { // 配置文件上传接收
    mode: 'file',
    fileSize: 104857600, // 最大文件上传大小
  };

  return {
    ...config,
    ...userConfig,
  };
};

```



```js
//Egg + Vue3开发视频网站\代码\youtubeclone-backend\config\plugin.js
'use strict';

/** @type Egg.EggPlugin */
// module.exports = {
//   // had enabled by egg
//   // static: {
//   //   enable: true,
//   // }
// };

exports.mongoose = { // 使用mongoose 插件
  enable: true,
  package: 'egg-mongoose',
};

exports.validate = { // 使用验证器插件
  enable: true,
  package: 'egg-validate',
};
exports.cors = { // 配置跨域库
  enable: true,
  package: 'egg-cors',
};

```



#### /video

Egg + Vue3开发视频网站\代码\youtubeclone-backend\video

存放上传的视频文件

