## 取消订阅频道

#### 路由新增

```js
//Egg + Vue3开发视频网站\代码\youtubeclone-backend\app\router.js
// 取消订阅频道
router.delete('/user/:userId/subscribe', auth, controller.user.unsubscribe); // 路径 要经过的中间件 控制器 http://127.0.0.1:7001/api/v1/user/62d9097b03166e1c1cdea254/subscribe
```



#### 控制器新增

```js
//Egg + Vue3开发视频网站\代码\youtubeclone-backend\app\controller\user.js 
async unsubscribe() {
    const userId = this.ctx.user._id;
    const channelId = this.ctx.params.userId; // params.userId 获取路由中 /:userId/ 的值
    // 1.用户不能订阅自己
    if (userId.equals(channelId)) { // userid 是一个object 对象,不能直接比较,类型不一样
      this.ctx.throw(422, '用户不能取消订阅自己');
    }

    // 2.取消订阅
    const user = await this.service.user.unsubscribe(userId, channelId);
    // console.log(user);
    // 3.发送响应
    this.ctx.body = {
      user: {
        // ...user.toJSON(),
        ...this.ctx.helper._.pick(user, [ // 取出user 对象中指定的键的数据
          'username',
          'email',
          'avatar',
          'cover',
          'channelDescription',
          'subscribersCount',
        ]),
        isSubscribed: false, // 是否已订阅
      },
    };
  }
```



#### service 新增

```js
//Egg + Vue3开发视频网站\代码\youtubeclone-backend\app\service\user.js
async unsubscribe(userId, channelId) { // 取消订阅频道
    const { Subscription, User } = this.app.model;
    // 1.检查是否已经订阅
    const record = await Subscription.findOne({
      user: userId,
      channel: channelId,
    });
    // console.log(record);
    const user = await User.findById(channelId);
    // 2.如果有订阅,取消订阅
    // console.log(user);
    if (record) {
      await record.remove(); // 删除订阅记录
      // 更新用户的订阅数量
      user.subscribersCount--;
      await user.save(); // 更新到数据库中
    }
    return user;
  }
```

