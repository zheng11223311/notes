## 获取用户资料

#### 路由新增

```js
// 获取用户资料 传递参数.使查看其他用户时,可以不用验证当前账号是否登入
router.get('/user/:userId', app.middleware.auth({ required: false }), controller.user.getUser); // 路径 要经过的中间件 控制器 http://127.0.0.1:7002/api/v1/user/62d9097b03166e1c1cdea254

```



#### 修改 授权中间件

未登入用户也可以进行访问其他用户

```js
// 授权认证 中间件
module.exports = (options = { required: true }) => { // options 获取路由传递过来的参数
  return async (ctx, next) => {
    // 1.获取请求头中的token 数据
    let token = ctx.headers.authorization;
    token = token ? token.split('Bearer ')[1] : null; // 格式:Bearer +空格+ token 数据,这里截取并获取到token 数据
    // 2.验证 token ,无效返回 401

    if (token) {
      try {
        // 3.token 有效,根据userId 获取用户数据挂载到 ctx 对象中给后续中间件使用
        const data = ctx.service.user.verifyToken(token); // 使用service/auth.js 验证
        ctx.user = await ctx.model.User.findById(data.userId);
      } catch (error) {
        ctx.throw(401);
      }
    } else if (options.required) {
      ctx.throw(401);
    }


    // 4.next 执行后续中间件
    await next();
  };
};

```



#### 控制器新增

```js
  async getUser() {
    // 1.获取订阅状态
    let isSubscribed = false;
    if (this.ctx.user) { // 用户当前是否登入
      // 获取订阅记录
      const record = await this.app.model.Subscription({
        user: this.ctx.user._id,
        channel: this.ctx.params.userId,
      });
      if (record) {
        isSubscribed = true;
      }
    }
    // 2.获取用户信息
    const user = await this.app.model.User.findById(this.ctx.params.userId);
    // 3.发送响应
    this.ctx.body = {
      user: {
        // ...user.toJSON(),
        ...this.ctx.helper._.pick(user, [ // 取出user 对象中指定的键的数据
          'username',
          'email',
          'avatar',
          'cover',
          'channelDescription',
          'subscribersCount',
        ]),
        isSubscribed, // 是否已订阅
      },
    };
  }
```

