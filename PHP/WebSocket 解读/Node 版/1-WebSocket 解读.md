### 1.WebSocket 解读

> 1.Websocket 是什么?

WebSocket 是一种网络通信协议

WebSocket 是HTML5 开始提供的一种在单个TCP 连接上进行全双工通信的协议

> 2.为什么需要WebSocket?

初始接触WebSocket 的人,都会问同样的问题:我们已经有了HTTP 协议,为什么还需要另一个协议?它能带来什么好处?

答案很简单.因为HTTP 协议有一个缺陷:通信只能由客户端发起

举例来说:我们想要了解今天的天气,只能是客户端向服务器发出请求.服务器返回查询结果,HTTP 协议做不到服务器主动向客户端推送信息

传统的HTTP 协议是无状态的,每次请求(request) 都要由客户端(如浏览器)主动发起,服务端进行处理后返回response 结果,而服务端很难主动向客户端发送数据;这种客户端是主动方,服务端是被动方的传统Web 模式对于信息变化不频繁的Web 应用来说造成的麻烦较小,而对于涉及实时信息的Web 应用却带来了很大的不便,如带有即时通信,实时数据,订阅推送等功能的应用

**HTTP 的工作原理**

HTTP 协议定义Web 客户端如何从Web 服务器请求Web 页面,以及服务器如何把Web 页面传送给客户端,HTTP 协议采用了请求/响应模型,客户端向服务器发送一个请求报文,请求报文包含请求的方法,URL,协议版本,请求头部和请求数据,服务器以一个状态行作为响应,响应的内容包括协议的版本,成功或者错误代码,服务器信息,响应头部和响应数据

> 以下是HTTP 请求/响应的步骤:

1. 客户端连接到Web 服务器

   一个HTTP 客户端,通常是浏览器,与Web 服务器的HTTP 端口(默认为80),建立一个TCP 套接字连接,例如http://www.abc.com

2. 发送HTTP 请求

   通过TCP 套接字,客户端向Web 服务器发送一个文本的请求报文,一个请求报文由请求行,请求头部,空行和请求数据4部分组成

3. 服务器接受请求并返回HTTP 响应

   Web 服务器解析请求,定位请求资源,服务器将资源复本写到TCP 套接字,由客户端读取,一个响应由状态行,响应头部,空行和响应数据4部分组成

4. 释放TCP 连接

   若connection 模式为close,则服务器主动关闭TCP 连接,客户端被动关闭连接,释放TCP 连接,若connection 模式为keeplive ,则该连接会保持一段时间,在该时间内可以继续接收请求

5. 客户端浏览器解析HTML 内容

   客户端浏览器首先解析状态行,查看表明请求是否成功的状态码.然后解析每一个响应头,响应头告知一下为若干字节的HTML 文档和文档的字符集,客户端浏览器读取响应数据HTML,根据HTML 的语法对其进行格式化,并在浏览器窗口中显示

> 例如:在浏览器地址栏中键入URL ,按下回车之后会经历一下流程:

1. 浏览器向DNS 服务器请求解析该URL 中的域名所对应的IP 地址
2. 解析出IP 地址后,根据该IP 地址和默认端口80,和服务器建立TCP 连接
3. 浏览器发出读取文件(URL 中域名后面部分对应的文件)的HTTP 请求,该请求报文作为TCP 三次握手的第三个报文的数据发送给服务器
4. 释放TCP 连接
5. 浏览器将该HTML 文本解析并显示内容

**基于 请求-响应 的模式**

HTTP 西协议规定,请求从客户端发出,最后服务器端响应该请求并返回,换句话说,肯定是先从客户端开始建立通信的,服务器端在没有接收到请求之前不会发送响应

**无状态保存**

HTTP 是一种不保存状态,即无状态(stateless) 协议,HTTP 协议 自身不对请求和响应之间的通信状态进行保存,也就是说在HTTP 这个级别,协议对于发送过的请求或函数都不做持久化处理

### WebSocket 优势

相对于传统HTTP 每次请求-应答都需要客户端于服务器建立连接的模式,WebSocket 是类似Socket 的TCP 长连接通讯模式,一旦WebSocket 连接建立后,后续数据都以帧序列的形式传输,在客户端断开WebSocket 连接或Server 端中断连接前,不需要客户端和服务器端重新发起连接请求,在海量并发及客户端与服务器交互负载流量大的情况下,极大的节省了网络带宽资源的消耗,有明显的性能优势,且客户端发送和接收消息是在同一个持久连接上发起,实时性优势明显

> 实现方式(客户端)

WebSocket 需要像TCP 一样,先建立连接,需要客户端和服务端进行握手连接,连接成功后才能相互通信

> WebSocket 构造函数

WebSocket 对象作为一个构造函数,用于新建一个WebSocket 示例

```js
var ws=new WebSocket("ws://127.0.0.1:8090");		//ws 类似http ,wss 类似https
```

执行上面语句之后,客户端就会与服务器进行连接

> webSocket.readyState

`readstate` 属性返回实例对象的当前状态,共有四种

```
CONNECTION: 值为0,表示正常连接
OPEN: 值为1,表示连接成功,可以通信了
CLOSING: 值为2,表示连接正在关闭
CLOSED: 值为3,表示连接已经关闭,或者打开连接失败
```

> webSocket.onpoen

实例对象的`onopen` 属性,用于指定连接成功后的回调函数

```js
ws.onopen=function(){
	alert("webSocket 连接成功")
}
```

> webSocket.onerror

连接发生错误的回调方法

```js
ws.onerror=function(){
	alert("websocket 连接发生错误")
}
```

> webSocket.onmessage

实例对象的`onmessage` 属性,用于指定收到服务器数据后的回调函数

```js
ws.onmessage=function(data){
	alert(data)
}
```

> webSocket.onclose

实例对象的`onclose` 属性,用于指定连接关闭后的回调函数

```js
ws.onclose=function(){
	alert("websocket 连接关闭")
}
```

> webSocket.send()

实例对象的`send()` 方法用于向服务器发送数据

```js
ws.send("你的消息")
```

> 服务端

