### 验证码类的实现

魔术方法:__toString()

1. 触发时机:对一个对象进行echo 操作时自动触发
2. 功能:简化操作或者为对象输出值
3. 参数:无
4. 返回值:必须有,并且必须为字符串类型

```php
<?php
 class Computer{
    
    function __toString(){
        return '这是对象.不能echo'
    }
}

$obj=new Computer;
echo $obj; 	//这是对象.不能echo

?>

```



```php
<?php
 class Vcode{
     //成员属性
     private $width;
     private $height;
     private $codeNum;
     private $fontFile;
     //图像资源
     private $image;
     private $font;
    //  成员方法
    // 构造方法
    function __construct($fontFile='',$width=100,$height=40,$codeNum=4){
        //开启session 用于存储做好的验证码在外部校验
        session_start();
        $this->width=$width;
        $this->height=$height;
        $this->codeNum=$codeNum;
        $this->fontFile=$fontFile;
       

    }
    //实现创建画布的方法
    private function getCreateImg(){
        $this->image=imagecreatetruecolor($this->width,$this->height);
        //制作背景颜色
        $back=imagecolorallocate($this->image,mt_rand(200,255),mt_rand(200,255),mt_rand(200,255));
        //填充背景
         imagefill($this->image,0,0,$back);
         //分配边框颜色
         $borderColor=imagecolorallocate($this->image,255,0,0);
        //  为背景绘制边框
        imagerectangle($this->image,0,0,$this->width-1,$this->height-1,$borderColor);
    }
    //实现化干扰线
    private function setLine(){
        for ($i=0; $i <10 ; $i++) { 
            # 分配线的颜色
            $lineColor=imagecolorallocate($this->image,mt_rand(150,200),mt_rand(150,200),mt_rand(150,200));
            //循环画干扰线
            imageline($this->image,mt_rand(2,$this->width-2),mt_rand(2,$this->height-2),mt_rand(2,$this->width-2),mt_rand(2,$this->height-2),$lineColor);
        }
    }
    // 实现画干扰点
    private function setPixel(){
        for ($i=0; $i <300 ; $i++) { 
            # 分配干扰点的颜色
            $lineColor=imagecolorallocate($this->image,mt_rand(120,150),mt_rand(120,150),mt_rand(120,150));
            //循环画干扰点
            imagesetpixel($this->image,mt_rand(2,$this->width-2),mt_rand(2,$this->height-2),$lineColor);
        }
    }
    // 实现画验证码的方法
    private function setChar(){
        // 定义字
        $str='3456789abcdefghigklmnpqrstuvwsyz';
        //获取随机的四个文字并且保存到变量中
        for ($i=0; $i <$this->codeNum ; $i++) { 
            $this->font.=$str[mt_rand(0,strlen($str)-1)];
        }
        // 将文字写入到文件中
        if($this->fontFile==''){
            //没有传入字体文件,则使用系统内置字体
            for ($i=0; $i <strlen($this->font) ; $i++) { 
                $fontColor=imagecolorallocate($this->image,mt_rand(0,120),mt_rand(0,120),mt_rand(0,120));
                $x=$this->width/$this->codeNum*$i+mt_rand(3,8);
                $y=mt_rand(10,$this->height/2);
                imagechar($this->image,mt_rand(3,5),$x,$y,$this->font[$i],$fontColor);
            }
        }else{
            //使用用户指定的字体
            for ($i=0; $i <strlen($this->font) ; $i++) { 
                $fontColor=imagecolorallocate($this->image,mt_rand(0,120),mt_rand(0,120),mt_rand(0,120));
                $x=$this->width/$this->codeNum*$i+mt_rand(5,8);
                $y=mt_rand($this->height/2,$this->height);
                imagettftext($this->image,mt_rand($this->height/3,$this->height/2),mt_rand(2,40),$x,$y,$fontColor,$this->fontFile,$this->font[$i]);
            }
        }
    }
    // 告诉浏览器图像的相关信息
    private function outputImage(){
        header('Content-type:image/jpeg');
        imagejpeg($this->image);
    }
    // 释放资源,析构方法
    function __destruct(){
        imagedestroy($this->image);
    }
    
    function __toString(){
        $this->getCreateImg();
        $this->setLine();
        $this->setPixel();
        $this->setChar();
        $this->outputImage();
        $_SESSION['code']=$this->font;
        return '这是对象.不能echo';
    }
}

$obj=new Vcode('C:\wamp64\www\php\fontFamily\STCAIYUN.TTF');
echo $obj; 

?>



```

