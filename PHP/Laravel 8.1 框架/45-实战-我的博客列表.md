# 我的博客列表

## web.php 路由修改

```php
<?php


use App\Http\Controllers\Blogcontroller;
use App\Http\Controllers\CommentController;
use App\Http\Controllers\IndexController;
use App\Http\Controllers\UserController;
use App\Models\User;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Route;

// 用户认证中间件
// 需要登入的页面
// 中间件用户认证中间件是自带已经注册好的,可以直接使用
Route::middleware('auth')->group(function () {
    // 登入后,博客相关的路由
    Route::prefix('blog')->name('blog.')->group(function () {
        //改变博客的状态,发布与不发布
        //'/{id}  修改为 '/{id}/status 防止与更新的路由相同
        Route::patch('/{id}/status', [Blogcontroller::class, 'status'])
            ->name('status');
        //评论路由
        Route::post('/{id}/comment', CommentController::class)
            ->name('comment');
    });


    // 个人中心相关的路由
    // prefix 路由前缀,路径添加前缀
    // name('user.') 命名前缀,如果这里没有. 里面的所有路由命名前面都需要加上.
    Route::prefix('user')->name('user.')->group(function () {
        //个人中心-修改个人信息-页面
        Route::get('/', [UserController::class, 'infoPage'])
            // ->name('user.info');
            ->name('info');

        //个人中心-修改个人信息-更新数据
        Route::put('/', [UserController::class, 'infoUpdate'])
            ->name('info.update');

        //个人中心-头像-页面
        Route::get('/avatar', [UserController::class, 'avatarPage'])
            ->name('avatar');

        //个人中心-头像-更新数据
        Route::put('/avatar', [UserController::class, 'avatarUpdate'])
            ->name('avatar.update');

        //个人中心-所有博客
        Route::get('/blog', [UserController::class, 'blog'])
            ->name('blog');
    });
});



// 博客资源路由
// 定义博客资源路由,上面的基础路由可以去掉
Route::resource('blog', Blogcontroller::class)->except([
    'index',    //将此路由去除,首页使用自己定义的路由
]);

// 博客首页
Route::get('/', [IndexController::class, 'index'])->name('index');

// php artisan route:list 查看路由列表以及请求方式
```



## 模型

**添加模型关联**

`app\Models\User.php`

```php
<?php

namespace App\Models;

use Illuminate\Contracts\Auth\MustVerifyEmail;
use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Foundation\Auth\User as Authenticatable;
use Illuminate\Notifications\Notifiable;
use Laravel\Fortify\TwoFactorAuthenticatable;
use Laravel\Jetstream\HasProfilePhoto;
use Laravel\Sanctum\HasApiTokens;

class User extends Authenticatable
{
    use HasApiTokens;
    use HasFactory;
    use HasProfilePhoto;
    use Notifiable;
    use TwoFactorAuthenticatable;

    /**
     * The attributes that are mass assignable.
     *
     * @var string[]
     */
    protected $fillable = [
        'name',
        'email',
        'password',
    ];

    /**
     * The attributes that should be hidden for serialization.
     *
     * @var array
     */
    protected $hidden = [
        'password',
        'remember_token',
        'two_factor_recovery_codes',
        'two_factor_secret',
    ];

    /**
     * The attributes that should be cast.
     *
     * @var array
     */
    protected $casts = [
        'email_verified_at' => 'datetime',
    ];

    /**
     * The accessors to append to the model's array form.
     *
     * @var array
     */
    protected $appends = [
        'profile_photo_url',
    ];

    /**
     * 与博客作者发布的博客id 一对多对应
     */
    public function blogs()
    {
        return $this->hasMany(Blog::class,'user_id','id');
    }

}

```



## 控制器

完善修改博客状态和删除博客

`app\Http\Controllers\Blogcontroller.php`

```php
<?php

namespace App\Http\Controllers;

use App\Http\Requests\BlogRequest;
use App\Models\Blog;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\DB;

class Blogcontroller extends Controller
{

    /**
     * 实例化一个新的控制器实例
     *控制器中间件
     * @return void
     */
    public function __construct()
    {
        // middleware('') 使用空字符,会导致报错
        // Target class [] does not exist.
        // $this->middleware('');
        // 此控制器都使用auth 中间件,排除show 方法
        $this->middleware('auth')->except('show');
    }

    /**
     * 添加博客的页面
     */

    public function create()
    {
        // dd('添加博客的页面');
        return view('blog.create');
    }

    /**
     * 执行博客的添加
     * 使用表单验证器BlogRequest
     */
    public function store(BlogRequest $request)
    {
        //  dd('执行博客的添加');
        // 方式1:使用DB 构造器添加,不会维护创建字段和修改字段
        // 因为不是模型修改
        // $res=DB::table('blogs')->insert([
        //     // 'user_id'=>auth()->user()->id,   //或
        //     'user_id'=>auth()->id(),
        //     'title'=>$request->input('title'),
        //     'content'=>$request->input('content'),
        //     'category_id'=>$request->input('category_id')
        // ]);
        // dd($res);   //true


        // 方式2:使用模型对象添加
        // $blog=new Blog();
        // $blog->user_id=auth()->id();
        // $blog->title=$request->input('title');
        // $blog->content=$request->input('content');
        // $blog->category_id=$request->input('category_id');
        // $res=$blog->save();

        // 方式3: 使用批量添加
        // 需要在blog 模型类中设置允许批量添加
        // $res = Blog::create([
        //     'user_id' => auth()->id(),
        //     'title' => $request->input('title'),
        //     'content' => $request->input('content'),
        //     'category_id' => $request->input('category_id')
        // ]);

        // 方式4:用已存在的模型对象使用fill 进行快速添加
        // $blog = new Blog();
        // $blog->fill([
        //     'user_id' => auth()->id(),
        //     'title' => $request->input('title'),
        //     'content' => $request->input('content'),
        //     'category_id' => $request->input('category_id')
        // ]);
        // $res=$blog->save(); //注意:使用fill,要save(),才能添加到数据库

        // 方式5  ,使用$request->all(),适合大量字段添加
        //合并数组
        // dd(array_merge($request->except('_token'),['user_id'=>auth()->id()]));
        // 方式6,追加字段
        $request->offsetSet('user_id',auth()->id());
        // 在 除去token 然后批量添加
        $res = Blog::create($request->except('_token'));
        // dd($request->except('_token'));



        if ($res) {
            return back()->with(['success' => '博客添加成功!']);
        } else {
            // withInput 将用户提交的数据返回回去显示,防止添加失败后数据都没了
            return back()->withErrors('添加失败!')->withInput();
        }
    }

    /**
     * 查看一条博客的详情
     * 使用数据模型.根据传入的id 在数据表中进行查找id 对应的数据,返回给$blog
     */
    // public function show(Blog $blog)

    // 不使用模型.因为评论过多时,for 循环迭代查询,消耗性能,
    // 一次性查询出来,不用每次查询
    //使用预加载
    public function show($id)
    {
        // dd('查看一条博客的详情'.$id);
        // 访问 http://localhost:8000/blog/14

        // with 关联表模型中的comments 函数对应的表
        // with('comments') 所有评论
        // with('comments.user') 所有评论的 user
        $blog=Blog::with('comments.user')->where('id',$id)->first();

         // 禁用模型维护 更新 字段
        // 因为每次view 字段的修改会导致模型的维护,修改创建/更新时间
        $blog->timestamps=false;
        $blog->increment('view');   //每次访问show,浏览量增加1
       
        $blog->timestamps=true;     //在开启,就可以使用diffForHumans
        // dd($blog->timestamps);
        // 关闭维护会导致创建/更新时间字段变成普通的字段,不具有carbon 的功能
        // 不能使用 diffForHumans() 函数
        return view('blog.show',['blog'=>$blog]);
    }

    /**
     * 编辑页面
     */
    public function edit($id)
    {
        // dd('编辑页面'.$id);
        return view('blog.edit');
    }

    /**
     * 执行更新
     */
    public function update(Request $request, $id)
    {
        dd('执行更新' . $id);
    }

    /**
     * 删除博客
     * 使用blog 模型, $blog 需要与路由传递的变量名一致
     * blog 接收传递值,并查询数据库,返回结果到$blog 中
     */
    public function destroy(Blog $blog)
    {
        // dd($id);
        // dd('删除博客');
        $res=$blog->delete();
        if ($res) {
            return response()->api('删除成功!');
        } else {
            // withInput 将用户提交的数据返回回去显示,防止添加失败后数据都没了
            return response()->api('删除失败!',400);
        }
    }

    /**
     * 修改博客状态
     */
    public function status(Blog $id)
    {

        // dd('修改博客状态' . $id);
        // 临时禁用模型对时间的维护
        $id->timestamps=false;
        $id->status=$id->status==1?0:1;
        $res=$id->save();
        $id->timestamps=true;
        if ($res) {
            $msg=$id->status==1?'发布成功':'已取消发布';
            return response()->api($msg);
        } else {
            // withInput 将用户提交的数据返回回去显示,防止添加失败后数据都没了
            return response()->api('更新失败!',400);
        }
    }
}

```

优化所有博客的查询,按时间排序

`app\Http\Controllers\UserController.php`

```php
<?php

namespace App\Http\Controllers;

use App\Http\Requests\UserRequest;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Auth;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Storage;

class Usercontroller extends Controller
{
    /**
     * 用户界面
     */
    public function infoPage (){
        return view('user.info');
    }

    /**
     * 个人中心-修改个人信息-更新数据
     */

     
    // public function infoUpdate(Request $request)
    // 使用验证器UserRequest 
    // 自己定义的 UserRequest 继承FormRequest
    // 而FormRequest 继承Request
    // 所以在控制器中可以直接使用UserRequest 验证器
    // 包含继承的Request 所有方法
    public function infoUpdate(UserRequest $request)
    {
        // 表单验证器
        // $validatedData = $request->validate([
        //     // name 字段,必须|最小4位 |最大32 位
        //     'name' => 'required|min:4|max:32',
        //     // email 字段,必须 | 邮件格式
        //     'email' => 'required|email',
        // ],[
        //     // 自定义错误提示
        //     'name.required'=>'用户名必须填写',
        //     'name.min'=>'用户名最小4位数',
        //     'email.email'=>'邮箱必须位邮件格式'
        // ]);
        // validateWithBag 会将错误信息放到$errors 中
        // 所以可以直接使用@include('common.error') 显示(此文件内包含$errors)

        // 验证通过执行下方代码
    
        // dd('个人中心-修改个人信息-更新数据');
        // 有验证器,不需要下面的验证
        $name = $request->input('name');
        $email = $request->input('email');

        // $errors = [];
        // if (empty($name)) array_push($errors, '用户名不能为空!');
        // if (empty($email)) array_push($errors, '邮箱不能为空!');
        // if(!empty($errors)){
        //     return back()->withErrors($errors);
        // }


        // dd($name,$email);
        // 更新数据
        // 不能这么操作,会更新整个表,需要指定id
        // $re=DB::update(['name'=>$name,'email'=>$email]);
        // dd($re);

        // 获取用户ID
        // 使用auth 辅助函数
        // 当前登入用户
        // $uid=auth()->user()->id;
        // 或
        $uid = auth()->id();
        // 使用门面函数
        // $uid=Auth::user()->id;
        // $uid=Auth::id;
        // dd($uid);

        // 更新数据,没有做任何修改提交不会更新,并返回0
        $re = DB::table('users')
            ->where('id', $uid)
            ->update(['name' => $name, 'email' => $email]);
        // dd($re);

        //使用模型更新
        // 是一个Model 类型
        // dd(auth()->user());
        // $user=auth()->user();
        // // 修改
        // $user->name=$name;
        // $user->email=$email;
        // // 执行更新,没有做任何修改提交也会更新,并返回1
        // $re=$user->save();

        // dd($re);
        if ($re) {
            return back()->with(['success' => '更新数据成功!']);
            // 在 项目/resources/views/user/info.blade.php 中使用
        } else {
            // 错误收集在common.error 里面
            // 闪存到session 并放到$error 中
            return back()->withErrors('数据未做更新操作!');
            // return back()->withErrors(['数据未做更新操作!']);
        }
    }

    /**
     * 头像界面
     */
    public function avatarPage()
    {
       return view('user.avatar');
    }
  
  /**
   * 头像修改
   */
   public function avatarUpdate(Request $request){
       // 表单验证器
        $validatedData = $request->validate([
            'avatar' => 'required|image',
        ],[
            // 自定义错误提示
            'avatar.required'=>'请选择图片',
            'avatar.image'=>'请选择图片格式',
        ]);
        // validateWithBag 会将错误信息放到$errors 中
        // 所以可以直接使用@include('common.error') 显示(此文件内包含$errors)

    // dd($request);
    // 文件过大上传不了,修改php.ini
    $file=$request->file('avatar');
    if(!$file){
        return back()->withErrors('头像更新失败,请选择文件!');
    }
    // dd($file->isFile());
    // 文件过大也会上传失败
    if(!$file->isFile()){
        return back()->withErrors('头像更新失败,文件过大!');
    }
    // dd($file);
    // store 设置上传到的文件夹
    // $path=$file->store('avatar');
    // dd($path); //"avatar/d4T8lzV1IczL41hLooAxTGSXPv3kAESQMGnAy1LV.jpg"

    // 自定义文件名
    // $path=$file->storeAs('avatar','1.jpg');
    // dd($path); //"avatar/1.txt"

    // 指定磁盘,使用public 磁盘
    //  存储位置 项目/storage/app/public/avatar/
    $path=$file->store('avatar','public');
    // dd($path); //"avatar/1.txt"

    // 在更新之前获取用户原有的头像
    $oldAvatar=auth()->user()->avatar;

    // 更新当前登入用户的头像
    $uid=auth()->id();
    $res=DB::table('users')->where('id',$uid)->update(['avatar'=>$path]);
    // dd($res);
    if($res){
        // 用户头像更新成功之后,删除原有头像
        Storage::disk('public')->delete($oldAvatar);

        return back()->with(['success'=>'头像更新成功!']);
    }else{
        return back()->withErrors('头像更新失败!');
    }
    
   }

   /**
    * 所有博客
    */
    public function blog()
    {
        // 获取当前用户的所有博客
        // 使用user() 模型对应的blogs 函数对应的blogs 数据表查询
        // 这样放到模板后每次遍历都会进行查询数据库,消耗性能,
        // 所以需要一次性获取所有数据,在遍历
        // dd(auth()->user()->blogs);   

        // 查询用户的所有博客
        // withCount 获取与博客评论 comments 对应关系的数量,即获取博客评论数量
        // 会生成一个 comments_count 字段记录对应 comments 的数量
        // get 获取数据
        // $blogs=auth()->user()->blogs()->withCount('comments')->get();
        // 分页获取
        $blogs=auth()
        ->user()
        ->blogs()
        ->withCount('comments')
        ->orderBy('updated_at','desc')
        ->paginate(5);
        // dd($blogs);
        return view('user.blog',['blogs'=>$blogs]);
    }
    
}

```



## 模板

头部添加`csrf`跨域

`resources\views\layouts\header.blade.php`

```php
<html>
    <head>
        {{-- 在头部添加csrf 安全认证信息 --}}
        <meta name="csrf-token" content="{{ csrf_token() }}">
        <title>@yield('title','博客')</title>
        {{-- 引入文件  layouts/style.blade.php--}}
        @include('layouts.style')
    </head>
    <body>
        @include('layouts.header')
        <section>
            @yield('content','不存在content 这个片段时的默认内容')
        </section>
    
        @include('layouts.footer')
       @include('layouts.script')
    </body>
</html>
```

获取头部的跨域`token`,将其设置为`ajax`的全局,使以后的请求都带有`token`

`resources\views\layouts\script.blade.php`

```php
<script src="{{asset('js/jquery-3.6.0.min.js')}}"></script>
<script src="https://unpkg.com/@popperjs/core@2"></script>

<script>
    // ajax 全局设置
    $.ajaxSetup({
        // 获取头部的安全认证信息,为headers 添加认证
    headers: {
        'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')
    }
});
</script>


@yield('script')
```

完善所有博客的页面

`resources\views\user\blog.blade.php`

```php
@extends('layouts.app')

@section('title', '所有博客')

@section('style')
    <style>

    </style>
@endsection

@section('content')
    <div class="container mt-4">
        <div class="row">
            <div class="col-sm-3">
                @include('common.user-menu', ['nav' => 'blog'])
            </div>
            <div class="col-sm-9 p-0">
                <div class="card">
                    <div class="card-header bg-white fs-14">
                        所有博客
                    </div>
                    <div class="card-body">
                        @foreach ($blogs as $blog)
                            <div class="del-blog-parent blog-list border-bottom pb-3 mb-3">
                                <div class="">{{ $blog->title }}</div>
                                <div class="mt-2 d-flex justify-content-between">
                                    <div class="fs-14 text-muted">
                                        <span>时间 : {{ $blog->updated_at->diffForHumans() }}</span>
                                        <span>&nbsp;&nbsp; 浏览次数 : {{ $blog->view }}</span>
                                        <span> &nbsp;&nbsp;评论数 : {{ $blog->comments_count }}</span>
                                    </div>
                                    <div class="d-flex justify-content-end ">
                                        <div class="custom-control custom-switch mr-3">
                                            <input {{$blog->status==1?'checked':''}} data-url="{{route('blog.status',$blog)}}" type="checkbox" class="status-blog custom-control-input" id="status-{{$blog->id}}">
                                            <label class="custom-control-label text-muted " style="font-size: 14px" for="status-{{$blog->id}}">是否发布</label>
                                          </div>
                                        <a href="{{route('blog.edit',$blog)}}" class="btn btn-sm py-0 px-3 btn-primary">编辑</a>
                                        <a href="javascript:;" data-url="{{route('blog.destroy',$blog)}}" class="del-blog btn btn-sm py-0 px-3 btn-danger ml-2">删除</a>
                                    </div>
                                </div>
                            </div>
                        @endforeach
                        {{-- 使用分页 --}}
                        {{ $blogs->links() }}
                    </div>
                </div>
            </div>
        </div>
    </div>

@endsection
@section('script')
    <script>
        $(function(){
            /**
             * 删除博客
             * 
            */
           $('.del-blog').click(function(){
            //    console.log($(this));
               $.ajax({
                   url:$(this).data('url'),
                   type:'delete',
                   data:{},
                   dataType:'json',
                   success:(res)=>{
                    // console.log(res);
                    if(res.code==200){
                        // 使用提示
                        alert(res.msg)
                        // 让删除的这条从页面消失
                        // $(this).parent().parent().parent().hidden() 
                        // parents 多父级
                        $(this).parents('.del-blog-parent').remove()
                    }else{
                        alert(res.msg)
                    }
                   }
               })
           })

           /*
           *改变博客状态
           */
          $('.status-blog').change(function(){
            $.ajax({
                   url:$(this).data('url'),
                   type:'patch',
                   data:{},
                   dataType:'json',
                   success:(res)=>{
                    // console.log(res);
                    if(res.code==200){
                        // 使用提示
                        alert(res.msg)
                    }else{
                        alert(res.msg)
                    }
                   }
               })
          })

        })
    </script>
@endsection
```

