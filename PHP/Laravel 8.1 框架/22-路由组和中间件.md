# 路由组和中间件

参考手册 路由组  [路由 | 基础功能 |《Laravel 8 中文文档 8.x》| Laravel China 社区 (learnku.com)](https://learnku.com/docs/laravel/8.x/routing/9365#route-groups) 

参考手册 中间件    [中间件 | 基础功能 |《Laravel 8 中文文档 8.5》| Laravel China 社区 (learnku.com)](https://learnku.com/docs/laravel/8.5/middleware/10369) 



**掌握内容**

- 路由组
- 中间件配置
- 自定义中间件





# 路由组

 路由组允许你在大量路由之间共享路由属性，例如中间件，而不需要为每个路由单独定义这些属性。 

`项目/routes/web.php`

```php
// ...
// 子域名路由
Route::domain('blog2.test')->group(function(){
    Route::get('/domian',function(){
        //  匹配 blog2.test/domian
    });
});


// 路由前缀
Route::prefix('admin')->group(function () {
    Route::get('/users', function () {
        // 匹配 「/admin/users」URL
        // http://localhost:8000/admin/users
    });
});

//路由名称前缀
Route::name('admin.')->group(function () {
    Route::get('/orders', function () {
        // 访问 http://localhost:8000/orders
        dd(route('admin.orders'));  //"http://localhost:8000/orders"
        // 指定路由名称「admin.orders」...
        // 将所有路由命名添加一个前缀
        // 在name 定义的orders 上添加一个前缀
    })->name('orders');
});
```





# 中间件

中间件提供了一种方便的机制来过滤进入应用程序的 HTTP 请求。例如，Laravel 包含一个验证用户身份的中间件。如果用户未能通过认证，中间件会把用户重定向到登录页面。反之，用户如果通过验证，中间件将把请求进一步转发到应用程序中。

 当然，除了验证身份外，还可以编写其他的中间件来执行各种任务。例如：CORS 中间件可以负责为所有的应用返回的 responses 添加合适的响应头。日志中间件可以记录所有传入应用的请求。 

 Laravel 自带了一些中间件，包括身份验证、CSRF 保护等。所有的这些中间件都位于 `app/Http/Middleware` 目录。 



## 定义中间件

通过运行 `make:middleware` Artisan 命令来创建新的中间件：

```php
php artisan make:middleware CheckAge
    
#Middleware created successfully.
```

 此命令将在 `app/Http/Middleware` 目录中放置一个新的 `CheckAge` 类。在这个中间件中， 

```php
<?php

namespace App\Http\Middleware;

use Closure;
use Illuminate\Http\Request;

class CheckAge
{
    // 参数 request next 自定义的传参(在路由中传递)
    public function handle(Request $request, Closure $next,$id)
    {
        dd($id);	//输出路由向中间件传递的id
        if($request->age<=20){	//判断传递的值
            return redirect('/');
        }
        return $next($request);		//放行
    }
}

```



`项目/routes/web.php`

```php
// 路由组中间件
// 使用自己创建的中间件CheckAge
Route::middleware('check.age')->group(function () {
    Route::get('/users', function () {
        //    访问 http://localhost:8000/users
        //    访问 http://localhost:8000/users?age=22
        dd('age 大于20 显示此消息,小于20 重定向到/ 下');
    });
});

// 单个路由中间件
Route::get('/users1', function () {
    //    访问 http://localhost:8000/users1
    //    访问 http://localhost:8000/users1?age=22
    dd('age 大于20 显示此消息,小于20 重定向到/ 下.........');
})->middleware('check.age');
// 多个中间件使用,或者[]
// middleware('check.age','check.age1');
// middleware(['check.age','check.age1']);

// 向中间件传递参数 :后为参数
Route::get('/users2', function () {
    //    访问 http://localhost:8000/users2
    //    访问 http://localhost:8000/users2?age=22
    dd('age 大于20 显示此消息,小于20 重定向到/ 下....123124');
})->middleware('check.age:id1234');
// 中间件有参数时,上面无参的路由会失效报错,因为此时中间件需要3个参数
// 有一个传递的值参数


```



将中间件加入到配置中`项目/app/Http/Kernel.php`

```php
<?php

namespace App\Http;

use Illuminate\Foundation\Http\Kernel as HttpKernel;

class Kernel extends HttpKernel
{
    /**
     * The application's global HTTP middleware stack.
     *
     * These middleware are run during every request to your application.
     *
     * @var array
     */
    // 全局中间件
    protected $middleware = [
        // \App\Http\Middleware\TrustHosts::class,
        \App\Http\Middleware\TrustProxies::class,
        \Fruitcake\Cors\HandleCors::class,
        \App\Http\Middleware\PreventRequestsDuringMaintenance::class,
        \Illuminate\Foundation\Http\Middleware\ValidatePostSize::class,
        \App\Http\Middleware\TrimStrings::class,
        \Illuminate\Foundation\Http\Middleware\ConvertEmptyStringsToNull::class,
    ];

    /**
     * The application's route middleware groups.
     *
     * @var array
     */
    // 中间件组
    protected $middlewareGroups = [
        // 项目/app/Providers/RouteServiceProvider.php 默认将这些路由
        // 应用到 web.php 和api.php 
        // web.php 使用下面的这些中间件
        'web' => [
            \App\Http\Middleware\EncryptCookies::class,
            \Illuminate\Cookie\Middleware\AddQueuedCookiesToResponse::class,
            \Illuminate\Session\Middleware\StartSession::class,
            // \Illuminate\Session\Middleware\AuthenticateSession::class,
            \Illuminate\View\Middleware\ShareErrorsFromSession::class,
            \App\Http\Middleware\VerifyCsrfToken::class,    //开启csrf 安全机制
            \Illuminate\Routing\Middleware\SubstituteBindings::class,
        ],

        // api.php 使用下面的中间件
        'api' => [
            'throttle:api',
            \Illuminate\Routing\Middleware\SubstituteBindings::class,
        ],
    ];

    /**
     * The application's route middleware.
     *
     * These middleware may be assigned to groups or used individually.
     *
     * @var array
     */
    // 路由中间件
    protected $routeMiddleware = [
        // 中间件名称 =>使用的类
        'auth' => \App\Http\Middleware\Authenticate::class,
        'auth.basic' => \Illuminate\Auth\Middleware\AuthenticateWithBasicAuth::class,
        'cache.headers' => \Illuminate\Http\Middleware\SetCacheHeaders::class,
        'can' => \Illuminate\Auth\Middleware\Authorize::class,
        'guest' => \App\Http\Middleware\RedirectIfAuthenticated::class,
        'password.confirm' => \Illuminate\Auth\Middleware\RequirePassword::class,
        'signed' => \Illuminate\Routing\Middleware\ValidateSignature::class,
        'throttle' => \Illuminate\Routing\Middleware\ThrottleRequests::class,
        'verified' => \Illuminate\Auth\Middleware\EnsureEmailIsVerified::class,
        // 注册自己创建创建的中间件CheckAge
        // 使用.分割(直观), 也可以自定义其他名称
        // 在web.php 路由中可以使用此中间件
        'check.age' => \App\Http\Middleware\CheckAge::class,
    ];

    /**
     * 中间件的优先级排序列表
     *
     * 将会强制非全局中间件始终保持给定的顺序
     *
     * @var array
     */
    protected $middlewarePriority = [
        \Illuminate\Cookie\Middleware\EncryptCookies::class,
        \Illuminate\Session\Middleware\StartSession::class,
        \Illuminate\View\Middleware\ShareErrorsFromSession::class,
        \Illuminate\Contracts\Auth\Middleware\AuthenticatesRequests::class,
        \Illuminate\Routing\Middleware\ThrottleRequests::class,
        \Illuminate\Session\Middleware\AuthenticateSession::class,
        \Illuminate\Routing\Middleware\SubstituteBindings::class,
        \Illuminate\Auth\Middleware\Authorize::class,
    ];
}

```



**应用路由**

`项目/app/Providers/RouteServiceProvider.php`

```php
<?php

namespace App\Providers;

use Illuminate\Cache\RateLimiting\Limit;
use Illuminate\Foundation\Support\Providers\RouteServiceProvider as ServiceProvider;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\RateLimiter;
use Illuminate\Support\Facades\Route;

class RouteServiceProvider extends ServiceProvider
{
    /**
     * The path to the "home" route for your application.
     *
     * This is used by Laravel authentication to redirect users after login.
     *
     * @var string
     */
    public const HOME = '/user';	//定义登入成功后返回的页面

    /**
     * The controller namespace for the application.
     *
     * When present, controller route declarations will automatically be prefixed with this namespace.
     *
     * @var string|null
     */
    // protected $namespace = 'App\\Http\\Controllers';

    /**
     * Define your route model bindings, pattern filters, etc.
     *
     * @return void
     */
    public function boot()
    {
        $this->configureRateLimiting();
 		 // 项目/app/Providers/RouteServiceProvider.php 默认将这些路由
        // 应用到 web.php 和api.php 
        $this->routes(function () {
            Route::prefix('api')
                ->middleware('api')
                ->namespace($this->namespace)
                ->group(base_path('routes/api.php'));

            Route::middleware('web')
                ->namespace($this->namespace)
                ->group(base_path('routes/web.php'));
        });
    }

    /**
     * Configure the rate limiters for the application.
     *
     * @return void
     */
    protected function configureRateLimiting()
    {
        RateLimiter::for('api', function (Request $request) {
            return Limit::perMinute(60)->by(optional($request->user())->id ?: $request->ip());
        });
    }
}

```

