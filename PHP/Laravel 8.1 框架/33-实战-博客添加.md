# 博客添加

**创建博客模型**

```powershell
php artisan make:model Blog -m    #创建模型和迁移

#Model created successfully.
#Created Migration: 2022_05_17_061613_create_blogs_table
```

`app\Models\Blog.php`

```php
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Model;

class Blog extends Model
{
    use HasFactory;

    /**
     * 
     * 允许批量添加的字段
     */
    protected $fillable=[
        'user_id',
        'title',
        'content',
        'category_id',
    ];
}

```





`database\migrations\2022_05_17_061613_create_blogs_table.php`生成数据表

```php
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

class CreateBlogsTable extends Migration
{
    /**
     * Run the migrations.
     *
     * @return void
     */
    public function up()
    {
        // 创建表blogs
        Schema::create('blogs', function (Blueprint $table) {
            $table->id();
            // integer 整型数据
            $table->integer('user_id')->comment('用户id');
            $table->integer('category_id')->comment('分类id');
            $table->string('title')->comment('博客标题');
            // 文本类型
            $table->text('content')->comment('博客内容');
            // default 默认值 tinyInteger 小整型
            $table->tinyInteger('status')->default('1')->comment('博客状态: 0未发布 1发布');
            // 创建 创建时间 和 修改时间
            $table->timestamps();
        });
    }

    /**
     * Reverse the migrations.
     *
     * @return void
     */
    public function down()
    {
        Schema::dropIfExists('blogs');
    }
}

```

执行数据迁移,生成数据表

```powershell
php artisan migrate

#Migrating: 2022_05_17_061613_create_blogs_table
#Migrated:  2022_05_17_061613_create_blogs_table (5.20ms)
```





**修改模板**

添加`method`,`action`

`resources\views\blog\create.blade.php`

```php
//....
<form action="{{route('blog.store')}}" method="post">
                    @csrf
                    @include('common.error')
                    @include('common.success')
                    <div class="form-group">
                        <label for="exampleForControlInput1">标题</label>
                        {{-- old 获取添加失败时返回的数据 --}}
                        <input name="title" value="{{old('title')}}" type="text" class="form-control" id="exampleForControlInput1"/>
                    </div>
                    <div class="form-group">
                        <label for="exampleForControlSelect1">分类</label>
                        <select name="category_id" value="" type="password" class="form-control" id="exampleForControlSelect1">
                            <option value="0">请选择分类</option>
                            @foreach (categories() as $id=>$name)
                                <option {{old('category_id')==$id?'selected':''}} value="{{$id}}">{{$name}}</option>
                            @endforeach
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="exampleForControlTexteare1">内容</label>
                        {{-- textarea 没有value 属性,默认值只能写在 标签内 --}}
                        <textarea name="content"  class="form-control" id="exampleForControlTexteare1">{{old('content')}}</textarea>
                    </div>
                    <button class="btn btn-primary w-25 offset-4">发布</button>
                </form>
```



**创建表单验证器**

```powershell
php artisan make:request BlogRequest		#创建一个验证用户表单 BlogRequest 类

#Request created successfully.
```



`app\Http\Requests\BlogRequest.php`

```php
<?php

namespace App\Http\Requests;

use Illuminate\Foundation\Http\FormRequest;

class BlogRequest extends FormRequest
{
    public function authorize()
    {
        // 鉴定用户是否具有权限,比如更新评论的权限
        // 需要打开true,否则无法通过,返回419界面
        // 没有权限不能开启验证,打开才能开始验证
        // return false;
        return true;
    }


    // 书写规则
    // 自己定义的 UserRequest 继承FormRequest
    // 而FormRequest 继承Request
    // 所以在控制器中可以直接使用UserRequest 验证器
    // 包含继承的Request 所有方法
    public function rules()
    {
        return [
            'title'=>'required|min:4|max:32',
            'content'=>'required|min:4',
            'category_id'=>'required|gt:0', //gt 大于
        ];
    }

     // 自定义错误提示消息
     public function messages()
     {
         return [
            // 自定义错误提示
             'title.required'=>'标题必须填写',
             'title.min'=>'标题最少4 个字符',
             'title.max'=>'标题最大32 个字符',
             'content.required'=>'内容必须填写',
             'content.min'=>'内容最少4 个字符',
             'category_id.required'=>'分类必须填写',
             'category_id.gt'=>'分类必填',
         ];
     }
}

```



**资源控制器**

`app\Http\Controllers\Blogcontroller.php`

```php
<?php

namespace App\Http\Controllers;

use App\Http\Requests\BlogRequest;
use App\Models\Blog;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\DB;

class Blogcontroller extends Controller
{

    /**
     * 实例化一个新的控制器实例
     *控制器中间件
     * @return void
     */
    public function __construct()
    {
        // middleware('') 使用空字符,会导致报错
        // Target class [] does not exist.
        // $this->middleware('');
        // 此控制器都使用auth 中间件,排除show 方法
        $this->middleware('auth')->except('show');
    }

    /**
     * 添加博客的页面
     */

    public function create()
    {
        // dd('添加博客的页面');
        return view('blog.create');
    }

    /**
     * 执行博客的添加
     * 使用表单验证器BlogRequest
     */
    public function store(BlogRequest $request)
    {
        //  dd('执行博客的添加');
        // 方式1:使用DB 构造器添加,不会维护创建字段和修改字段
        // 因为不是模型修改
        // $res=DB::table('blogs')->insert([
        //     // 'user_id'=>auth()->user()->id,   //或
        //     'user_id'=>auth()->id(),
        //     'title'=>$request->input('title'),
        //     'content'=>$request->input('content'),
        //     'category_id'=>$request->input('category_id')
        // ]);
        // dd($res);   //true


        // 方式2:使用模型对象添加
        // $blog=new Blog();
        // $blog->user_id=auth()->id();
        // $blog->title=$request->input('title');
        // $blog->content=$request->input('content');
        // $blog->category_id=$request->input('category_id');
        // $res=$blog->save();

        // 方式3: 使用批量添加
        // 需要在blog 模型类中设置允许批量添加
        // $res = Blog::create([
        //     'user_id' => auth()->id(),
        //     'title' => $request->input('title'),
        //     'content' => $request->input('content'),
        //     'category_id' => $request->input('category_id')
        // ]);

        // 方式4:用已存在的模型对象使用fill 进行快速添加
        // $blog = new Blog();
        // $blog->fill([
        //     'user_id' => auth()->id(),
        //     'title' => $request->input('title'),
        //     'content' => $request->input('content'),
        //     'category_id' => $request->input('category_id')
        // ]);
        // $res=$blog->save(); //注意:使用fill,要save(),才能添加到数据库

        // 方式5  ,使用$request->all(),适合大量字段添加
        //合并数组
        // dd(array_merge($request->except('_token'),['user_id'=>auth()->id()]));
        // 方式6,追加字段
        $request->offsetSet('user_id',auth()->id());
        // 在 除去token 然后批量添加
        $res = Blog::create($request->except('_token'));
        // dd($request->except('_token'));



        if ($res) {
            return back()->with(['success' => '博客添加成功!']);
        } else {
            // withInput 将用户提交的数据返回回去显示,防止添加失败后数据都没了
            return back()->withErrors('添加失败!')->withInput();
        }
    }

    /**
     * 查看一条博客的详情
     */
    public function show($id)
    {
        // dd('查看一条博客的详情'.$id);
        return view('blog.show');
    }

    /**
     * 编辑页面
     */
    public function edit($id)
    {
        // dd('编辑页面'.$id);
        return view('blog.edit');
    }

    /**
     * 执行更新
     */
    public function update(Request $request, $id)
    {
        dd('执行更新' . $id);
    }

    /**
     * 删除博客
     */
    public function destroy($id)
    {
        dd('删除博客');
    }

    /**
     * 修改博客状态
     */
    public function status($id)
    {
        dd('修改博客状态' . $id);
    }
}

```

