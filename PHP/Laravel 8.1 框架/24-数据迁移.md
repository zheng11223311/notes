# 数据迁移

参考手册  [数据库迁移 | 数据库 |《Laravel 8 中文文档 8.5》| Laravel China 社区 (learnku.com)](https://learnku.com/docs/laravel/8.5/migrations/10406) 



**掌握内容**

- 生成迁移
- 运行迁移
- 迁移回滚
- 常用迁移方法



## 简介

> 迁移就像是对数据库进行的版本控制，让您的团队能够轻松地去定义和共享程序的数据库结构。如果团队中某个成员在他本地的数据库环境中手动的添加了某个字段，并且将更改提交到了源代码管理，那么您就面临数据库迁移所解决的问题。
>
> Laravel 的 Schema facade 提供了数据库相关的支持，可以在所有 Laravel 支持的数据库管理系统中创建和操作表。通常，迁移将使用此 Facade 创建和修改数据库的数据表和字段。
>







## 生成迁移

使用` make:migration` Artisan 命令 来创建迁移。新的迁移文件会放在 `database/migrations` 目录。所有的迁移文件名称都会包含一个时间戳，`Laravel `将据此决定迁移文件运行的顺序。

```powershell
php artisan make:migration create_photos_table			#生成迁移表 create_photos_table

#Created Migration: 2022_05_15_121249_create_photos_table
```

Laravel 将使用迁移的名称来尝试猜测数据表的名称，以及迁移是否将创建一个新的数据表。如果 Laravel 能够从迁移名称中确定数据表名，它将会用指定的数据表名预填充生成的迁移文件。否则，您只需手动指定迁移文件中的数据表。

如果要为生成的迁移指定自定义路径，您可以在执行` make:migration `命令时使用 --path 选项。给定的路径应该相对于应用程序的基本路径。

 迁移类包含两个方法：`up` 和 `down` 。`up` 方法用于向数据库中添加新表、列或索引，而 `down` 方法用于撤销 `up` 方法执行的操作。 



`项目/database/migrations/2022_05_15_121249_create_photos_table.php`

```php
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

class CreatePhotosTable extends Migration
{
    /**
     * Run the migrations.
     *
     * @return void
     */
    public function up()
    {
        // up 方法用于向数据库中添加新表、列或索引
        Schema::create('photos', function (Blueprint $table) {
            $table->id();   //指定生成id 字段
            $table->timestamps();   //指定生成 创建时间 和 修改时间 字段
        });
    }

    /**
     * Reverse the migrations.
     *
     * @return void
     */
    public function down()
    {
        // 而 down 方法用于撤销 up 方法执行的操作。
        Schema::dropIfExists('photos');
    }
}

```



## 运行迁移

执行 Artisan 命令 `migrate`，来运行所有未执行过的迁移：

```php
php artisan migrate
```

此时数据库会生成 `photos`表 和 对应的字段

数据库中的`migrations` 会记录我们执行迁移的记录,`id` 排序,`magration`字段记录执行的文件,`batch` 字段记录`magration`字段对应的文件运行迁移的执行的次数,回滚操作等都是基于这个表进行操作的

如果你想查看目前已经执行了哪些迁移，可以使用 Artisan 命令 `migrate:status`：

```php
php artisan migrate:status
```



### 在生产环境中执行强制迁移

有些迁移操作是破坏性的，这意味着它们可能会导致数据丢失。为了防止您对生产数据库运行这些命令，在执行这些命令之前，系统将提示您进行确认。如果要在运行强制命令的时候去掉提示，需要加上 --force 标志：

```powershell
php artisan migrate --force
```

**生产环境的配置**

在`项目/.env`文件中

```
APP_ENV=local			//本地环境
修改为
APP_ENV=production		//变成生产环境
```





### [回滚迁移](https://learnku.com/docs/laravel/8.5/migrations/10406#61b4f5)

 如果要回滚最后一次迁移操作，可以使用 Artisan 命令 `rollback`。该命令会回滚最后「一批」的迁移，这可能包含多个迁移文件： 

```powershell
php artisan migrate:rollback
```

通过向 `rollback` 命令加上 `step` 参数，可以回滚指定数量的迁移。例如，以下命令将回滚最后五个迁移：

```php
php artisan migrate:rollback --step=5
```

命令 `migrate:reset` 会回滚应用已运行过的所有迁移：

```php
php artisan migrate:reset		#相当于重置数据库
```

#### 使用单个命令同时进行回滚和迁移操作

命令 `migrate:refresh` 首先会回滚已运行过的所有迁移，随后会执行 `migrate`。这一命令可以高效地重建你的整个数据库：

```php
php artisan migrate:refresh

// 重置数据库，并运行所有的 seeds...
php artisan migrate:refresh --seed		//seed 为数据填充,以后会讲
```

通过在命令 refresh 中使用 step 参数，你可以回滚并重新执行指定数量的迁移操作。例如，下列命令会回滚并重新执行最后五个迁移操作：

```
php artisan migrate:refresh --step=5
```

**删除所有表然后执行迁移**
命令 `migrate:fresh `会删去数据库中的所有表，随后执行命令` migrate`：

```php
php artisan migrate:fresh

php artisan migrate:fresh --seed
```



**修改原有的迁移文件**

```php
php artisan make:migration add_title_to_photos_tables --table=photos		#向photos 表中添加字段title,--table=photos 指定表名,不写的话,则根据to 后面的表执行

#Created Migration: 2022_05_15_141655_add_title_to_photos_tables
#生成一个文件 
```

`项目/database/migrations/2022_05_15_141655_add_title_to_photos_tables.php`

```php
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

class AddTitleToPhotosTables extends Migration
{
    /**
     * Run the migrations.
     *
     * @return void
     */
    public function up()
    {
        // 修改表
        Schema::table('photos', function (Blueprint $table) {
            // 添加字段title
            $table->string('title')->comment('标题');
            // 创建索引
            //  $table->string('title')->comment('标题')->index();
            $table->index('title');
        });
    }

    /**
     * Reverse the migrations.
     *
     * @return void
     */
    public function down()
    {
        Schema::table('photos', function (Blueprint $table) {
            //
        });
    }
}

```



**执行迁移**

```php
php artisan migrate
```

数据库中`photos`表新增字段`title`

