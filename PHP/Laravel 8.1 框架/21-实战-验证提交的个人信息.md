# 验证提交的个人信息

**优化视图**

`项目/resources/views/user/info.blade.php`

添加错误提示

```php
                    <div class="card-body">
                        @include('common.error')
                        @include('common.success')

                        <form method="post" action="{{ route('user.info.update') }}" class="col-md-6 offset-3">
                            {{-- csrf 认证 --}}
                            @csrf
                            {{-- 使用 put 提交数据 --}}
                            {{-- <input type="hidden" name="_method" value="PUT"> --}}
                            {{-- 或使用method() --}}
                            @method('put')
                            {{-- csrf 和method 都是生成input hidden 的表单 --}}
                            <div class="form-group">
                                <label for="exampleInputName" class="fs-14 font-weight-bold">用户名</label>
                                <input type="text" name="name"
                                    class=" @error('name') is-invalid @enderror form-control form-control-sm"
                                    id="exampleInputName" value="{{ auth()->user()->name }}" aria-describedby="emailHelp"
                                    placeholder="请填写用户名" />
                                @error('name')
                                    {{-- 指定字段的错误验证提示 --}}
                                    {{-- 如果name 有错误的话,这里会显示 --}}
                                    {{-- invalid-feedback 类名是确定的,不能修改 --}}
                                    {{-- 关联的input 表单需要添加 is-invalid 类名,这个类名在input 中会显示错误提示符号 --}}
                                    {{-- 使用 @error('name') is-invalid  @enderror 判定在错误的时候显示 --}}
                                    <div class="invalid-feedback">
                                        {{ $message }}
                                    </div>
                                @enderror
                            </div>
                            <div class="form-group">
                                <label for="exampleInputEmail" class="fs-14 font-weight-bold">邮箱</label>
                                <input type="email" name="email" class=" @error('email') is-invalid @enderror form-control form-control-sm" id="exampleInputEmail"
                                    value="{{ auth()->user()->email }}" aria-describedby="emailHelp"
                                    placeholder="请填写用户名" />
                                @error('email')
                                    {{-- 指定字段的错误验证提示 --}}
                                    {{-- 如果email 有错误的话,这里会显示 --}}
                                    {{-- invalid-feedback 类名是确定的,不能修改 --}}
                                    {{-- 关联的input 表单需要添加 is-invalid 类名,这个类名在input 中会显示错误提示符号 --}}
                                    {{-- 使用 @error('email') is-invalid  @enderror 判定在错误的时候显示 --}}
                                    <div class="invalid-feedback">
                                        {{ $message }}
                                    </div>
                                @enderror
                            </div>
                            <button class="btn btn-primary w-25 offset-4">修改</button>
                        </form>
```



**创建自定义警告组件**

`项目/resources/views/common/warning.blade.php`

```php
@if (session('warning'))
<div class="alert alert-warning">
    {{session('warning')}}
</div>
@endif
```



**创建自定义成功组件**

`项目/resources/views/common/success.blade.php`

```php
@if (session('success'))
<div class="alert alert-success">
    {{session('success')}}
</div>
@endif
```



`项目/app/Http/Controllers/UserController.php` 头像修改 使用验证器类

```php
 /**
   * 头像修改
   */
   public function avatarUpdate(Request $request){
       // 表单验证器
        $validatedData = $request->validate([
            'avatar' => 'required|image',
        ],[
            // 自定义错误提示
            'avatar.required'=>'请选择图片',
            'avatar.image'=>'请选择图片格式',
        ]);
        // validateWithBag 会将错误信息放到$errors 中
        // 所以可以直接使用@include('common.error') 显示(此文件内包含$errors)

    // dd($request);
    // 文件过大上传不了,修改php.ini
    $file=$request->file('avatar');
    if(!$file){
        return back()->withErrors('头像更新失败,请选择文件!');
    }
    // dd($file->isFile());
    // 文件过大也会上传失败
    if(!$file->isFile()){
        return back()->withErrors('头像更新失败,文件过大!');
    }
    // dd($file);
    // store 设置上传到的文件夹
    // $path=$file->store('avatar');
    // dd($path); //"avatar/d4T8lzV1IczL41hLooAxTGSXPv3kAESQMGnAy1LV.jpg"

    // 自定义文件名
    // $path=$file->storeAs('avatar','1.jpg');
    // dd($path); //"avatar/1.txt"

    // 指定磁盘,使用public 磁盘
    //  存储位置 项目/storage/app/public/avatar/
    $path=$file->store('avatar','public');
    // dd($path); //"avatar/1.txt"

    // 在更新之前获取用户原有的头像
    $oldAvatar=auth()->user()->avatar;

    // 更新当前登入用户的头像
    $uid=auth()->id();
    $res=DB::table('users')->where('id',$uid)->update(['avatar'=>$path]);
    // dd($res);
    if($res){
        // 用户头像更新成功之后,删除原有头像
        Storage::disk('public')->delete($oldAvatar);

        return back()->with(['success'=>'头像更新成功!']);
    }else{
        return back()->withErrors('头像更新失败!');
    }
    
   }
```

