#  使用事件删除评论



## 控制器进行删除

`app\Http\Controllers\Blogcontroller.php`

```php
<?php

namespace App\Http\Controllers;

use App\Http\Requests\BlogRequest;
use App\Models\Blog;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\DB;

class Blogcontroller extends Controller
{

    /**
     * 实例化一个新的控制器实例
     *控制器中间件
     * @return void
     */
    public function __construct()
    {
        // middleware('') 使用空字符,会导致报错
        // Target class [] does not exist.
        // $this->middleware('');
        // 此控制器都使用auth 中间件,排除show 方法
        $this->middleware('auth')->except('show');
    }

    /**
     * 添加博客的页面
     */

    public function create()
    {
        // dd('添加博客的页面');
        return view('blog.create');
    }

    /**
     * 执行博客的添加
     * 使用表单验证器BlogRequest
     */
    public function store(BlogRequest $request)
    {
        //  dd('执行博客的添加');
        // 方式1:使用DB 构造器添加,不会维护创建字段和修改字段
        // 因为不是模型修改
        // $res=DB::table('blogs')->insert([
        //     // 'user_id'=>auth()->user()->id,   //或
        //     'user_id'=>auth()->id(),
        //     'title'=>$request->input('title'),
        //     'content'=>$request->input('content'),
        //     'category_id'=>$request->input('category_id')
        // ]);
        // dd($res);   //true


        // 方式2:使用模型对象添加
        // $blog=new Blog();
        // $blog->user_id=auth()->id();
        // $blog->title=$request->input('title');
        // $blog->content=$request->input('content');
        // $blog->category_id=$request->input('category_id');
        // $res=$blog->save();

        // 方式3: 使用批量添加
        // 需要在blog 模型类中设置允许批量添加
        // $res = Blog::create([
        //     'user_id' => auth()->id(),
        //     'title' => $request->input('title'),
        //     'content' => $request->input('content'),
        //     'category_id' => $request->input('category_id')
        // ]);

        // 方式4:用已存在的模型对象使用fill 进行快速添加
        // $blog = new Blog();
        // $blog->fill([
        //     'user_id' => auth()->id(),
        //     'title' => $request->input('title'),
        //     'content' => $request->input('content'),
        //     'category_id' => $request->input('category_id')
        // ]);
        // $res=$blog->save(); //注意:使用fill,要save(),才能添加到数据库

        // 方式5  ,使用$request->all(),适合大量字段添加
        //合并数组
        // dd(array_merge($request->except('_token'),['user_id'=>auth()->id()]));
        // 方式6,追加字段
        $request->offsetSet('user_id', auth()->id());
        // 在 除去token 然后批量添加
        $res = Blog::create($request->except('_token'));
        // dd($request->except('_token'));



        if ($res) {
            return back()->with(['success' => '博客添加成功!']);
        } else {
            // withInput 将用户提交的数据返回回去显示,防止添加失败后数据都没了
            return back()->withErrors('添加失败!')->withInput();
        }
    }

    /**
     * 查看一条博客的详情
     * 使用数据模型.根据传入的id 在数据表中进行查找id 对应的数据,返回给$blog
     */
    // public function show(Blog $blog)

    // 不使用模型.因为评论过多时,for 循环迭代查询,消耗性能,
    // 一次性查询出来,不用每次查询
    //使用预加载
    public function show($id)
    {
        // dd('查看一条博客的详情'.$id);
        // 访问 http://localhost:8000/blog/14

        // with 关联表模型中的comments 函数对应的表
        // with('comments') 所有评论
        // with('comments.user') 所有评论的 user
        $blog = Blog::with('comments.user')->where('id', $id)->first();

        // 禁用模型维护 更新 字段
        // 因为每次view 字段的修改会导致模型的维护,修改创建/更新时间
        $blog->timestamps = false;
        $blog->increment('view');   //每次访问show,浏览量增加1

        $blog->timestamps = true;     //在开启,就可以使用diffForHumans
        // dd($blog->timestamps);
        // 关闭维护会导致创建/更新时间字段变成普通的字段,不具有carbon 的功能
        // 不能使用 diffForHumans() 函数
        return view('blog.show', ['blog' => $blog]);
    }

    /**
     * 编辑页面
     */
    public function edit($id)
    {
        // dd('编辑页面'.$id);
        return view('blog.edit');
    }

    /**
     * 执行更新
     */
    public function update(Request $request, $id)
    {
        dd('执行更新' . $id);
    }

    /**
     * 删除博客
     * 使用blog 模型, $blog 需要与路由传递的变量名一致
     * blog 接收传递值,并查询数据库,返回结果到$blog 中
     */
    public function destroy(Blog $blog)
    {
        // dd($id);
        // dd('删除博客');
        // DB::beginTransaction();
        // try {
        //     // 删除博客
        //     $blog->delete();
        //     // 删除博客的相关评论
        //     $blog->comments()->delete();
        //     // 提交事务
        //     DB::commit();
        //     return response()->api('删除成功!');
        // } catch (\Exception $e) {
        //     // 回滚事务
        //     DB::rollBack();
        //     // withInput 将用户提交的数据返回回去显示,防止添加失败后数据都没了
        //     return response()->api('删除失败!', 400);
        // }

        // 使用模型事件,删除博客时,自动删除相关评论
        $res=$blog->delete();
        if($res){
            return response()->api('删除成功!');
        }else{
             // withInput 将用户提交的数据返回回去显示,防止添加失败后数据都没了
            return response()->api('删除失败!', 400);
        }
    }

    /**
     * 修改博客状态
     */
    public function status(Blog $id)
    {

        // dd('修改博客状态' . $id);
        // 临时禁用模型对时间的维护
        $id->timestamps = false;
        $id->status = $id->status == 1 ? 0 : 1;
        $res = $id->save();
        $id->timestamps = true;
        if ($res) {
            $msg = $id->status == 1 ? '发布成功' : '已取消发布';
            return response()->api($msg);
        } else {
            // withInput 将用户提交的数据返回回去显示,防止添加失败后数据都没了
            return response()->api('更新失败!', 400);
        }
    }
}

```



### 观察者类触发删除评论

`app\Observers\BlogObserver.php`

```php
<?php

namespace App\Observers;

use App\Models\Blog;

class BlogObserver
{
    
    public function created(Blog $blog)
    {
        //
    }

   
    public function updated(Blog $blog)
    {
        //
    }

   
    public function deleted(Blog $blog)
    {
        info('使用了观察者记录: 您删除了博客'.$blog->title);
        // 删除博客的时候,同时删除博客相关的评论
        $blog->comments()->delete();
    }

    
    public function restored(Blog $blog)
    {
        //
    }

   
    public function forceDeleted(Blog $blog)
    {
        //
    }
}

```



## 优化模板

为 所有博客 的标题添加链接 a 标签

`resources\views\user\blog.blade.php`

```php
@extends('layouts.app')

@section('title', '所有博客')

@section('style')
    <style>

    </style>
@endsection

@section('content')
    <div class="container mt-4">
        <div class="row">
            <div class="col-sm-3">
                @include('common.user-menu', ['nav' => 'blog'])
            </div>
            <div class="col-sm-9 p-0">
                <div class="card">
                    <div class="card-header bg-white fs-14">
                        所有博客
                    </div>
                    <div class="card-body">
                        @foreach ($blogs as $blog)
                            <div class="del-blog-parent blog-list border-bottom pb-3 mb-3">
                                <div class=""><a href="{{route('blog.show',$blog)}}" class="text-dark text-decoration-none">{{ $blog->title }}</a></div>
                                <div class="mt-2 d-flex justify-content-between">
                                    <div class="fs-14 text-muted">
                                        <span>时间 : {{ $blog->updated_at->diffForHumans() }}</span>
                                        <span>&nbsp;&nbsp; 浏览次数 : {{ $blog->view }}</span>
                                        <span> &nbsp;&nbsp;评论数 : {{ $blog->comments_count }}</span>
                                    </div>
                                    <div class="d-flex justify-content-end ">
                                        <div class="custom-control custom-switch mr-3">
                                            <input {{$blog->status==1?'checked':''}} data-url="{{route('blog.status',$blog)}}" type="checkbox" class="status-blog custom-control-input" id="status-{{$blog->id}}">
                                            <label class="custom-control-label text-muted " style="font-size: 14px" for="status-{{$blog->id}}">是否发布</label>
                                          </div>
                                        <a href="{{route('blog.edit',$blog)}}" class="btn btn-sm py-0 px-3 btn-primary">编辑</a>
                                        <a href="javascript:;" data-url="{{route('blog.destroy',$blog)}}" class="del-blog btn btn-sm py-0 px-3 btn-danger ml-2">删除</a>
                                    </div>
                                </div>
                            </div>
                        @endforeach
                        {{-- 使用分页 --}}
                        {{ $blogs->links() }}
                    </div>
                </div>
            </div>
        </div>
    </div>

@endsection
@section('script')
    <script>
        $(function(){
            /**
             * 删除博客
             * 
            */
           $('.del-blog').click(function(){
            //    console.log($(this));
               $.ajax({
                   url:$(this).data('url'),
                   type:'delete',
                   data:{},
                   dataType:'json',
                   success:(res)=>{
                    // console.log(res);
                    if(res.code==200){
                        // 使用提示
                        alert(res.msg)
                        // 让删除的这条从页面消失
                        // $(this).parent().parent().parent().hidden() 
                        // parents 多父级
                        $(this).parents('.del-blog-parent').remove()
                    }else{
                        alert(res.msg)
                    }
                   }
               })
           })

           /*
           *改变博客状态
           */
          $('.status-blog').change(function(){
            $.ajax({
                   url:$(this).data('url'),
                   type:'patch',
                   data:{},
                   dataType:'json',
                   success:(res)=>{
                    // console.log(res);
                    if(res.code==200){
                        // 使用提示
                        alert(res.msg)
                    }else{
                        alert(res.msg)
                    }
                   }
               })
          })

        })
    </script>
@endsection
```



头部添加发布博客的链接

`resources\views\layouts\header.blade.php`

```php
<header class="header">
    <div class="container bg-light d-flex justify-content-between align-items-center">
        <div class="d-flex">
            <a class="logo" href="{{ route('index') }}">Laravel</a>
            {{-- ml-3 margin-left 3格 --}}
            <form action="{{route('index')}}" class="form-inline my-2 my-lg-0 ml-3">
                <input name="keyword" value="{{request()->query('keyword')}}" class="form-control form-control-sm" type="search" placeholder="搜索" />
                <select name="category_id"  type="password" class="form-control form-control-sm ml-2">
                    <option value="0">请选择分类</option>
                    @foreach (categories() as $id=>$name)
                        <option {{request()->query('category_id')==$id?'selected':''}} value="{{$id}}">{{$name}}</option>
                    @endforeach
                </select>
                <button class="btn btn-sm btn-outline-success ml-2 " type="submit">搜索</button>
            </form>
        </div>
        <div class="right-bth">
            @auth
                {{-- 以登入显示的界面 --}}
                <a href="{{ route('user.info') }}" class="text-dark mr-3 text-decoration-none">
                    {{-- asset 指向 项目/public 文件,下 而public 文件夹的storage 是个软连接指向 项目/storage/app/public/下的文件 --}}
                    <img width="30" height="30"
                        src="{{ auth()->user()->avatar ? asset('storage/' . auth()->user()->avatar) : 'https://t7.baidu.com/it/u=1595072465,3644073269&fm=193&f=GIF' }}"
                        alt="" class="rounded-pill">
                    <span>{{ auth()->user()->name }}</span>
                </a>
                <a href="{{ route('blog.create') }}" class="text-dark mr-3 text-decoration-none">
                    {{-- asset 指向 项目/public 文件,下 而public 文件夹的storage 是个软连接指向 项目/storage/app/public/下的文件 --}}
                   发布博客
                </a>
                <form method="post" action="{{ route('logout') }}" class="d-inline" id="logout">
                    @csrf
                    <a href="javascript:;" onclick="document.getElementById('logout').submit()"
                        class="text-dark text-decoration-none">退出</a>
                </form>
            @else
                {{-- 未登入显示的界面 --}}

                <a href="{{ route('login') }}" class="btn  btn-sm btn-primary">登入</a>
                <a href="{{ route('register') }}" class="btn  btn-sm btn-outline-success ml-2">注册</a>
            @endauth
        </div>
    </div>
</header>

```



文章展示时,当前文章是当前作者的文章,显示编辑按钮

`resources\views\blog\show.blade.php`

```php
@extends('layouts.app')

@section('title', '博客详情')

@section('style')
    {{-- <link rel="stylesheet" href="{{ asset('css/markdown.css') }}"> --}}
    <style>
        .replay:last-child {
            border-bottom: none !important;
        }

    </style>
@endsection

@section('content')
    <div class="container mt-5">
        <div class="row ">
            <div class="col-sm-9">
                <div class="card">
                    {{-- 如果本文章是自己的,可以编辑内容 --}}
                    @if(auth()->id()==$blog->user_id)
                    <div class="text-right">
                        <a href="{{route('blog.edit',$blog)}}" class="btn btn-primary btn-sm">编辑</a>
                    </div>
                    @endif
                    <div class="card-body">
                        <h3 class="font-weight-light text-center mb-3">{{ $blog->title }}</h3>
                        <div class="text-center fs-14 text-muted">
                            <span class="mr-2">时间: {{ $blog->updated_at->diffForHumans() }}</span>
                            <span class="mr-2">浏览次数: {{ $blog->view }}</span>
                        </div>
                    </div>
                    <div class="content  p-0">
                        {{ $blog->content }}
                    </div>
                </div>

                <div class="card mt-4">
                    <div class="card-header bg-white fs-14">
                        回复数量
                    </div>
                    <div class="card-body" id="comment-list">
                        {{-- 存在数据则迭代 --}}
                        @forelse ($blog->comments as $comment)
                        {{-- {{$comment->user[0]['avatar']}} --}}
                            <div class="media mb-3 border-bottom pb-3 replay">
                                <img style="border-radius: 50%" width="50" height="50"
                                    src="{{ $comment->user[0]['avatar'] ? asset('storage/' . $comment->user[0]['avatar'] ) : 'https://t7.baidu.com/it/u=1595072465,3644073269&fm=193&f=GIF' }}" />
                                <div class="media-body" style="display: inline-block">
                                    <h5 class="mt-0">{{ $comment->user[0]->name }}</h5>
                                    {{-- <h5 class="mt-0">{{$comment->user->name}}</h5> --}}
                                    {{ $comment->content }}
                                </div>
                            </div>

                            {{-- 如果数据为空 --}}
                        @empty  
                            {{-- py 上下间距  text-muted 字体颜色偏灰 text-center 居中 --}}
                            <div id="empty" class="text-center py-3 text-muted">暂无评论...</div>
                        @endforelse

                    </div>
                </div>

                @auth
                    <div class="card mt-4">
                        <div class="card-body pb-9">
                            <form id="form-comment" action="{{ route('blog.comment', $blog->id) }}">
                                @csrf
                                <div class="form-group">
                                    <textarea name="content" class="form-control" id="" cols="30" rows="10"></textarea>
                                </div>
                                <div class="text-right">
                                    <button id="btn-comment" type="button"
                                        class="btn btn-primary btn-sm py-1 px-4 ml-3">评论</button>
                                </div>
                            </form>
                        </div>
                    </div>
                @else
                    <div class="card mt-4">
                        <div class="card-body pb-2">
                            <div class="alert alert-warning" role="alert">
                                您还没有登入,请登入!
                                <a href="{{route('login') }}" class="btn btn-primary btn-sm py-1 px-4 ml-3">
                                    马上登入
                                </a>
                            </div>
                        </div>
                    </div>
                @endauth
            </div>
            <div class="col-sm-3 p-0">
                @include('common.right-card', [
                    'imgUrl' =>
                        'https://www4.bing.com//th?id=OHR.SwedishAntenna_ZH-CN9163420082_1920x1080.jpg&rf=LaDigue_1920x1080.jpg&pid=hp&w=240&h=135',
                    'title' => $blog->category->name,
                    'content' => '收录了 ' . $blog->category->name . ' 相关的文章',
                    'count' => $blog->category->blogs()->count(), //blog 获取关联的category 模型的php 分类,category 获取与php 分类关联的blog 模型的count 数量
                    'category_id' => $blog->category_id,
                ])
            </div>
        </div>

    </div>
@endsection

@section('script')
    <script>
        $(function() {
            let form = $('#form-comment')
            // console.log(form.serialize());  //串行化,form  表单提交的数据
            // _token=a7tOqzGbaiHEI91JTL2HaHa3KxEnQwiPkjzoSfT5&content=
            // return
            console.log(form.attr('action'));
            $('#btn-comment').click((e) => {
                e.preventDefault();
                e.stopPropagation();
                $.ajax({
                    url: form.attr('action'),
                    type: "post",
                    data: form.serialize(),
                    dataType: 'json',
                    success: (res) => {
                        console.log(res);
                        if (res.code == 200) {
                            // alert(res.msg)
                            // 评论成功之后,评论内容显示到评论列表里面
                            $('#comment-list').append(`
                            <div class="media mb-3 border-bottom pb-3 replay">
                                <img style="border-radius: 50%" width="50" height="50"
                                    src="${'/storage/'+res.data.avatar_url}" />
                                <div class="media-body" style="display: inline-block">
                                    <h5 class="mt-0">${res.data.user_name}</h5>
                                   ${ res.data.content}
                                </div>
                            </div>
                            `)
                            // 清空输入框的内容
                            $('textarea[name="content"]').val('');
                            // 隐藏为无评论的提示
                            $('#empty').hide();
                        } else {
                            alert(res.msg)
                        }
                    }
                })
            })
        })
    </script>
@endsection

```

