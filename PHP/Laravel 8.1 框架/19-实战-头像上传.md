# 头像上传



`项目/app/Http/Controllers/UserController.php`

```php
<?php

namespace App\Http\Controllers;

use Illuminate\Http\Request;
use Illuminate\Support\Facades\Auth;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Storage;

class Usercontroller extends Controller
{
    /**
     * 用户界面
     */
    public function infoPage (){
        return view('user.info');
    }

    /**
     * 个人中心-修改个人信息-更新数据
     */
    public function infoUpdate(Request $request)
    {
        // dd('个人中心-修改个人信息-更新数据');
        $name = $request->input('name');
        $email = $request->input('email');

        $errors = [];
        if (empty($name)) array_push($errors, '用户名不能为空!');
        if (empty($email)) array_push($errors, '邮箱不能为空!');
        if(!empty($errors)){
            return back()->withErrors($errors);
        }


        // dd($name,$email);
        // 更新数据
        // 不能这么操作,会更新整个表,需要指定id
        // $re=DB::update(['name'=>$name,'email'=>$email]);
        // dd($re);

        // 获取用户ID
        // 使用auth 辅助函数
        // 当前登入用户
        // $uid=auth()->user()->id;
        // 或
        $uid = auth()->id();
        // 使用门面函数
        // $uid=Auth::user()->id;
        // $uid=Auth::id;
        // dd($uid);

        // 更新数据,没有做任何修改提交不会更新,并返回0
        $re = DB::table('users')
            ->where('id', $uid)
            ->update(['name' => $name, 'email' => $email]);
        // dd($re);

        //使用模型更新
        // 是一个Model 类型
        // dd(auth()->user());
        // $user=auth()->user();
        // // 修改
        // $user->name=$name;
        // $user->email=$email;
        // // 执行更新,没有做任何修改提交也会更新,并返回1
        // $re=$user->save();

        // dd($re);
        if ($re) {
            return back()->with(['success' => '更新数据成功!']);
            // 在 项目/resources/views/user/info.blade.php 中使用
        } else {
            // 错误收集在common.error 里面
            // 闪存到session 并放到$error 中
            return back()->withErrors('数据未做更新操作!');
            // return back()->withErrors(['数据未做更新操作!']);
        }
    }

    /**
     * 头像界面
     */
    public function avatarPage()
    {
       return view('user.avatar');
    }
  
  /**
   * 头像修改
   */
   public function avatarUpdate(Request $request){
    // dd($request);
    // 文件过大上传不了,修改php.ini
    $file=$request->file('avatar');
    if(!$file){
        return back()->withErrors('头像更新失败,请选择文件!');
    }
    // dd($file->isFile());
    // 文件过大也会上传失败
    if(!$file->isFile()){
        return back()->withErrors('头像更新失败,文件过大!');
    }
    // dd($file);
    // store 设置上传到的文件夹
    // $path=$file->store('avatar');
    // dd($path); //"avatar/d4T8lzV1IczL41hLooAxTGSXPv3kAESQMGnAy1LV.jpg"

    // 自定义文件名
    // $path=$file->storeAs('avatar','1.jpg');
    // dd($path); //"avatar/1.txt"

    // 指定磁盘,使用public 磁盘
    //  存储位置 项目/storage/app/public/avatar/
    $path=$file->store('avatar','public');
    // dd($path); //"avatar/1.txt"

    // 在更新之前获取用户原有的头像
    $oldAvatar=auth()->user()->avatar;

    // 更新当前登入用户的头像
    $uid=auth()->id();
    $res=DB::table('users')->where('id',$uid)->update(['avatar'=>$path]);
    // dd($res);
    if($res){
        // 用户头像更新成功之后,删除原有头像
        Storage::disk('public')->delete($oldAvatar);

        return back()->with(['success'=>'头像更新成功!']);
    }else{
        return back()->withErrors('头像更新失败!');
    }
    
   }

   /**
    * 所有博客
    */
    public function blog()
    {
        return view('user.blog');
    }
    
}

```



因为之前创建数据迁移没有头像的字段,创建头像相关的字段

```powershell
php artisan make:migration add_avatar_to_users --table=users		#创建迁移文件,格式add_avatar_to_users,表示向users 添加avatar 字段,--table 指定表明

#Created Migration: 2022_05_14_114022_add_avatar_to_users
```

在`项目/database/migrations/`生成一个`2022_05_14_114022_add_avatar_to_users.php` 文件,修改其中`up`的内容为

```php
 public function up()
{
        Schema::table('users', function (Blueprint $table) {
            // 向表中的avatar 字段添加备注 用户头像
            $table->string('avatar')->comment('用户头像');
        });
    }
```



**执行迁移**

```powershell
php artisan migrate		#执行后数据库才会新增这个字段

#Migrating: 2019_12_14_000001_create_personal_access_tokens_table
#Migrated:  2019_12_14_000001_create_personal_access_tokens_table (12.83ms)
#Migrating: 2022_05_14_114022_add_avatar_to_users
#Migrated:  2022_05_14_114022_add_avatar_to_users (4.84ms)
```



修改`项目/resources/views/layouts/header.blade.php` 头像上传部分的代码

```php
 @auth
                {{-- 以登入显示的界面 --}}
                <a href="{{ route('user.info') }}" class="text-dark mr-3 text-decoration-none">
                    {{-- asset 指向 项目/public 文件,下 而public 文件夹的storage 是个软连接指向 项目/storage/app/public/下的文件 --}}
                    <img width="30" height="30"
                        src="{{ auth()->user()->avatar ? asset('storage/' . auth()->user()->avatar) : 'https://t7.baidu.com/it/u=1595072465,3644073269&fm=193&f=GIF' }}"
                        alt="" class="rounded-pill">
                    <span>{{ auth()->user()->name }}</span>
                </a>
                <form method="post" action="{{ route('logout') }}" class="d-inline" id="logout">
                    @csrf
                    <a href="javascript:;" onclick="document.getElementById('logout').submit()"
                        class="text-dark text-decoration-none">退出</a>
                </form>
            @else
```



`项目/resources/views/layouts/avatar.blade.php`

```php
@extends('layouts.app')

@section('title', '修改头像')

@section('style')
    <style>

    </style>
@endsection

@section('content')
    <div class="container mt-4">
        <div class="row">
            <div class="col-sm-3">
                @include('common.user-menu',['nav'=>'avatar'])
            </div>
            <div class="col-sm-9 p-0">
                <div class="card">
                    <div class="card-header bg-white fs-14">
                        修改头像
                    </div>
                    @include('common.error')
                    @include('common.success')
                    <div class="card-body">
                        <form method="post" action="{{route('user.avatar.update')}}" enctype="multipart/form-data" class="col-md-6 offset-3">
                            @method('put')
                            @csrf
                            <div class="form-group">
                                <label for="exampleFormControlFile1" class="fs-14 font-weight-bold">请选择头像上传</label>
                                <input type="file" name="avatar" class="form-control form-control-sm" id="exampleFormControlFile1"  />
                            </div>
                            <button type="submit" class="btn btn-primary w-25 offset-4">修改</button>
                            {{-- <button>修改</button> --}}
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
@endsection
```

