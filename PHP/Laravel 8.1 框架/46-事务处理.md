# 事务处理

参考手册  [快速入门 | 数据库 |《Laravel 8 中文文档 8.x》| Laravel China 社区 (learnku.com)](https://learnku.com/docs/laravel/8.x/eloquent/9400#database-transactions) 



**掌握内容**

- 使用事务



你可以使用 `DB facade` 的 `transaction `方法在数据库事务中运行一组操作。如果事务的闭包 `Closure `中出现一个异常，事务将会回滚。如果事务闭包 `Closure` 执行成功，事务将自动提交。一旦你使用了 `transaction`， 就不必担心手动回滚或提交的问题：

```
DB::transaction(function () {
    DB::table('users')->update(['votes' => 1]);

	DB::table('posts')->delete();

});


```



## 手动使用事务

如果你想要手动开始一个事务，并且对回滚和提交能够完全控制，那么你可以使用` DB Facade` 的 `beginTransaction `方法：

```
DB::beginTransaction();
```

你可以使用 `rollBack `方法回滚事务：

```
DB::rollBack();
```

最后，你可以使用 `commit `方法提交事务：

```
DB::commit();
```

技巧：`DB` facade 的事务方法同样适用于 [查询构造器](https://learnku.com/docs/laravel/8.x/queries) 和 [Eloquent ORM](https://learnku.com/docs/laravel/8.x/eloquent)。





## 创建一个单函数控制器用于测试

```powershell
php artisan make:controller Test10Controller --invokable

#Controller created successfully.
```



`项目/routes/web.php`

```php
<?php
    
use App\Http\Controllers\Test10Controller;
use Illuminate\Support\Facades\Route;

Route::get('/test10',Test10Controller::class);
// Route::get('/test10/{id}',Test10Controller::class);
```



`项目/app/Http/Controllers/Test10Controller.php`

```php
<?php

namespace App\Http\Controllers;

use Illuminate\Http\Request;
use Illuminate\Support\Facades\DB;

class Test10Controller extends Controller
{

    public function __invoke(Request $request)
    {
        // 使用事务处理
        // DB::transaction(function () {
        //     DB::table('users')->update(['votes' => 1]);
        
        //     DB::table('posts')->delete();
        
        // });

        // 手动使用事务
        DB::beginTransaction();

        try{
            //.......
            DB::commit();
        }catch(\Exception $e){
            // 回滚
            DB::rollBack();
        }
    }
}

```

