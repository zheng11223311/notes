# 搜索并维持分页



**优化界面**

`resources\views\layouts\header.blade.php`

```php
<header class="header">
    <div class="container bg-light d-flex justify-content-between align-items-center">
        <div class="d-flex">
            <a class="logo" href="{{ route('index') }}">Laravel</a>
            {{-- ml-3 margin-left 3格 --}}
            <form action="{{route('index')}}" class="form-inline my-2 my-lg-0 ml-3">
                <input name="keyword" value="{{request()->query('keyword')}}" class="form-control form-control-sm" type="search" placeholder="搜索" />
                <select name="category_id"  type="password" class="form-control form-control-sm ml-2">
                    <option value="0">请选择分类</option>
                    @foreach (categories() as $id=>$name)
                        <option {{request()->query('category_id')==$id?'selected':''}} value="{{$id}}">{{$name}}</option>
                    @endforeach
                </select>
                <button class="btn btn-sm btn-outline-success ml-2 " type="submit">搜索</button>
            </form>
        </div>
        <div class="right-bth">
            @auth
                {{-- 以登入显示的界面 --}}
                <a href="{{ route('user.info') }}" class="text-dark mr-3 text-decoration-none">
                    {{-- asset 指向 项目/public 文件,下 而public 文件夹的storage 是个软连接指向 项目/storage/app/public/下的文件 --}}
                    <img width="30" height="30"
                        src="{{ auth()->user()->avatar ? asset('storage/' . auth()->user()->avatar) : 'https://t7.baidu.com/it/u=1595072465,3644073269&fm=193&f=GIF' }}"
                        alt="" class="rounded-pill">
                    <span>{{ auth()->user()->name }}</span>
                </a>
                <form method="post" action="{{ route('logout') }}" class="d-inline" id="logout">
                    @csrf
                    <a href="javascript:;" onclick="document.getElementById('logout').submit()"
                        class="text-dark text-decoration-none">退出</a>
                </form>
            @else
                {{-- 未登入显示的界面 --}}

                <a href="{{ route('login') }}" class="btn  btn-sm btn-primary">登入</a>
                <a href="{{ route('register') }}" class="btn  btn-sm btn-outline-success ml-2">注册</a>
            @endauth
        </div>
    </div>
</header>

```

`resources\views\index\index.blade.php`

```php
//... 
@foreach ($blogs as $blog)
                            <div class="article-body">
                                <div>
                                    {{-- 等以后讲到模型关联,将id 替换为对应的名称 --}}
                                    <span class="article-author">{{$blog->user_id}}</span>
                                    {{-- $blog->updated_at 是一个 carbon 对象,dd打印看出, 在packagist 中搜索carbon,就可以看到使用方法 --}}
                                    {{-- diffForHumans carbon 的时间格式化 --}}
                                    {{-- {{dd($blog->updated_at);}} --}}
                                    <span class="article-time">{{$blog->updated_at->diffForHumans()}}</span>
                                </div>
                                <h2 class="font-weight-bold my-3 article-title">
                                    {{-- <a class="text-dark" href="{{route('blog.show',['blog'=>1])}}">博客博客博客博客博客博客</a> --}}
                                    <a class="text-dark" href="{{route('blog.show',1)}}">{{$blog->title}}</a>
                                </h2>
                                <div class="article-des">{{$blog->content}}</div>
                                <div>
                                    {{-- 标签 --}}
                                    {{-- categories() 自定义辅助函数 app/helpers.php --}}
                                    <a href="#" class="badge badge-warning mt-3 article">{{getCategories()[$blog->category_id]}}</a>
                                </div>
                            </div>
                            <hr>
                        @endforeach
                        {{-- 系统默认的css 不是bootstrap ,这里显示的就会乱 --}}
                        {{-- 需要在 app/Providers/AppServiceProvider.php 中修改 --}}
                        {{-- {{$blogs->links()}} --}}
                        {{-- 附加参数到分页中 --}}
                        {{-- {{$blogs->appends(['sort'=>'votes'])->links()}} --}}
                        {{-- 追加搜索关键字 或使用 withQueryString --}}
                        {{-- {{$blogs->appends(['keyword'=>request()->query('keyword')])->links()}} --}}
                        {{$blogs->withQueryString()->links()}}
                        {{-- 附加全部查询参数 --}}
                        {{-- {{$blogs->withQueryString()->links()}} --}}
                        {{-- 两边显示多少个分页 --}}
                        {{-- {{$blogs->onEachSide(1)->links() }} --}}
                        {{-- <nav class="d-flex justify-content-center mt-4">
                            <ul class="pagination">
                                <li class="page-item disabled">
                                    <a href="#" class="page-link" tabindex="-1" aria-disabled="">上一页</a>
                                </li>
                                <li class="page-item">
                                    <a href="#" class="page-link">1</a>
                                </li>
                                <li class="page-item active" aria-current="page">
                                    <a href="#" class="page-link">
                                        2 
                                       
                                    </a>
                                </li>
                                <li class="page-item">
                                    <a href="#" class="page-link">3</a>
                                </li>
                                <li class="page-item">
                                    <a href="#" class="page-link">下一页</a>
                                </li>
                            </ul>
                        </nav> --}}
                    </div>
                </div>
            </div>
            <div class="col-sm-3 p-0">
                @include('common.right-card',[
                    'imgUrl'=>'https://www4.bing.com//th?id=OHR.SwedishAntenna_ZH-CN9163420082_1920x1080.jpg&rf=LaDigue_1920x1080.jpg&pid=hp&w=240&h=135',
                    'title'=>'博客网站',
                    'content'=>'一个用来学习Laravel 的博客项目,基于Bootstrap4.0 开发',
                    // 'count'=>$blogs->count()     //当前页的数量
                    'count'=>$blogs->total()     //总数量
                ])
            </div>
```



**接收关键字进行查询**

`app\Http\Controllers\IndexController.php`

```php
<?php

namespace App\Http\Controllers;

use App\Models\Blog;
use Illuminate\Http\Request;

class IndexController extends Controller
{
    /** 使用/** 热键 就会自动生成注释
     * 博客首页
     */
    public function Index(Request $request)
    {
        // dd('博客首页');

        // 搜索关键字
        // dd($request->all());
        // query  只获取get 的url参数,input 也可以
        // $request->keyword 也可以
        $keyword = $request->query('keyword');
        // dd($keyword);
        // 获取分类id
        $category_id = $request->query('category_id');


        // 查询博客数据
        // 查询已发布的数据
        // $blogs=Blog::where('status',1)->get();
        // dd($blogs);
        // 分页获取,paginate 默认15条
        // paginate 分页功能较多,simplePaginate 简单分页只有上一页和下一页
        // $blogs=Blog::where('status',1)->paginate();
        // 每页2条
        // 访问 http://localhost:8000/?page=1
        // 访问 http://localhost:8000/?page=2

        // when 当值存在的时候,执行闭包中的搜索,不存在则不执行闭包
        // use 使用外部的变量
        // function($query,$keyword) 也可以
        // $blogs = Blog:: when($keyword, function ($query) use ($keyword) {
        //         // 查询数据库中title 或content 字段
        //         $query->where('title', 'like', "%{$keyword}%");
        //             // ->orWhere('content', 'like', "%{$keyword}%");
        //     })
        //     ->when($category_id,function($query) use ($category_id){
        //           $query->where('category_id',$category_id);
        //     })
        //     ->when($keyword,function($query) use ($keyword){
        //           $query->where('content','like', "%{$keyword}%");
        //     })
       

        // $blogs = Blog:: when($keyword, function ($query) use ($keyword) {
        //         // 查询数据库中title 或content 字段
        //         $query->where('title', 'like', "%{$keyword}%");
        //             // ->orWhere('content', 'like', "%{$keyword}%");
        //     })
        //     ->when($category_id,function($query) use ($category_id){
        //           $query->where('category_id',$category_id);
        //     })
        //     ->when($keyword,function($query) use ($keyword){
        //           $query->where('content','like', "%{$keyword}%");
        //     })
        //     ->where('status', 1)
        //     ->orderBy('updated_at', 'desc')
        //     // ->paginate(2)
        //     ->dd(); //输出sql 语句,不能使用paginate 语句


         // 使用参数分组形式
        $blogs = Blog:: when($keyword, function ($query) use ($keyword) {
                // 查询数据库中title 或content 字段
                $query->where(function($query) use ($keyword){
                    // 这两个语句一起执行后的结果交给下一个语句产生结果
                    // 不使用高级语句,就会导致这三个语句一起执行产生一个结果,
                    // orWhere 产生或的行为
                    $query->where('title', 'like', "%{$keyword}%")
                    ->orWhere('content', 'like', "%{$keyword}%");
                });
                
            })
            ->when($category_id,function($query) use ($category_id){
                  $query->where('category_id',$category_id);
            })
            ->where('status', 1)
            ->orderBy('updated_at', 'desc')
            ->paginate(2);
        // 将数据转换为json
        // $blogs=Blog::where('status',1)->paginate(2)->toJson();
        // dd($blogs);
        return view('index.index', ['blogs' => $blogs]);
    }
}

```

