# 文件存储

参考手册  [文件存储 | 综合话题 |《Laravel 8 中文文档 8.x》| Laravel China 社区 (learnku.com)](https://learnku.com/docs/laravel/8.x/filesystem/9392) 



**掌握内容**

- 配置
- 获取磁盘实例
- 检索文件
- 下载文件
- 文件URLs
- 文件路径
- 自定义本地 URL 主机
- 文件元数据
- 文件数据写入
- 复制个移动文件
- 文件上传
- 删除文件



>  文件系统的配置文件位于 `config/filesystems.php` 



`项目/config/filesystems.php` 

```php
<?php

return [

    // 默认使用本地系统,使用 下面 'disks' 中的 local 磁盘
    'default' => env('FILESYSTEM_DRIVER', 'local'),

    'disks' => [

        'local' => [
            'driver' => 'local',
            // 存放到storage/app
            'root' => storage_path('app'),
        ],

        'public' => [
            'driver' => 'local',
            'root' => storage_path('app/public'),
            'url' => env('APP_URL').'/storage',
            'visibility' => 'public',
        ],

        's3' => [
            'driver' => 's3',
            'key' => env('AWS_ACCESS_KEY_ID'),
            'secret' => env('AWS_SECRET_ACCESS_KEY'),
            'region' => env('AWS_DEFAULT_REGION'),
            'bucket' => env('AWS_BUCKET'),
            'url' => env('AWS_URL'),
            'endpoint' => env('AWS_ENDPOINT'),
            'use_path_style_endpoint' => env('AWS_USE_PATH_STYLE_ENDPOINT', false),
        ],

    ],

    // 软连接
    'links' => [
        // 将public 下的storage 映射到storage 下的app/public
        // 因为安全,对外只开放public,外部不能访问storage,
         // 所以需要将访问到的 storage 映射到storage 下的app/public
        public_path('storage') => storage_path('app/public'),
    ],

];

```



**生成软连接**

```powershell
php artisan storage:link	#会在 `项目/config/filesystems.php`  下links 生成一个软连接  public_path('storage') => storage_path('app/public'), 在public 下也会生成一个指向storage 的软连接文件夹

D:\学习\wanye\PHP\Laravel 8.1 框架\项目\blog>php artisan storage:link
The [D:\学习\wanye\PHP\Laravel 8.1 框架\项目\blog\public\storage] link has been connected to [D:\学习\wanye\PHP\Laravel 8.1 框架\项目\blog\storage\app/public].
The links have been created.
```

**创建不成功**

> 权限不够,无法写入,使用管理员打开cmd 



**创建一个单函数控制器用于测试**

```
php artisan make:controller Test4Controller --invokable
```



`项目/routes/web.php`

```php
<?php
    
use App\Http\Controllers\Test4Controller;
use Illuminate\Support\Facades\Route;

Route::get('/test1',Test4Controller::class);
// Route::get('/test1/{id}',Test4Controller::class);
```



`项目/app/Http/Controllers/Test4Controller.php`

```php
<?php

namespace App\Http\Controllers;

use Illuminate\Http\File;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Storage;

class Test4Controller extends Controller
{

    public function __invoke(Request $request)
    {
        // 存储文件
        // 没有选择磁盘,存放到默认磁盘
        // 在 项目/storage/app/ 下生成file.txt
        // Storage::put('file.txt','内容');

        // disk 选择磁盘
        // 在 项目/storage/app/public 下生成file.txt
        // Storage::disk('public')->put('file.txt','内容');

        // 检索文件
        // $contents = Storage::get('file.txt');
        // dd($contents);  // 文件内容: "内容"

        //  判断磁盘上是否存在指定的文件：
        // $exists = Storage::disk('public')->exists('file.txt');
        // dd( $exists);   //true

        // 判断磁盘上是否缺少指定的文件：
        // $missing = Storage::disk('public')->missing('file.txt');
        // dd($missing);   //false


        // 文件urls
        // 如果磁盘中配置了url 地址,则使用完整url 路径, 'url' => env('APP_URL').'/storage',
        // 'url' => env('APP_URL').'/storage', 也称为自定义主机, env('APP_URL') 自定义自己的需要主机
        // 没有配置url 地址,则使用相对路径
        // $url=Storage::url('file.txt');
        // dd($url);   // 相对路径 "/storage/file.txt"
        // $url=Storage::disk('public')->url('file.txt');
        // dd($url);   // 完整路径 "http://localhost/storage/file.txt"

        // 文件路径
        // 本地返回绝对路径
        // 远程s3 磁盘返回远程磁盘的相对路径
        // $url=Storage::disk('public')->path('file.txt');
        // dd($url);  //"D:\学习\wanye\PHP\Laravel 8.1 框架\项目\blog\storage\app/public\file.txt"

        // 文件的元数据
        // $size = Storage::size('file.txt');
        // dd($size);      //6

        // 自动流式文件传输
        // 自动为文件名生成唯一 ID...
        // 参数 路径,文件
        // Storage::putFile('photos', new File(Storage::disk('public')->path('file.txt')));
        // 在 项目/storage/app/photos 下生成Gdg8bxJhQLL6Twm9r7YNBRrqXW1JINk5V3n7EBsr.txt

        // 手动指定文件名...
        // Storage::putFileAs('photos',new File(Storage::disk('public')->path('file.txt')), 'photo.txt');
        // 在 项目/storage/app/photos 下生成 photo.txt

        // 删除文件
        $re=Storage::delete('file.txt');
        dd($re);    //true
    }
}

```

