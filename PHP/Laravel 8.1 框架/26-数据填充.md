# 数据填充

参考手册  [数据填充 | 数据库 |《Laravel 8 中文文档 8.5》| Laravel China 社区 (learnku.com)](https://learnku.com/docs/laravel/8.5/seeding/10407) 

参考手册  [数据库测试 | 测试相关 |《Laravel 8 中文文档 8.5》| Laravel China 社区 (learnku.com)](https://learnku.com/docs/laravel/8.5/database-testing/10419#9bd10a) 

**掌握内容**

- 创建填充类
- 调用其他填充



## 简介

`Laravel `包含一个填充类可以为你的数据库填充测试数据。所有的填充类都放在` database/seeders` 目录下。通常， `Laravel `默认定义了一个 `DatabaseSeeder `类。通过这个类，你可以用 `call `方法来运行其他的 `seed `类，从而控制数据填充的顺序。



## 编写 Seeders

运行 `Artisan `命令 命令 `make:seeder `生成` Seeder`，框架生成的` Seeder` 都放在 `database/seeders` 目录下：

```powershell
php artisan make:seeder UserSeeder		#生成一个填充类,项目/database/seeders/UserSeeder.php

#Seeder created successfully.
```

`seeder `类只包含一个默认方法：`run`。这个方法会在执行` db:seed` 这个 Artisan 命令 时被调用。在 `run `方法里，你可以根据需要在数据库中插入数据。你也可以用 构造查询器 或 `Eloquent `模型工厂 来手动插入数据。

如下所示，在默认的 `DatabaseSeeder `类中的 `run `方法中添加一条数据插入语句：



` 项目/database/seeders/DatabaseSeeder.php`  和` 项目/database/seeders/UserSeeder.php`

```php
<?php

namespace Database\Seeders;

use Illuminate\Database\Seeder;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Hash;
use Illuminate\Support\Str;

class DatabaseSeeder extends Seeder
{
    /**
     * Seed the application's database.
     *
     * @return void
     */
    // 执行数据填充的时候不指明填充类时会执行此文件的run 方法
    public function run()
    {
        // \App\Models\User::factory(10)->create();

        // 添加用户测试数据
        DB::table('users')->insert([
            'name' => Str::random(10),      //随机用户名
            'email' => Str::random(10) . '@gmail.com',  //随机邮箱
            'password' => Hash::make('password'),
        ]);
    }
}

```



` 项目/database/seeders/DatabaseSeeder.php`

```php
<?php

namespace Database\Seeders;

use Illuminate\Database\Seeder;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Hash;
use Illuminate\Support\Str;

class DatabaseSeeder extends Seeder
{
    /**
     * Seed the application's database.
     *
     * @return void
     */
    // 执行数据填充的时候不指明填充类时会执行此文件的run 方法
    public function run()
    {
        // \App\Models\User::factory(10)->create();

        // 添加用户测试数据
        // DB::table('users')->insert([
        //     'name' => Str::random(10),      //随机用户名
        //     'email' => Str::random(10) . '@gmail.com',  //随机邮箱
        //     'password' => Hash::make('password'),
        // ]);


        // call 执行其他填充类,注意,有执行的先后顺序,最前的先执行
        $this->call([
            UserSeeder::class,
            // PostSeeder::class,
            // CommentSeeder::class,
        ]);
    
    }
}

```





## 运行 Seeders

您可以使用 `Artisan `命令 `db:seed` 来填充数据库。默认情况下，` db:seed` 命令将运行 `Database\Seeders\DatabaseSeeder` 类，这个类又可以调用其他 `seed `类。不过，您也可以使用 `--class `选项来指定一个特定的 `seeder `类：

```powershell
php artisan db:seed

php artisan db:seed --class=UserSeeder		#会运行指定类的run 方法
```

这时报 `avatar`字段不能为空的错误,需要修改以前的迁移文件,修改`up` 函数

`项目/database/migrations/2022_05_14_114022_add_avatar_to_users.php`

```php
 public function up()
    {
        Schema::table('users', function (Blueprint $table) {
            // 向表中的avatar 字段添加备注 用户头像,nullable 允许为空
            $table->string('avatar')->nullable()->comment('用户头像');
        });
    }
```



**执行迁移**

命令 `migrate:refresh` 首先会回滚已运行过的所有迁移，随后会执行 `migrate`。这一命令可以高效地重建你的整个数据库：

前面的测试创建的表会被清除掉

```powershell
php artisan migrate:fresh 
```



**在执行数据填充**

```powershell
php artisan db:seed

#Database seeding completed successfully.
```

查看数据库,填充了一条数据



您还可以使用` migrate:fresh` 命令结合` --seed `选项，这将删除数据库中所有表并重新运行所有迁移。此命令对于完全重建数据库非常有用：

```
php artisan migrate:fresh --seed
```



**在生产环境中强制运行填充**
一些填充操作可能会导致原有数据的更新或丢失。为了保护生产环境数据库的数据，在 生产环境 中运行填充命令前会进行确认。可以添加` --force` 选项来强制运行填充命令：

```
php artisan db:seed --force
```



## 模型工厂

参考手册  [数据库测试 | 测试相关 |《Laravel 8 中文文档 8.5》| Laravel China 社区 (learnku.com)](https://learnku.com/docs/laravel/8.5/database-testing/10419#9bd10a) 



模型工厂可以为此添加大量数据填充,模型工厂位置 `database/factories/UserFactory.php `

