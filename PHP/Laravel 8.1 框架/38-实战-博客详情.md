# 博客详情



**使用模型查询数据**

`app\Http\Controllers\Blogcontroller.php`

```php
<?php
namespace App\Http\Controllers;

use App\Http\Requests\BlogRequest;
use App\Models\Blog;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\DB;

//...

    /**
     * 查看一条博客的详情
     * 使用数据模型.根据传入的id 在数据表中进行查找id 对应的数据,返回给$blog
     */
    public function show(Blog $blog)
    {
        // dd('查看一条博客的详情'.$id);
        // 访问 http://localhost:8000/blog/14

         // 禁用模型维护 更新 字段
        // 因为每次view 字段的修改会导致模型的维护,修改创建/更新时间
        $blog->timestamps=false;
        $blog->increment('view');   //每次访问show,浏览量增加1
       
        $blog->timestamps=true;     //在开启,就可以使用diffForHumans
        // dd($blog->timestamps);
        // 关闭维护会导致创建/更新时间字段变成普通的字段,不具有carbon 的功能
        // 不能使用 diffForHumans() 函数
        return view('blog.show',['blog'=>$blog]);
    }

```



这里缺少 `观看次数` 字段,我们使用数据迁移创建字段

```php
php artisan make:migration add_view_to_blogs_table  --table=blogs
    
#Created Migration: 2022_05_17_144420_add_view_to_blogs_table
```

`database\migrations\2022_05_17_144420_add_view_to_blogs_table.php`

```php
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

class AddViewToBlogsTable extends Migration
{

    public function up()
    {
        Schema::table('blogs', function (Blueprint $table) {
            $table->integer('view')->default(0)->comment('浏览量');
        });
    }

    public function down()
    {
        Schema::table('blogs', function (Blueprint $table) {
        });
    }
}
```

**执行迁移**

```
php artisan migrate
```

`blogs`数据表生成`view`字段



**界面优化**

`resources\views\blog\show.blade.php`

```php
@extends('layouts.app')

@section('title', '博客详情')

@section('style')
    {{-- <link rel="stylesheet" href="{{ asset('css/markdown.css') }}"> --}}
    <style>
        .replay:last-child {
            border-bottom: none !important;
        }

    </style>
@endsection

@section('content')
    <div class="container mt-5">
        <div class="row ">
            <div class="col-sm-9">
                <div class="card">
                    <div class="card-body">
                        <h3 class="font-weight-light text-center mb-3">{{ $blog->title }}</h3>
                        <div class="text-center fs-14 text-muted">
                            <span class="mr-2">时间: {{ $blog->updated_at->diffForHumans() }}</span>
                            <span class="mr-2">浏览次数: {{ $blog->view }}</span>
                        </div>
                    </div>
                    <div class="content  p-0">
                        {{ $blog->content }}
                    </div>
                </div>
                @auth
                <div class="card mt-4">
                    <div class="card-body pb-9">
                        <form action="">
                            <div class="form-group">
                                <textarea name="" class="form-control" id="" cols="30" rows="10"></textarea>
                            </div>
                            <div class="text-right">
                                <button type="submit" class="btn btn-primary btn-sm py-1 px-4 ml-3">评论</button>
                            </div>
                        </form>
                    </div>
                </div>
            @else
                <div class="card mt-4">
                    <div class="card-body pb-2">
                        <div class="alert alert-warning" role="alert">
                            您还没有登入,请登入!
                            <a href="#" class="btn btn-primary btn-sm py-1 px-4 ml-3">
                                马上登入
                            </a>
                        </div>
                    </div>
                </div>
            @endauth
            </div>
            <div class="col-sm-3 p-0">
                @include('common.right-card', [
                    'imgUrl' =>
                        'https://www4.bing.com//th?id=OHR.SwedishAntenna_ZH-CN9163420082_1920x1080.jpg&rf=LaDigue_1920x1080.jpg&pid=hp&w=240&h=135',
                    'title' => $blog->category->name,
                    'content' => '收录了 ' . $blog->category->name . ' 相关的文章',
                    'count' => $blog->category->blogs()->count(), //blog 获取关联的category 模型的php 分类,category 获取与php 分类关联的blog 模型的count 数量
                    'category_id' => $blog->category_id,
                ])
            </div>
        </div>

    </div>
@endsection

```

`resources\views\common\right-card.blade.php`

```php
<style>
    .left-card>h5{
        font-size: 1.15rem !important;
        font-weight: 600;
    }
    .left-card>p{
        font-size: 14px;
        margin-top: 20px;
    }
    .left-card>button{
        color: #3273dc;
        border-color: #3273dc;
    }
    .left-card>button:hover{
        color: white;
        background: #3273dc;
    }
</style>
<div class="card">
    <img src="{{$imgUrl}}" class="card-img-top" alt="..." srcset="">
    <div class="card-body left-card">
        <h5 class="card-title text-center">{{$title}}</h5>
        <p class="card-text">{{$content}}</p>
        <hr>
        @if (isset($category_id)&&!empty($category_id))
            <a  href="{{route('index',['category_id'=>$category_id])}}" class="btn btn-outline-primary btn-sm w-100">文章数量{{$count}}</a>
        @else
        <button style="cursor: initial" class="btn btn-outline-primary btn-sm w-100">文章数量{{$count}}</button>
        @endif
    </div>
</div>
```



`blogs` 表要与`category` 关联,需要创建`category`的模型

**创建模型**

```powershell
php artisan make:model Category

#Model created successfully.
```



**模型关联**

`app\Models\Blog.php`

```php
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Model;

class Blog extends Model
{
    use HasFactory;

    /**
     * 
     * 允许批量添加的字段
     */
    protected $fillable=[
        'user_id',
        'title',
        'content',
        'category_id',
    ];

    /**
     * 
     * 博客所属的用户
     * 
     */
    public function user()
    {
        return $this->belongsTo(User::class,'user_id','id');
    }

    /**
     * 
     * 博客属于哪个分类
     * 与之关联
     * 
     */
    public function category()
    {
        // Category 与categories 也会关联,这是复数形式
        // blogs 表的category_id   categories 表的id
        // 在模板中使用,$blog->category->name   ,
        // 使用blog 获取动态属性category 模型获取其中的name 字段
        return $this->belongsTo(Category::class,'category_id','id');
    }
}

```

`app\Models\Category.php`

```php
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Model;

class Category extends Model
{
    use HasFactory;

        /**
     * 
     * 该分类拥有的所有博客
     * 与博客关联,就可以使用博客的数据
     * 
     */
    public function blogs()
    {
        // Category 与categories 也会关联,这是复数形式
        //  categories表的id    blogs 表的category_id
        // 在模板中使用,$categoryblog->blog->name   ,
        // 使用 category  获取动态属性blog  模型获取其中的name 字段
        return $this->belongsTo(Blog::class,'id','category_id');
    }
}

```

