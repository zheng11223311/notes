# 表单验证

参考手册  [表单验证 | 基础功能 |《Laravel 8 中文文档 8.x》| Laravel China 社区 (learnku.com)](https://learnku.com/docs/laravel/8.x/validation/9374) 

**掌握内容**

- 快速验证
- 自定义验证消息
- 表单请求验证
- 常用验证规则
- 自定义验证规则





这里的`post`验证,需要`csrf`验证,如果每次去测试路由,都要在`项目/app/Http/Kernel.php`中注释,

```php
\App\Http\Middleware\VerifyCsrfToken::class,    //开启csrf 安全机制
```

显得浪费时间,推荐在

`项目/app/Http/Middleware/VerifyCsrfToken.php`

```php
<?php

namespace App\Http\Middleware;

use Illuminate\Foundation\Http\Middleware\VerifyCsrfToken as Middleware;

class VerifyCsrfToken extends Middleware
{
    /**
     * The URIs that should be excluded from CSRF verification.
     *
     * @var array
     */
    // 排除路由,其可以不用进行csrf 验证
    protected $except = [
        '/test5'		//添加要排除的路由
    ];
}
```





`项目/app/Http/Controllers/UserComtroller.php`

添加验证器

```php
 /**
     * 个人中心-修改个人信息-更新数据
     */
    public function infoUpdate(Request $request)
    {
        // 表单验证器
        $validatedData = $request->validate([
            // name 字段,必须|最小4位 |最大32 位
            'name' => 'required|min:4|max:32',
            // email 字段,必须 | 邮件格式
            'email' => 'required|email',
        ],[
            // 自定义错误提示
            'name.required'=>'用户名必须填写',
            'name.min'=>'用户名最小4位数',
            'email.email'=>'邮箱必须位邮件格式'
        ]);
        // validateWithBag 会将错误信息放到$errors 中
        // 所以可以直接使用@include('common.error') 显示(此文件内包含$errors)
        
        // 验证通过执行下方代码
    
        // dd('个人中心-修改个人信息-更新数据');
        $name = $request->input('name');
        $email = $request->input('email');

        $errors = [];
        if (empty($name)) array_push($errors, '用户名不能为空!');
        if (empty($email)) array_push($errors, '邮箱不能为空!');
        if(!empty($errors)){
            return back()->withErrors($errors);
        }


        // dd($name,$email);
        // 更新数据
        // 不能这么操作,会更新整个表,需要指定id
        // $re=DB::update(['name'=>$name,'email'=>$email]);
        // dd($re);

        // 获取用户ID
        // 使用auth 辅助函数
        // 当前登入用户
        // $uid=auth()->user()->id;
        // 或
        $uid = auth()->id();
        // 使用门面函数
        // $uid=Auth::user()->id;
        // $uid=Auth::id;
        // dd($uid);

        // 更新数据,没有做任何修改提交不会更新,并返回0
        $re = DB::table('users')
            ->where('id', $uid)
            ->update(['name' => $name, 'email' => $email]);
        // dd($re);

        //使用模型更新
        // 是一个Model 类型
        // dd(auth()->user());
        // $user=auth()->user();
        // // 修改
        // $user->name=$name;
        // $user->email=$email;
        // // 执行更新,没有做任何修改提交也会更新,并返回1
        // $re=$user->save();

        // dd($re);
        if ($re) {
            return back()->with(['success' => '更新数据成功!']);
            // 在 项目/resources/views/user/info.blade.php 中使用
        } else {
            // 错误收集在common.error 里面
            // 闪存到session 并放到$error 中
            return back()->withErrors('数据未做更新操作!');
            // return back()->withErrors(['数据未做更新操作!']);
        }
    }
```



`项目/resources/views/user/info.blade.php`

```php
//部分关键代码,其他未变

 <div class="card-body">
                        @include('common.error')
                        @include('common.success')

                        <form method="post" action="{{ route('user.info.update') }}" class="col-md-6 offset-3">
                            {{-- csrf 认证 --}}
                            @csrf
                            {{-- 使用 put 提交数据 --}}
                            {{-- <input type="hidden" name="_method" value="PUT"> --}}
                            {{-- 或使用method() --}}
                            @method('put')
                            {{-- csrf 和method 都是生成input 为 hidden 的表单 --}}
                            <div class="form-group">
                                <label for="exampleInputName" class="fs-14 font-weight-bold">用户名</label>
                                <input type="text" name="name" class=" @error('name')is-invalid @enderror form-control form-control-sm" id="exampleInputName"
                                    value="{{ auth()->user()->name }}" aria-describedby="emailHelp" placeholder="请填写用户名" />
                                @error('name')
                                    {{-- 指定字段的错误验证提示 --}}
                                    {{-- 如果name 有错误的话,这里会显示 --}}
                                    {{-- invalid-feedback 类名是确定的,不能修改 --}}
                                    {{-- 关联的input 表单需要添加 is-invalid 类名,这个类名在input 中会显示错误提示符号--}}
                                    {{-- 使用 @error('name') is-invalid  @enderror 判定在错误的时候显示 --}}
                                   <div class="invalid-feedback">
                                       {{$message}}
                                   </div>
                                @enderror
                            </div>
                            <div class="form-group">
                                <label for="exampleInputEmail" class="fs-14 font-weight-bold">邮箱</label>
                                <input type="email" name="email" class="form-control form-control-sm" id="exampleInputEmail"
                                    value="{{ auth()->user()->email }}" aria-describedby="emailHelp" placeholder="请填写用户名" />
                            </div>
                            <button class="btn btn-primary w-25 offset-4">修改</button>
                        </form>
```



直接在上方控制器中使用表单验证器,如果验证字段越来越多,会显得代码臃肿,需要创建一个专门存放验证器的位置



**创建验证器**

```powershell
# 格式 php artisan make:request xxx	

php artisan make:request UserRequest		#创建一个验证用户表单 Userrequest 类

#Request created successfully.
```



第一次创建会在`项目/app/Http` 下创建一个`Requests` 文件夹,里面存放着验证器类的文件`UserRequest.php` 文件

`项目/app/Http/Requests/UserRequest.php`  

```php
<?php

namespace App\Http\Requests;

use Illuminate\Foundation\Http\FormRequest;

class UserRequest extends FormRequest
{

    public function authorize()
    {
        // 鉴定用户是否具有权限,比如更新评论的权限
        // 需要打开true,否则无法通过,返回419界面
        // 没有权限不能开启验证,打开才能开始验证
        // return false;
        return true;
    }


    // 书写规则
    // 自己定义的 UserRequest 继承FormRequest
    // 而FormRequest 继承Request
    // 所以在控制器中可以直接使用UserRequest 验证器
    // 包含继承的Request 所有方法
    public function rules()
    {
        // 书写规则
        return [
            // name 字段,必须|最小4位 |最大32 位
            'name' => 'required|min:4|max:32',
            // email 字段,必须 | 邮件格式
            'email' => 'required|email',
        ];
    }


    /**
     * 获取已定义验证规则的错误消息
     *
     * @return array
     */
    // 自定义错误提示消息
    public function messages()
    {
        return [
           // 自定义错误提示
            'name.required'=>'用户名必须填写',
            'name.min'=>'用户名最小4位数',
            'email.email'=>'邮箱必须位邮件格式'
        ];
    }
}

```





`项目/app/Http/Controllers/UserController.php` 使用验证器类

```php
/**
     * 个人中心-修改个人信息-更新数据
     */

     
    // public function infoUpdate(Request $request)
    // 使用验证器UserRequest 
    // 自己定义的 UserRequest 继承FormRequest
    // 而FormRequest 继承Request
    // 所以在控制器中可以直接使用UserRequest 验证器
    // 包含继承的Request 所有方法
    public function infoUpdate(UserRequest $request)
    {
        // 表单验证器
        // $validatedData = $request->validate([
        //     // name 字段,必须|最小4位 |最大32 位
        //     'name' => 'required|min:4|max:32',
        //     // email 字段,必须 | 邮件格式
        //     'email' => 'required|email',
        // ],[
        //     // 自定义错误提示
        //     'name.required'=>'用户名必须填写',
        //     'name.min'=>'用户名最小4位数',
        //     'email.email'=>'邮箱必须位邮件格式'
        // ]);
        // validateWithBag 会将错误信息放到$errors 中
        // 所以可以直接使用@include('common.error') 显示(此文件内包含$errors)

        // 验证通过执行下方代码
    
        // dd('个人中心-修改个人信息-更新数据');
        $name = $request->input('name');
        $email = $request->input('email');
		
         // 有验证器,不需要下面的验证
        // $errors = [];
        // if (empty($name)) array_push($errors, '用户名不能为空!');
        // if (empty($email)) array_push($errors, '邮箱不能为空!');
        // if(!empty($errors)){
        //     return back()->withErrors($errors);
       //  }


        // dd($name,$email);
        // 更新数据
        // 不能这么操作,会更新整个表,需要指定id
        // $re=DB::update(['name'=>$name,'email'=>$email]);
        // dd($re);

        // 获取用户ID
        // 使用auth 辅助函数
        // 当前登入用户
        // $uid=auth()->user()->id;
        // 或
        $uid = auth()->id();
        // 使用门面函数
        // $uid=Auth::user()->id;
        // $uid=Auth::id;
        // dd($uid);

        // 更新数据,没有做任何修改提交不会更新,并返回0
        $re = DB::table('users')
            ->where('id', $uid)
            ->update(['name' => $name, 'email' => $email]);
        // dd($re);

        //使用模型更新
        // 是一个Model 类型
        // dd(auth()->user());
        // $user=auth()->user();
        // // 修改
        // $user->name=$name;
        // $user->email=$email;
        // // 执行更新,没有做任何修改提交也会更新,并返回1
        // $re=$user->save();

        // dd($re);
        if ($re) {
            return back()->with(['success' => '更新数据成功!']);
            // 在 项目/resources/views/user/info.blade.php 中使用
        } else {
            // 错误收集在common.error 里面
            // 闪存到session 并放到$error 中
            return back()->withErrors('数据未做更新操作!');
            // return back()->withErrors(['数据未做更新操作!']);
        }
    }
```

