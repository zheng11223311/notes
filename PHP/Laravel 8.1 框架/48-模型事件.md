# 模型事件

参考手册  [快速入门 | Eloquent ORM |《Laravel 8 中文文档 8.x》| Laravel China 社区 (learnku.com)](https://learnku.com/docs/laravel/8.x/eloquent/9406#events) 



**掌握内容**

- 理解和使用事件



`Eloquent `模型触发几个事件，允许你挂接到模型生命周期的如下节点： `retrieved`、`creating`、`created`、`updating`、`updated`、`saving`、`saved`、`deleting`、`deleted`、`restoring`、`restored`、`replicating`。事件允许你每当特定模型保存或更新数据库时执行代码。每个事件通过其构造器接受模型实例。

`retrieved `事件在现有模型从数据库中查找数据时触发。当新模型每一次保存时，`creating `和 `created `事件被触发。如果数据库中已经存在模型并且调用了 `save `方法，`updating / updated `事件被触发。这些情况下，`saving / saved `事件也被触发。

注意：通过 `Eloquent `进行批量更新时，被更新模型的 `saved `和 `updated`, `deleting `和 `deleted `事件不会被触发。这是因为批量更新时，并没有真的获取模型。



### 模型中使用闭包

你可以注册在触发各种模型事件时执行的闭包，而不使用自定义事件类。 通常，你应该在模型的 `booted` 方法中注册这些闭包：

`app\Models\Blog.php`

```php
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Model;

class Blog extends Model
{
    use HasFactory;

    /**
     * 
     * 允许批量添加的字段
     */
    protected $fillable = [
        'user_id',
        'title',
        'content',
        'category_id',
    ];

    /**
     * 
     * 博客所属的用户
     * 
     */
    public function user()
    {
        return $this->belongsTo(User::class, 'user_id', 'id');
    }

    /**
     * 
     * 博客属于哪个分类
     * 与之关联
     * 
     */
    public function category()
    {
        // Category 与categories 也会关联,这是复数形式
        // blogs 表的category_id   categories 表的id
        // 在模板中使用,$blog->category->name   ,
        // 使用blog 获取动态属性category 模型获取其中的name 字段
        return $this->belongsTo(Category::class, 'category_id', 'id');
    }

    /**
     * 
     * 博客拥有的评论
     */
    public function comments()
    {
        // 一个bolg id关联(拥有)许多comment 评论id
        // Comment 表中的blog_id ,关联blog 表中的id
        return $this->hasMany(Comment::class, 'blog_id', 'id');
    }



    /**
     * 模型的 "booted" 方法
     *
     * @return void
     */
    protected static function booted()
    {
        // 模型监听删除事件
        //在 http://localhost:8000/user/blog 中删除一条博客
        static::deleted(function ($blog) {
            //写入日志
            info('您删除了博客'.$blog->title);
        });
    }
}

```



## 观察者

由于所有的都写在一个模型中,显得非常臃肿,将监听事件提取到一个文件中,即为观察者

**定义观察者**
如果在一个模型上监听了多个事件，可以使用观察者来将这些监听器组织到一个单独的类中。观察者类的方法名映射到你希望监听的 `Eloquent `事件。 这些方法都以模型作为其唯一参数。`make:observer` Artisan 命令可以快速建立新的观察者类：

```powershell
php artisan make:observer BlogObserver --model=Blog		#创建观察者 UserObserver 类 --model=Blog 指向的模型为Blog		
#Observer created successfully.
```

 此命令将在 `App/Observers` 文件夹放置新的观察者类。如果这个目录不存在，Artisan 将替你创建 

 要注册观察者，您需要在要观察的模型上调用 observe 方法。您可以在应用程序的 `App\Providers\EventServiceProvider `服务提供者的 `boot `方法中注册观察者：

`app\Providers\AppServiceProvider.php`

```php
<?php

namespace App\Providers;

use App\Models\Blog;
use App\Observers\BlogObserver;
use Illuminate\Pagination\Paginator;
use Illuminate\Support\Facades\Response;
use Illuminate\Support\ServiceProvider;

class AppServiceProvider extends ServiceProvider
{
    /**
     * Register any application services.
     *
     * @return void
     */
    public function register()
    {
        //
    }

    /**
     * Bootstrap any application services.
     *
     * @return void
     */
    public function boot()
    {
        //将分页视图默认样式修改为bootstrap
        Paginator::useBootstrap();

        // 修改分页的默认视图
        // Paginator::defaultView('vendor.pagination.my-page');
        // Paginator::defaultSimpleView('vendor.pagination.my-page');

        // // 在控制器中使用 response()->api($msg,$code,$data)
        // Response::macro('api', function ($msg='',$code=200,$data='') {
        //     $resData=[
        //         'code'=>$code,
        //         'msg'=>$msg,
        //         'time'=>time(),
        //         'data'=>$data
        //     ];
        //     return response()->json($resData);
        // });

        // 注册观察者
        Blog::observe(BlogObserver::class);

    }
}

```

只要在`App\Providers\`下的任何文件中的`boot` 中都可以注册,为了规范应用的场景,写在指定的文件中



`app\Observers\BlogObserver.php`

```php
<?php

namespace App\Observers;

use App\Models\Blog;

class BlogObserver
{
    
    public function created(Blog $blog)
    {
        //
    }

   
    public function updated(Blog $blog)
    {
        //
    }

   
    public function deleted(Blog $blog)
    {
        info('使用了观察者记录: 您删除了博客'.$blog->title);
    }

    
    public function restored(Blog $blog)
    {
        //
    }

   
    public function forceDeleted(Blog $blog)
    {
        //
    }
}

```

