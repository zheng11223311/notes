# 数据库模型

参考手册  [快速入门 | Eloquent ORM |《Laravel 8 中文文档 8.5》| Laravel China 社区 (learnku.com)](https://learnku.com/docs/laravel/8.5/eloquent/10409) 



**掌握内容**

- 模型定义
- 模型CURD





## 简介

`Laravel `包含了 `Eloquent`，这是一个对象关系映射器`（ORM）`，使与数据库的交互变得很愉快。使用 `Eloquent `时，每个数据库表都有一个对应的「模型」，用于与该表进行交互。除了从数据库表中检索记录外，`Eloquent `模型还允许您从表中插入，更新和删除记录。



## 生成模型类

首先，让我们创建一个 `Eloquent `模型。模型通常位于 `app\Models `目录中，并扩展 `Illuminate\Database\Eloquent\Model` 类。您可以使用` make:model` `Artisan command` 生成新模型：

```powershell
php artisan make:model Flight
```

如果想要在生成模型的同时生成 数据库迁移，可以使用 `--migration `或` -m` 选项。

```powershell
php artisan make:model Flight --migration	#建议 生成模型的同时生成 数据库迁移,而不是单独的生成模型,这里我们也使用这个创建模型
php artisan make:model Flight -m

#Model created successfully.
#Created Migration: 2022_05_16_152934_create_flights_table
#生成模型类,同时生成迁移类 
```

在生成模型的同时，你可能还想要各种其他类型的类，例如模型工厂、数据填充和控制器。这些选项可以组合在一起从而一次创建多个类：

```powershell
# 生成模型和 Flight工厂类...

php artisan make:model Flight --factory
php artisan make:model Flight -f

# 生成模型和 Flight 数据填充类...

php artisan make:model Flight --seed
php artisan make:model Flight -s

# 生成模型和 Flight 控制器类...

php artisan make:model Flight --controller
php artisan make:model Flight -c

# 生成模型和迁移(m)、工厂(f)、数据填充(s)、控制器(c)...

php artisan make:model Flight -mfsc
```



在 `database\migrations\2022_05_16_152934_create_flights_table.php` 下增加`name `字段

```php
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

class CreateFlightsTable extends Migration
{
    /**
     * Run the migrations.
     *
     * @return void
     */
    public function up()
    {
        Schema::create('flights', function (Blueprint $table) {
            $table->id();
            // 增加name 字段
            $table->string('name');
            $table->timestamps();
        });
    }

    /**
     * Reverse the migrations.
     *
     * @return void
     */
    public function down()
    {
        Schema::dropIfExists('flights');
    }
}

```

**执行数据迁移**

```powershell
php artisan migrate		

#Migrating: 2022_05_16_152934_create_flights_table
#Migrated:  2022_05_16_152934_create_flights_table (5.53ms)
```

数据库中创建出数据表`flights`

`app\Models\Flight.php`

```php
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Model;

class Flight extends Model
{
    // 默认使用类名的小写名称作为数据表的名称,即与之关联
    use HasFactory;
    /**
     * 该表将与模型关联。
     * 不使用默认类名作为数据表的关联,使用自定义的表与此模型类关联
     *
     * @var string
     */
    // protected $table = 'my_flights';


    /**
     * 与表关联的主键。
     * 模型有一个默认的主键列，该列为 id,你也可以使用自定义主键
     *
     * @var string
     */
    // protected $primaryKey = 'flight_id';


    /**
     * 指明模型的 ID 不是自增。
     *
     * @var bool
     */
    // public $incrementing = false;

    /**
     * 自动递增主键的「类型」
     * 如果你的主键不是一个整数，
     * 你需要将模型上受保护的 $keyType 属性设置为 string：
     *
     * @var string
     */
    // protected $keyType = 'string';



    // 默认情况下，Eloquent 预期你的数据表中存在
    //  created_at 和 updated_at 两个字段 。
    // 如果你不想让 Eloquent 自动管理这两个列，
    //  请将模型中的 $timestamps 属性设置为 false：
     /**
     * 是否主动维护时间戳
     *
     * @var bool
     */
    // public $timestamps = false;
	
    
      /**
     * 可批量赋值属性
     *为防止而恶意操作,批量添加需要在模型中设置允许批量添加的字段
     * @var array
     */
    protected $fillable = ['name'];		//允许批量操作的字段

}

```





## 创建一个单函数控制器用于测试

```powershell
php artisan make:controller Test6Controller --invokable

#Controller created successfully.
```



`项目/routes/web.php`

```php
<?php
    
use App\Http\Controllers\Test6Controller;
use Illuminate\Support\Facades\Route;

Route::get('/test5',Test6Controller::class);
// Route::get('/test5/{id}',Test6Controller::class);
```



`项目/app/Http/Controllers/Test6Controller.php`

```php
<?php

namespace App\Http\Controllers;

use App\Models\Flight;
use Illuminate\Http\Request;

class Test6Controller extends Controller
{
    
    public function __invoke(Request $request)
    {
        //增
        // 添加一条数据
        // $flight=new Flight();    //模型实例
        // $flight->name='aaa';
        // $res=$flight->save();    //执行插入数据
        // dd($flight,$res);
        // 批量添加数据
        // 为防止而恶意操作,批量添加create 需要在模型中设置允许批量添加的字段
        // Flight::create(['name'=>'dddd']);   //添加一条数据,会自动维护创建和修改字段的值,不能添加多条
        // 模型方法默认会自动维护创建和修改字段
        // Flight::insert([        //添加多条数据,不会自动维护创建和修改字段的值,不需要设置允许添加的字段
        //     ['name'=>'dddd'],
        //     ['name'=>'eeee'],
        // ]);   
        // fill 添加
        // $flight=new Flight();
        // $flight->fill(['name'=>'ffff']);
        // $flight->save();    
        // 复制
        $flight=Flight::find(6);
        // dd($flight); 
        $copy=$flight->replicate(); //复制一份给copy
        $copy->name='gggg';     //修改name
        $copy->save();      //执行保存数据,即插入一条数据

        

        // 删
        // $res=$flight=Flight::find(1);
        // $flight->delete();  //删除id 为1的数据
        // dd($res);
        // 删除多个
        $res=Flight::where('name','dddd')->delete();
        dd($res);       //返回影响的行数

        // 改
        // 使用模型更新
        // $flight=Flight::find(1);    //根据id 查询
        // $flight->name="aaaaaa";
        // $flight->save();    //执行修改
        // 批量更新
        // 将所有name 为aaaaaa 的值更新为bbbb
        // Flight::where('name','aaaaaa')
        // ->update(['name'=>'bbbb']);

        // // 获取原始属性值
        // $flight=Flight::find(1);
        // $flight->name='cccc';
        // // 没有进行save 之前,修改的值都是临时的,即还没有修改数据库
        // // getOriginal 获取之前保存在数据库中的数据
        // $res1=$flight->getOriginal('name');   //aaaaaa
        // // $res1=$flight->getOriginal();   //获取所有原始数据
        // dd($flight->name,$res1);  //cccc





        // 查

        // 使用模型,引入模型数据库
        // 模型可以使用前面所学查询构造器的所有数据库操作方法
        // all /get 查询所有,
        // Flight::all() ;
        // Flight::get() ;
        // Flight::where('name','aa')->first() ;
        // Flight::where('name','aa')->first() ;
        // Flight::firstWhere('name','aa') ;   //等同上方
        // Flight::find(1);    //查询1条

    }
}

```

