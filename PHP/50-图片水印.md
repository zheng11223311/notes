### 1.图片水印

```php
<?php

// 把水印图片扣到另一张图片
//1.打开已经存在的图片作画布
$img=imagecreatefromjpeg('./img/1.jpg');
$width=imagesx($img);
$height=imagesy($img);
//2.打开已经存在的水印图片(一般都是png 格式)
$waterImg=imagecreatefrompng('./img/3.png');
$w=imagesx($waterImg);
$h=imagesy($waterImg);
//3.进行拷贝    水印图像位置    水印图像背景位置
imagecopyresampled($img,$waterImg,0,0,0,10,$w,$h,$w,$h);
//4.告诉浏览器图片的相关信息
// 注释header 可以查看错误信息
header('Content-type:image/jpeg');
//5.输出图片到浏览器或者保存图片
imagejpeg($img);
//6.释放资源
imagedestroy($img);
imagedestroy($waterImg);
    
?>

```

![Snipaste_2021-10-22_18-18-56](D:\学习\wanye\PHP\img\Snipaste_2021-10-22_18-18-56.png)

### 2.函数水印图片的封装

```php
<?php
//1.文字水印
    //将文字写入到图片上
//2.图片水印
    //将图片复制到原图上
//3.水印的位置
// 将水印的效果拷贝到图片当中实现水印图片
// 判断用户是图片水印还是文字水印
    // 如果是图片水印 需要打开图片
    //如果是文字水印 写入文字
    
    //图片水印调用
    imgWate('./img/1.jpg','./img/1.png',0);
    //文字水印调用
    // imgWate('./img/1.jpg','',0,'./img','w_','学习园地');
function imgWate($imgSrc,$waterImg='',$pos=0,$path='./img',$pre='w_',$waterText='',$Textfont='5',$textColor='#ff0000'){
//1.打开原图
    //1.1 获取原图的后缀
    $suffix=ltrim(strrchr($imgSrc,'.'),'.');
    //1.2 判断jpg 改成jpeg
    if($suffix==='jpg'){
        $suffix='jpeg';
    }
    //1.3 组装变量函数
    $imgFunc=('imagecreatefrom'.$suffix);
    //1.4 调用打开
    $backImg=$imgFunc($imgSrc);
//2.获取原图的宽高
$width=imagesx($backImg);
$height=imagesy($backImg);



//3.判断是否是图片水印
if(!empty($waterImg)){
    //不是水印文字
    $isWaterImg=false;
    //打开水印图片
    //获取水印图片相关信息 制作 变量函数
    // 调用函数打开图片
    $w_suffix=ltrim(strrchr($waterImg,'.'),'.');
    if($w_suffix==='jpg'){
        $w_suffix='jpeg';
    }
    $wimgFunc=('imagecreatefrom'.$w_suffix);
    $wImg=$wimgFunc($waterImg);
    $w=imagesx($wImg);
    $h=imagesy($wImg);
    // 水印图片缩放
    if($w>($width- floor($width/3*2))){
        // 进行图片的缩放
        if($w<$h){
            $dh=$height-floor($height/3*2)-10;
            $dw=floor($h*$dh/$h);
        }else{
            $dw=$width-floor($width/3*2)-10;
            $dh=floor($w*$dw/$w);
        }
        
    }else{
        $dw=$w;
        $dh=$h;
    }
 //将缩放的图片拷贝到新图
 $newImg=imagecreatetruecolor($dw,$dh);
 //设置透明色
 imagesavealpha($newImg,true);
 $back=imagecolorallocatealpha($newImg,255,255,255,127);
 imagefill($newImg,0,0,$back);
 imagecopyresampled($newImg,$wImg,0,0,0,0,$dw,$dh,$w,$h);




}elseif(!empty($waterText)){
    $isWaterImg=true;
    $dw=0;
    $dh=0;
    //文字水印
    //4.如果是文字水印 需要将文字的内容写入到图片当中

}
   //水印位置的判断 九宫格的位置
   switch ($pos) {
    case 1:
        $x=0;
        $y=0;
        break;
    case 2:
        $x=$width/3;
        $y=0;
        break;
    case 3:
        $x=$width/3*2;
        $y=0;
        break;
    case 4:
        $x=0;
        $y=$height/3*2;
        break;
    case 5:
        $x=$width/3;
        $y=$height/3;
        break;
    case 6:
        $x=$width/3*2;
        $y=$height/3;
        break;
    case 7:
        $x=0;
        $y=$height-$dh-10;
        break;
    case 8:
        $x=$width/3;
        $y=$height-$dh-10;
        break;
    case 9:
        $x=$width/3*2;
        $y=$height-$dh-10;
        break;
    
    default:
        $x=mt_rand(0,$width- $dw-10);
        $y=mt_rand(0,$height- $dh-10);
        break;
}
//拷贝到图片中(图片水印,还是文字水印)
//水印图像位置    水印图像背景位置
// imagecopyresampled($backImg,$wImg,$x,$y,0,0,$dw,$dh,$dw,$dh);

if(!$isWaterImg){
imagecopyresampled($backImg,$wImg,$x,$y,0,0,$dw,$dh,$w,$h);

}else{
    //文字水印
    // $red=imagecolorallocate($backImg,255,0,0);
    // hexdec十六进制转换为十进制 substr 截取位置,长度
    $r=hexdec(substr($textColor,1,2));
    $g=hexdec(substr($textColor,3,2));
    $b=hexdec(substr($textColor,5));
    $rgb=imagecolorallocate($backImg,$r,$g,$b);
    //不支持中文
    // imagestring($backImg,$Textfont,$x,$y,$waterText,$red); 
    // 14px 0 清洁度 xy 轴 颜色 字体(绝对路径) 文字
    imagefttext($backImg,14,0,$x,$y,$rgb,'C:\wamp64\www\php\fontFamily\STCAIYUN.TTF',$waterText);

}




//4.告诉浏览器图片的相关信息
// 注释header 可以查看错误信息
// header('Content-type:image/jpeg');
// //5.输出图片到浏览器或者保存图片
// imagejpeg($backImg);

//判断是否存在目录
if(!file_exists($path)){
    mkdir($path);
}
$newPath=rtrim($path,'/').'/'.$pre.basename($imgSrc);
$image='image'.$suffix;
$result=$image($backImg,$newPath);
//6.释放资源
imagedestroy($backImg);
if(!empty($waterImg)){
    imagedestroy($wImg);
imagedestroy($newImg);
}

    return $result;
}



?>

```

