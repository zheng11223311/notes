### 1.WPE 工具原理与功能使用

1. 我们看到的所有东西,在计算机真正运行的时候都要转成二进制机器码才能被计算机识别,计算机只认0和1
2. 电子计算机只认0和1,因为还有些计算机不是电子计算机,不采用二进制计算机,光子计算机,量子计算机
3. WPE 抓包都是16 进制的,商城卖东西的数量能根计算机算出来的一样就没加密,无规律就是加密了
4. 为什么溢出的时候是 7F FF FF FF,FF FF FF FF,有些游戏名称:正数最大值7F FF FF FF,负数最大值80 00 00 00,最小值FF FF FF FF=-1

## 2.协议安全(swf 安全):自动封包

> 页游,最最核心的就是客户端(swf) 与服务器端的游戏通信了,游戏通信产生的封包,内容是否可识别,可篡改,可重放,处理逻辑是否有漏洞,都决定了这款游戏是否有重大的漏洞

> 我们知道页游前端和后台的通信一般有两种方式,一种是http 连接,一种是socket 连接,前者适用于小型页游,例如内嵌在QQ 平台的QQ农场,后者适用于大型页游

> 不同的通信方式,产生的数据包格式也不一样,像HTTP AMF 的可以使用**charles 来抓包**查看,像sockets 的可以使用**WPE 抓包查看**

> 以socket 通信为例,协议采用自定义格,一般由两部分组成,包头与包体,包头一般是固定长度,包体为可变长度,包头一般是一些基本信息,例如包长度,版本号,命令号,用户ID,序列号等:包体就是操作命令对应的接收参数,参数个数不同,参数类型不同会导致包体长度不同

> 只要摸清楚协议算法,即包包是如何产生的,就可以构造数据包与服务器自由通话,这一后果是非常严重的,自由通话意味着你不需要老老实实的在客户端操作,一条数据包就能代替你一连串的操作,例如发送一条数据包完成一个任务,常用于快速升级,淘宝上的页游代练绝大多都是采用的这种方式;自由通话更意味着你可以绕过客户端的逻辑判断,传任意参数给服务端,说到这里,你可能觉得只要服务端能正常处理来自客户端的参数,不出逻辑错误,不错配置错误,就万事大吉,这种想法很常见,例如上海宝公司的某个开发就说过,我们的游戏逻辑判断都在服务端,我们没有外挂,我推测这个人应该不怎么上外网

> 理想是丰满的,现实是骨感的,怎么保证后台不将逻辑写错,策划运营不将配置弄错呢,特别是在高强度的通宵加班后,你说靠测试啊,中国页游行业,配给给游戏的测试人员是非常少的,相应的测试时间也是远远不够的,并且测试技术也非常需要提高,总的来说,在页游行业,能做完整协议测试的公司不多,但玩家,特别是从事外挂制作代练服务的工作室会"帮你"好好的彻底做协议测试,他们会先反编译客户端上的SWF 文件(缓存中,内存中) 的到协议生成算法,制作成封包工具,遍历每个协议,每个参数输入,让你的错误无从遁形

### 3.socket 是什么呢?

Socket 是应用层与TCP/IP 协议族通信的中间软件抽象层,他是一组接口,在设计模式中,Socket 其实就是一个门面模式,他把复杂的TCP/IP 协议族隐藏在Socket 接口后面,对用户来说,一组简单的接口就是全部,让Socket 去组织数据,以符合指定的协议

### 4.WPE 工作原理和可行性分析

WPE 所要改的,不是[游戏里面的数值],而是[伪造信息封包],什么意思呢?就是我们用WPE 所有改的,并不是"生命力由100 变成10000 之类的东西,这种东西无法用WPE 改,我们要改的可能是把"我卖了一个500 元的东西" 改成我卖了一个50000 元的东西" 或者"我得了10 得exp" 改成"我得了10000 得exp "之类得,或者是明明身上没东西还一直卖"500 元得东西"或没怪物"还一直打10 的exp"

因为WPE 是一个封包截取软件,他能截取网络上的数据封包,<<传奇>> 采用Client/server 模式.我们的信息全在服务器上面,想从服务器上面修改我们的个人用户信息,可能性微乎其微,客户端安装在你的机器上,玩游戏的时候,你发出指令,其实就是向服务器发送封包,服务器接收到封包后进行分析,然后返回结果,结果也是以封包的形式发送到你的机器上,你的机器收到后就可以看到结果了

这就给我们修改造成了机会,如果我们把封包里的数据改了会在怎么样呢?比如,我发出一个小火球,截取到代码,然后改成闪电的代码,那么我在机器上的效果应该就是闪电的效果了(已经试验过,可行),这种方法理论上是可行的,可是为什么有时实现不了呢?因为服务器还有应对措施,对一些重要的数据往往需要检测多项,我们修改的时候只是修改了其中的一项,是不行的,而且往往数据包是加密传输的,这也给我们找正确数据制造了麻烦

但是服务器的检测工作是有限度的,因此不可能全部都由服务器完成的,很多耗时资源的监测都放到了客户端上,早期的免蜡,半月,穿人,都是在本机上进行了监测,服务端并没有相应的监测机制,只有最近的更新才加入了一些监测,但也造成了整个服务器端的狂慢,所以对一些服务器并没有监测的东西我们还是可以修改的,当然这需要大家一起探索

**一点技术提示:**

传奇 的c/s 通信采用了字节流套接字,这种通信可靠,双向,顺序,因此,在封包只要按照原来的顺序就可以了,游戏采用了32 位加密(crc/32) ,故我们不能随便篡改其中的信息,否则在服务器检验时,发现出错,就会断开服务器连接,故采用李代桃僵之法更有效,身份认证信息的篡改当然没问题了(同一台机器,同一台用户)我们发送的数据含有坐标码,改包时不要改坐标哦

### 5.WPE 主要功能

1. WPE 重发
2. WPE 递进(递增/减数据,并自动重发)
3. WPE 滤镜
4. WPE 高级滤镜
5. WPE 拦截
6. WPE 拦截手机封包,使用随身wifi,手机连接过去,WPE 指向这个进行

### 6.WPE 相关问题

1. 为什么我用WPE 截不到数据包?

   1. 网络游戏99% 是TCP 协议,相关的API 是send, recv ,WSASend ,WSARecv ,如果客户端对这些API 的地址进行监测和设防,WPE 就会被发现而无效

2. 为什么我用WPE 会被杀毒软件报毒?

   1. WPE 的工作原理是修改ws2_32.dll 的send , recv ,WSASend ,WSARecv , 等函数的入口 以实现截包,本身属于木马行为,被误报很正常

3. 为什么我用WPE 一发包就会游戏断掉?

   1. 现在大多数网游的数据包是加密的,这些加密解密定义在应用层,并且有很多自校验,当服务器发现某一个数据包解密错误或是自校验错误,便立即断开与客户端的连接,在摸清应用层的加密前,用WPE 发包99% 是徒劳的

   