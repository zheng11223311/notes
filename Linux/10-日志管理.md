# 日志管理

## 一.简介

### 任务一:rsyslog 系统日志管理

**关心问题:**

那类程序 ---> 产生的说明日志 --->放到什么地方

### 任务二: logrotate 日志轮转

将大量的日志,分割管理,删除旧日志

## 二.任务一详解

### 1.处理日志的进程

#### 1.第一类

rsyslog: 系统专职日志程序

处理绝大部分日志记录

系统操作有关的信息,如登入信息,程序启动关闭信息,错误信息

#### 2.第二类

httpd/nginx/mysql: 各类应用程序,可以以自己的方式记录日志,讲解对应程序时会逐步介绍

#### 3.观察rsyslogd 程序

```shell
px aux |grep rsyslogd		#d 为deamon 守护进程,rsyslog 的守护进程
```

### 2.常见的日志文件(系统,进程,应用程序)

```shell
tail -10 /var/log/messages		#系统主日志文件
tail -f	/var/log/messages		#动态查看日志文件的尾部
tailf	/var/log/messages		#动态查看日志文件的尾部
#日志格式      
#时间 主机名: 消息

tailf /var/log/secure 			#认证,安全

tail /var/log/yum.log			#yum

tail /var/log/maillog			#根邮件postfix 相关

tail /var/log/cron				#crond,at 进程产生的日志

tail /var/log/dmesg				#和系统启动相关
```

#### 1.了解

```shell
tail -10 /var/log/audit/audit.log		#系统审计日志

tail -f	/var/log/mysqld.log		#动态查看MySQl 日志文件的尾部

tailf /var/log/xferlog 			#和访问FTP 服务器相关

tail /var/log/wtmp			#当前登入的用户(命令:w,w 指令即who 指令)

tail /var/log/btmp			#最近登入的用户(命令 last)

tail /var/log/lastlog				#所有用户的登入情况(命令 lastlog)


#命令行输入w
w
#USER     TTY      FROM             LOGIN@   IDLE   JCPU   PCPU WHAT
#root     tty3     tty3             143月22 16days 58.63s  0.08s /usr/libexec/tra
#TTY 为 :数字 表示图形化界面  tty3 或 pts/数字 表示终端
```

### 3.rsyslogd 配置

#### 1.相关程序

```shell
yum install rsyslog logrotate 		#安装程序,默认已经安装
```

#### 2.启动程序

```shell
systemctl start rsyslog.service
```

#### 3.相关文件

```shell
rpm -qc rsyslog		#观察日志程序的配置文件 ,rpm 查看软件包的安装情况, qacl   a all 所有软件包,l list 列出与rsyslog 产生的相关文件,c  config 查看配置文件

#man 查询手册指令 与help 帮助文档
man rpm
rpm --help

```

**/etc/rsyslog.conf**

> rsyslogd 的主配置文件(关键)
>
> 软件的主配置文件:/etc/软件名.conf

**/etc/sysconfig/rsyslog**

> rsyslog 相关文件,定义级别(了解一下)

**/etc/logrotate.d/rsyslog**

> 和日志轮转(切割)相关(任务二)

### 4.主配置文件

告诉rsyslogd 进程什么日志,应该存到哪里

```shell
vim /etc/rsyslog.conf
#查找到46 行的 # RULES 
# RULES,即规则,是一套生成日志,以及存储日志的策略
#规则由设备+级别+存放位置组成
#RULES 由FACILITY +LEVEL+FILE 组成
#配置日志文件所在路径
# cron.*    	/var/log/cron	#设备    .* 任意级别(debug,error,inform,emery)  	日志所在路径
#*.emerg		:omusr'msg:*	# 紧急日志    存放在独立位置
#mail.*     	-/var/log/maillog		# -表示使用异步的方式记录,因为日志一般会比较大
#*.info;mail.none;authrpiv.none;cron.none	/var/log/messages	#系统日志排除了邮件,认证,计划日志

#根据规则可添加自定义配置

#修改配置文件后,需要重新加载配置文件
ps aux |grep rsyslog
kill -1 rsyslog 的pid		# -1 程序不关闭重新加载配置
```

#### 1.FACILITY &LEVEL

##### 1.facility 设备

**facility**

**设备类型**

- LOG_SYSLOG
  - syslog 自身产生的日志
- LOG_AUTHPRIV
  - 安全认证
- LOG_CRON
  - 调度程序(cron and at)
- LOG_MAIL
  - 系统邮件mail subsystem
- LOG_USER(default)
  - 用户相关
- LOG_DAEMOD
  - 后台进程
- LOG_FTP
  - 文件服务器 ftp deamon
- LOG_KERN
  - 内核设备kernel messages
- LOG_LPR
  - 打印机
  - printer subststem
- LOG_LOCAL0 through LOG_LOCAL7
  - 用户自定义设备



**程序类型示例**

关于程序和设备的联系问题,程序自身会决定将日志交给哪类安全类设备.这一点由开发者定义

```shell
grep Facility /etc/ssh/sshd_config 
#Syslog Facility AUTH
#Syslog Facility AUTHPRIV		AUTHPRIV 安全认证设备
```

##### 2.level 级别

- LOG_EMERG		紧急,致命,服务器无法继续运行,如配置文件丢失
- LOG_ALERT         报警,需要立即处理,如磁盘空使用95%
- LOG_CRIT             致命行为
- LOG_ERR               错误行为
- LOG_WARNING         警告信息
- LOG_NOTICE          普通,重要的标准信息
- LOG_INFO                标准信息
- LOG_DEBUG             调试信息,排错所需,一般不建议使用

## 三.任务二详解

### 1.logrotate 日志轮转

#### 1.简介

日志 记录了程序运行时各种信息

通过日志可以分析用户行为,记录运行轨迹,查找程序问题

可惜磁盘的空间时有限的

日志轮转就像飞机里的黑匣子,记录的信息再重要也只能记录最后一段时间发生的事

为了节省空间和整理方便,日志文件经常需要按!时间或!大小等维度分成多少份,删除时间久远的日志文件

#### 2.工作原理

##### 1.按照配置进行轮转

**配置文件种类**

主文件: /etc/logrotate.conf (决定每个日志文件如何轮转)

子文件夹: /etc/logrotate.d/*

子配置文件目录以.d 结尾,子文件是空的,我们可以在里面自定义配置

子配置文件的配置也可以写在主配置文件,子配置的优点是不需要时可以很快找到文件并删除

**观察主文件和子文件**

```shell
ls /etc/logrotate.conf  /etc/logrotate.d/

#/etc/logrotate.conf

#/etc/logrotate.d/:
#bootlog  dnf            numad   subscription-manager  wtmp
#btmp     iscsiuiolog    psacct  syslog
#chrony   libvirtd       samba   up2date
#cups     libvirtd.qemu  sssd    wpa_supplicant

```

#### 3.主配置文件介绍

主配置文件是程序启动必须运行的文件,通常主配置文件会包含子配置文件,即会导入子配置文件的配置信息

```shell
vim /etc/logrotate.conf
#显示
# =====全局设置=========
weekly 			#轮转的周期,一周轮转,一周切一次
rotate 4		#保留4 份,保留最近的4份数据
create			#轮转后创建新文件,  比如,创建*.log 文件
dataext			#使用日期作为后缀,将*.log 使用mv 修改成*.log-20221010 文件,create 会创建新的*.log 文件
#compress		#是否压缩,轮转之后再压缩,此# 代表注释,表示关闭此功能,因为压缩比较消耗系统资源,如果cpu 性能比较好,可以开启以节约空间
include /etc/logrotate.d		#包含该目录下的子配置文件

#当前登入的用户日志
#在配置文件中,书写日志的名字和大括号.就可以独立的设定该日志的轮转规则
/var/log/wtmp{			#对某日志文件设置轮转的方法
	monthly				#一个月轮转一次,days 一天
	minsize 1M			#最小达到1M 才轮转,monthly and minsize,达到1M 才进行切割,满足到时间和到大小才切割
	create 0664 root utmp	#轮转后创建新文件,并设置权限,root 属主 utmp 属组
	rotate 1			#保留一份
}


/var/log/btmp{
	missingok			#丢失不提示
	monthly				#每月轮转一次
	create 0600 root utmp	#轮转后创建新的文件,并设置权限
	rotate 1			#保留一份
}
```

#### 4.yum 日志轮转示例

##### 1.轮转的目标文件 /var/log/yum.log

##### 2.配置轮转规则

```shell
vim /etc/logrotate.d/yum

#添加
/var/log/yum.log{
	missingok			#丢失不提示
	yearly				#每年轮转一次
	#notifempty			#空文件不轮转,关闭此功能,因为我们要的是效果,不是里面有几行字
	maxsize 30k			#最大30k 就轮转,没到时间也轮转
	create 0600 root root	#轮转后创建新的文件,并设置权限,root 属主 root 属组
	rotate 1			#保留一份
}
```

##### 3.测试

###### 1.错误示范

```shell
/usr/sbin/logrotate   /etc/logrotate.conf 		#手动轮转,/usr/sbin/logrotate 调用logrotate 工具按照/etc/logrotate.conf 规则轮转日志

#查看文件
ls /var/log/yum*		#文件只有一个，因为日期没有变
```

###### 2.正确示范

```shell
#修改时间，手动触发轮转
date 04011000	#data 月日时分,每个两位数
/usr/sbin/logrotate -s /var/lib/logrotate.status   /etc/logrotate.conf 		# -s 时间戳,参照  /var/lib/logrotate.status 的记录,按照  /etc/logrotate.conf 的规则

ls /var/log/yum*		#日志文件出现多个,每次轮转之后修改时间,模拟日期变化
```

###### 3.关于时间

```shell
grep 'yum' /var/lib/logrotate/logrotate.status		#记录所有日志文件最近轮转的时间
```

